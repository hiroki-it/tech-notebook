---
title: 【IT技術の知見】L4＠OSI参照モデル
description: L4＠OSI参照モデルの知見を記録しています。
---

# `L4`＠OSI参照モデル

## はじめに

本サイトにつきまして、以下をご認識のほど宜しくお願いいたします。

> - https://hiroki-it.github.io/tech-notebook/

<br>

## 01. トランスポート層 (`L4`)

### トランスポート層とは

アプリケーション層のプロトコルを適切なアプリケーションに振り分けるプロトコル (例：TCP、UDPなど) を処理する層である。

> - https://ja.wikipedia.org/wiki/%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E5%B1%A4

<br>

### トランスポート層の仕組み

#### ▼ 全体像

クライアントからのリクエスト時に、ネットワーク層から渡されたパケットのポート番号情報を元に、アプリケーション層の特定のプロセスにパケットを渡す。

また反対に、レスポンス時にアプリケーション層のプロセスから出力されたパケットに情報を付加し、ネットワーク層に渡す。

この時、各アプリケーションはプロセスとして稼働していることに留意する。

![トランスポート層からアプリケーション層へのパケットの移動](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/トランスポート層からアプリケーション層へのパケットの移動.PNG)

#### ▼ クライアントからのリクエスト時 (図の 『➡️』 )

`(1)`

: ネットワーク層でプライベートIPアドレスを使用して、リクエスト先のパソコンを識別する。

`(2)`

: トランスポート層で、ポート番号を元にして、アプリケーション層のプロセスにパケットを送信する。

**＊例＊**

インバウンド通信を待ち受けるポート番号を`8080`と設定した場合、リクエスト時に以下の様にポート番号を指定すると、`nginx`プロセスにリクエストを送信できる。

```yaml
GET http://127.0.0.1:8080
```

#### ▼ クライアントへのレスポンス時 (図の 『⬅︎』 )

`(1)`

: パケットの通過したポート番号をヘッダー情報として追加する。

`(2)`

: ネットワーク層へ送信する。

<br>

## 02. リクエスト／レスポンスのプロトコル

### TCP

記入中...

<br>

### UDP

記入中...

<br>

### 独自プロコトル

#### ▼ DBコネクション系

`L7`のプロトコルに属する独自プロトコルもある (例：MySQLなど) 。

- Redis

> - https://designvault.medium.com/understanding-database-protocols-how-databases-communicate-c1ab61e21a40

<br>

## 04. ソケット

### ソケットとは

トランスポート層に存在し、受信した通信をアプリケーション層の各プロセスに振り分ける受け口をソケットという。

送信元のサーバーが宛先に対して、『`192.168.1.1:50001` (送信元IPアドレス:送信ポート) 』『`10.0.0.1:80` (宛先IPアドレス:宛先ポート) 』といったように、IPアドレスとポート番号の組合せで指定する。

<br>

### ソケット接続とは

ソケット間のネットワーク接続をソケット接続という。

<br>

### Unixドメインソケット

#### ▼ Unixドメインソケットとは

Unixで使用されるソケットのこと。

ソケットファイルを経由して、同じOS上のプロセス間でパケットを送受信する。

![unix-domain-socket](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/unix-domain-socket.png)

> - https://en.wikipedia.org/wiki/Unix_domain_socket
> - https://ascii.jp/elem/000/001/415/1415088/
> - https://blog.bnikka.com/server/unix-socket.html

#### ▼ 通信方法

プロトコルを『`unix:`』としてパケットを送受信する。

```bash
unix://./etc/foo.sock
```

ソケットファイル (`.sock`ファイル) 自体にファイルとしての実体はなく、エンドポイントのように働く。

同じOS上で稼働するコンテナのプロセス間の通信でも使用できる。

> - https://www.miketheman.net/2021/12/28/container-to-container-communication/

<br>

## 05. プロセス間メッセージキュー

### プロセス間メッセージキュー

同じOS上のプロセス間でメッセージを仲介する。

異なるOS間のメッセージを仲介する時は、ミドルウェアとしてのメッセージキューを経由する。

> - https://en.wikipedia.org/wiki/Message_queue

<br>

### posixメッセージキュー

記入中...

<br>

## 06. `L4`ロードバランサー

### `L4`ロードバランサーとは

通信の`L4`プロトコル (例：UDP、TCP) やツール固有のプロトコル (例：MySQL、Memcachedなど) のヘッダー情報に基づいて、通信をロードバランシングする。

`L7`プロトコルのヘッダー情報をもつ通信であっても、`L4`プロトコルの情報のみを使用してロードバランシングすることもできる (例えば、HTTPプロトコルのバージョンの影響を回避できるといったメリットがある) 。

`L7`プロトコル (例：HTTP、HTTPS、SMTP、DNS、POP3など) のヘッダー情報を失うわけではなく、あくまでパケットの`L4`ヘッダー情報をロードバランシングに使用するだけである。

そのため、HTTPSで受信したリクエストをロードバランシングする時は、決して通信が平文になっているわけではなく、`L7`のペイロードは暗号化されたままである。

`L4`プロトコルは、ヘッダーに宛先の情報 (例：IPアドレス、ポート番号) をもっている。

`L4`ロードバランサーは、これらの情報に基づいて通信を待ち受けるサーバーに、通信をロードバランシングする。

> - https://medium.com/@crazy_nuclei/l4-vs-l7-load-balancers-64e47610e2ef
> - https://www.infraexpert.com/study/tcpip8.html
> - https://hakobe932.hatenablog.com/entry/2018/04/11/123000
> - https://asnokaze.hatenablog.com/entry/20150421/1429621022

<br>
