---
title: 【知見を記録するサイト】OSI参照モデル/TCP階層モデル＠ネットワーク
---

# OSI参照モデル/TCP階層モデル

## はじめに

本サイトにつきまして，以下をご認識のほど宜しくお願いいたします．

参考：https://hiroki-it.github.io/tech-notebook-mkdocs/about.html

<br>

## 01. OSI参照モデルとTCP階層モデル

### データがパケットになるまで

1. アプリケーション層でデータが作成される．
2. トランスポート層でTCPヘッダが追加される．
3. インターネット層でIPヘッダが追加される．
4. ネットワークインターフェース層でEthernetヘッダが追加される．
5. パケットとして送信される．

![パケットの構造](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/パケットの構造.jpg)

<br>

### OSI参照モデル

#### ・OSI参照モデルとは

コンピュータのソフトウェアとハードウェアによる通信機能を，７つのレイヤーに分割したもの．

参考：https://www.infraexpert.com/study/networking3.html

#### ・各レイヤーの責務

![OSI参照モデル](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/OSI参照モデル.png)

<br>

### TCP階層モデル

#### ・TCP階層モデルとは

コンピュータのソフトウェアとハードウェアによる通信機能を，５つのレイヤーに分割したもの．TCP/IPモデルで用いられるプロトコルのうち，最も代表的な『TCP』と『IP』から名前をとって『TCP/IP』と名付けられた．

#### ・各レイヤーの責務

各レイヤーで異なるプロトコルを扱う．プロトコルとしての暗号化技術である『セキュアプロトコル』は，赤色で示してある．レイヤー名からとって，プロトコルを『アプリケーションプロトコル』『トランスポートプロトコル』『インターネットプロトコル』『ネットワークインターフェースプロトコル』ともいう．

参考：https://www.techwalla.com/articles/host-based-networks-vs-client-server-networks

![セキュアプロトコル](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/セキュアプロトコル.png)

<br>

## 02-02. 通信機器におけるヘッダ情報認識

### 各概念層と通信機器の間の対応関係

1. プライベートネットワークにクライアントPCがある．
2. クライアントPCにて，WebブラウザのアプリケーションのプロセスがTCPアプリケーション層（OSIアプリケーション層＋プレゼンテーション層＋セッション層）で稼働している．ここで，パケットが作成される．
3. パケットは，クライアントPCのTCPトランスポート層（OSIトランスポート層），TCPインターネット層（OSIネットワーク層），TCPネットワークインターフェース層（OSIデータリンク層＋OSI物理層）を経る．各層で，パケットにヘッダー情報が追加される．
4. PCからルータにパケットが送信される．
5. ルータはTCPインターネット層（OSIネットワーク層）に属するため，より上層に一度戻ることになる．
6. グローバルネットワークを経て，送信先のプライベートネットワークのルータに到達する．
7. ルータからサーバーにパケットが送信される．
8. パケットは，サーバーのCPネットワークインターフェース層（OSIデータリンク層＋OSI物理層），TCPインターネット層（OSIネットワーク層），TCPトランスポート層（OSIトランスポート層），を経る．
9. サーバーにて，アプリケーションのプロセスが特定のポート番で受信している．アプリケーションによってパケットが処理される．

![OSI参照モデルと通信機器.png](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/OSI参照モデルと通信機器.jpg)

#### ・ネットワーク層

#### ・データリンク層

#### ・物理層

NIC：Network Interface Card（例：LANアダプタ，LANボード，LANカード），リピータ，LANケーブル

<br>

### 各概念層のヘッダ情報認識

送信元で作成されたパケットは，非カプセル化されながら，通信機器に認識される．

参考：https://ja.wikipedia.org/wiki/%E3%83%AB%E3%83%BC%E3%82%BF%E3%83%BC

![tcp-ip_structure](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/tcp-ip_structure.png)

<br>

## 03. TCPアプリケーション層

### アプリケーション層とは

各アプリケーションがプロセスとして稼働しており，それぞれがデータ（メッセージ）を作成する．各プロセスは特定のポート番号を受信する．

参考：https://netdekagaku.com/netstat-command/

![application_expose-port](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/application_expose-port.png)

ちなみに，ポート番号を使用しているプロセスの一覧は，以下のコマンドで表示できる．

```bash
$ sudo lsof -i -P | grep "LISTEN"
```

<br>

## 03-02. メールデータの作成

### メールデータの送受信

#### ・仕組み

1. クライアント（メール送信可能なアプリケーション）から送信されたメールは，送信側のメールサーバーに送信される．
2. 送信側のメールサーバーは，メールを受信側のメールサーバーに転送する．
3. 受信側のアプリケーションは，各々が指定したプロトコルに応じて，受信側のメールサーバーからメールデータを取得する．

参考：https://xtech.nikkei.com/it/pc/article/basic/20120312/1043605/

![smtp_pop3_imap4](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/smtp_pop3_imap4.png)

#### ・送信側のメールサーバーのモック

メールデータの送信機能を開発するときに，送信テストを行う必要があり，この内容は公開したくない．そこで，送信側のメールサーバーのモックを提供するサービスを利用する．この送信側メールサーバーモックは，クライアントから送信されたメールのテストデータを受信側のメールサーバーに転送しないため，安全に送信テストを実行できる．Mailtrapがおすすめである．

参考：https://mailtrap.io/

<br>

### SMTP：Simple Mail Transfer Protocol

#### ・SMTPとは

メールデータを送信するためのプロトコルのこと．

#### ・SMTP-AUTH：SMTP AUTHentication

SMTPに認証を組み込んだ仕組みのこと．クライアント（メール送信可能なアプリケーション）からメールサーバーにメールデータをSMTP送信する時，メールサーバーがクライアントに対して認証を実行する．

![SMTP-AUTH](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/SMTP-AUTH.png)

<br>

### POP3：Post Official Protocol version 3

#### ・POP3とは

メールサーバーに届いたメールを，受信機器にダウンロードし，受信機器で閲覧するプロトコル．メールの既読未読状況は，他の受信機器と共有される．

<br>

### IMAP4：Internet Message Access Protocol version 4

#### ・IMAP4とは

メールサーバーに届いたメールを，受信機器にダウンロードせず，メールサーバーに置いたまま閲覧するプロトコル．メールの既読未読状況は，他の受信機器と共有されない．

  **＊例＊**

  GmailでPOPかIMAPを設定可能

![GmailでPOPorIMAPを設定](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/GmailでPOPかIMAPを設定.jpg)

<br>

### APOP：Authenticated POP

#### ・APOPとは

  メール受信の際に，チャレンジレスポンス方式の認証を行うことで平文の認証情報がネットワークに流れるのを防止するプロトコル

  <br>

## 04. TCPトランスポート層

### トランスポート層とは

#### ・全体像

クライアントからのリクエスト時に，ネットワーク層から渡されたパケットのポート番号情報を元に，アプリケーション層の特定のプロセスにパケットを渡す．また反対に，レスポンス時にアプリケーション層のプロセスから出力されたパケットに情報を付加し，ネットワーク層に渡す．この時，各アプリケーションはプロセスとして稼働していることに留意する．

![トランスポート層からアプリケーション層へのパケットの移動](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/トランスポート層からアプリケーション層へのパケットの移動.PNG)

#### ・クライアントからのリクエスト時（図の 『→』 ）

まず，ネットワーク層でプライベートIPアドレスを用いて，リクエスト先のパソコンを識別する．その後，トランスポート層で，ポート番号を元にして，アプリケーション層のプロセスにパケットを送信する．

**＊例＊**

開発環境のnginxプロセスの受信するポート番号を```8080```と設定した場合，リクエスト時に以下のようにポート番号を指定すると，nginxプロセスにリクエストを送信できる．

```http
GET http://127.0.0.1:8080
```

#### ・クライアントへのレスポンス時（図の 『←』 ）

アプリケーション層から送信されてきたパケットの通過したポート番号をヘッダ情報として追加する．これを，ネットワーク層へ送信する．

#### ・ソケット，ソケット接続とは

トランスポート層に存在し，受信した通信をアプリケーション層の各プロセスに振り分ける受け口をソケットという．送信元のサーバーが送信先に対して，『```192.168.1.1:50001```（送信元IPアドレス:送信ポート）』『```10.0.0.1:80```（宛先IPアドレス:宛先ポート）』といったように，IPアドレスとポート番号の組合せで指定する．オリジンとは似て非なるものなので注意．サーバー間のソケット間のネットワーク接続をソケット接続という．

<br>

### ポート番号

#### ・ポート番号とは

アプリケーションのプロセスへのパケット送受信に，プロセスを区別するために各プロセスに割り当てられる番号．アプリケーションには，それぞれポート番号が割り当てられており，トランスポート層で，ポート番号を元にして，特定のプロセスにパケットを送信する．

#### ・Well known ポート番号（```0``` ～ ```1023```）

IANA：Internet Assigned Numbers Authority（インターネット割当番号公社）によって管理されているポート番号．主要ポートが使われている場合は，代替ポートを用いることになる．各プロトコルで慣例として使われている代替ポートは，以下の検索サイトを参考にせよ．

参考：https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml?search=alt

![ポート番号とプロトコルの対応関係](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/ポート番号とプロトコルの対応関係.png)

#### ・登録済みポート番号（```1024``` ～ ```49151```）

  IANAが登録申請を受けて公開しているポート番号．企業が作成した独自のアプリなどに対して割り当てられる．

#### ・動的/非公式ポート番号（```49152``` ～ ```65535```）

  自由に使用できるポート番号．

#### ・ポートフォワーディング（ポート転送）

サーバー内の特定のポート番号のアプリケーションに対して，パケットが送信されてきた時，これを異なるポート番号のアプリケーションに転送すること．SSHプロトコルと組み合わせると，SSHポートフォワーディングを実現できる．

<br>

### ポートスキャナ

#### ・ポートスキャナとは

ポートスキャナを用いることによって，各ポート番号にアクセスし，応答があるかどうかや，どのようなソフトウェアが応答するかを調べ，一覧表示できる．

<br>

## 05. TCPインターネット層

### インターネット層とは

IPパケットのヘッダ情報を用いて，宛先認識する．

1. PC-Aは，構成したIPパケットをEthernetに乗せて，ルータAに送信する．
2. ルータAは，IPパケットをデジタル専用線に乗せて，ルータBに送信する．
3. ルータBは，構成したIPパケットをEthernetに乗せて，Webサーバーに送信する．

![ネットワークにおけるTCP_IPを用いたデータ通信](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/ネットワークにおけるTCP_IPを用いたデータ通信.png)

<br>

### IPアドレスの種類

![プライベートIPアドレスとグローバルIPアドレス](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/プライベートIPアドレスとグローバルIPアドレス.png)

#### ・プライベートIPアドレス

LAN内で用いられる．異なるプライベートネットワーク間では，同じIPアドレスが存在する．プライベートIPアドレスは，『```10.0.0.0``` ～ ```10.255.255.255```』，『```172.16.0.0``` ～ ```172.31.255.255```』，『```192.168.0.0``` ～ ```192.168.255.255```』で表される．

#### ・グローバルIPアドレス

プロバイダが提供するIPアドレスである．パブリックネットワーク内に同じIPアドレスは存在せず，Network Information Centerへの使用申請が必要．プライベートIPアドレスの番号でなければ，グローバルIPアドレスである．NATはグローバルIPアドレスを持っており，プライベートネットワークとプライベートネットワーク間の双方向への通信時に，プライベートIPアドレスと相互変換する．

  <br>

### プライベート/グローバルIPアドレスとbitとの関係

例えば，プライベートIPアドレスの4つのオクテット（第一オクテットから第四オクテットまで）が１Byteの容量をもち，IPアドレス全体で４Byteの容量を持つ．ちなみに，```172```から始まるIPアドレスは，クラスBである．　

![IPアドレスとbitの関係](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/IPアドレスとbitの関係.png)

<br>

### プライベート/グローバルIPアドレスのネットワーク部とホスト部

![IPアドレスのホスト部とネットワーク部](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/IPアドレスのホスト部とネットワーク部.png)

#### ・クラスによるホスト部とネットワーク部の定義

IPアドレスをクラスとして分類し，各クラスでIPアドレスのネットワーク部とホスト部を定義する方法．設定したIPアドレスの属するクラスによって，使用できるIPアドレスの範囲が決まってしまう．ホスト部とネットワーク部の定義方法が4種類しかないため，IPアドレスのパターン数（最大パソコン数）が多すぎたり，少なすぎたりしてしまう．

|         使用可能なIPアドレスの範囲         | クラス | ネットワーク部のオクテット | ホスト部のオクテット |          二進数で見た時（n：ネ，h：ホ）          | IPアドレスのパターン数（最大パソコン数） | 備考 |
| :------------------------------: | :------------: | :---------------------------------: | ---------------------- | :--------------------: | :--------------------: | :--------------------: |
| ```0.0.0.0``` 〜 ```127.255.255.255``` |       A        |         第一のみ         |         第二から第四         | ```0nnnnnnn.hhhhhhhh.hhhhhhhh.hhhhhhhh``` |       2^24（16777216）個       | - |
|   ```128.0.0.0``` 〜 ```191.255.255.255```   |       B        |         第一から第二         |         第三から第四         | ```10nnnnnn.nnnnnnnn.hhhhhhhh.hhhhhhhh``` |        2^16（65536）個        |        よく用いる        |
|   ```192.0.0.0``` 〜 ```223.255.255.255```   |       C        |         第一から第三         |         第四のみ         | ```110nnnnn.nnnnnnnn.nnnnnnnn.hhhhhhhh``` |         2^8（256）個         | - |
|   ```224.0.0.0``` 〜 ```239.255.255.255```   |       D        |           -           |           -            | ```1110xxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx``` |           -            | - |
|   ```240.0.0.0``` 〜 ```255.255.255.255```   |       E        |           -           |           -            | ```1111xxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx``` |           -            | - |

#### ・サブネットマスクよるネットワーク部とホスト部の定義

『```1```』あるいは『```0```』で，IPアドレスのネットワーク部とホスト部を定義し，IPアドレスの後ろに記述する方法（**＊例＊**```192.168.42.23/24```）．設定したIPアドレスに対して，使用可能なIPアドレスの範囲を自由に定義できる．ネットワーク部を『```1```』，ホスト部を『```0```』で表現する．サブネットマスクの表記方法には，二進数形式，IPアドレス形式，```1```の個数で表すCIDR形式による表現方法がある．

|               二進数<br>形式               |   IPアドレス<br>形式   | CIDR<br>形式 | IPアドレスの<br>パターン数<br>（最大PC数） | 備考         |
| :----------------------------------------: | :--------------------: | :----------: | :----------------------------------------: | ------------ |
| ```/10000000.00000000.00000000.00000000``` |    ```/128.0.0.0```    |   ```/1```   |                                            |              |
| ```/11000000.00000000.00000000.00000000``` |    ```/192.0.0.0```    |   ```/2```   |                                            |              |
|                    ...                     |          ...           |     ...      |                                            |              |
| ```/11111111.00000000.00000000.00000000``` |    ```/255.0.0.0```    |   ```/8```   |           2^24<br>（16777216）個           |              |
|                    ...                     |          ...           |     ...      |                                            |              |
| ```/11111111.11111110.00000000.00000000``` |   ```/255.254.0.0```   |  ```/15```   |                                            |              |
| ```/11111111.11111111.00000000.00000000``` |   ```/255.255.0.0```   |  ```/16```   |            2^16<br>（65536）個             | よく用いる範囲 |
|                                            |          ...           |     ...      |                                            |              |
| ```/11111111.11111111.11111110.00000000``` |  ```/255.255.254.0```  |  ```/23```   |                                            |              |
| ```/11111111.11111111.11111111.00000000``` |  ```/255.255.255.0```  |  ```/24```   |              2^8<br>（256）個              |              |
|                    ...                     |          ...           |     ...      |                                            |              |
| ```/11111111.11111111.11111111.11111110``` | ```/255.255.255.254``` |  ```/31```   |                                            |              |
| ```/11111111.11111111.11111111.11111111``` | ```/255.255.255.255``` |  ```/32```   |                    1個                     | よく用いる範囲 |

**＊例＊**

プライベートIPアドレスが```192.168.0.0```（```11000000.10101000.00000000.00000000```）で，使いたいIPアドレスのパターン数が65536個，または16777216個の場合，サブネットマスクの表記，使用可能なIPアドレスの範囲は以下のようになる．

| 使いたいIPアドレスのパターン数 |                 二進数形式による表記                  |          IPアドレス形式           |       CIDR形式       |      |         使用可能なIPアドレスの範囲          |
| ------------------------------ | :---------------------------------------------------: | :-------------------------------: | :------------------: | ---- | :-----------------------------------------: |
| 16777216個                     | ```192.168.0.0/11111111.00000000.00000000.00000000``` |    ```192.168.0.0/255.0.0.0```    | ```192.168.0.0/24``` | ⇒    |  ```192.168.0.1``` 〜 ```192.168.0.254```   |
| 65536個                        | ```192.168.0.0/11111111.11111111.00000000.00000000``` |   ```192.168.0.0/255.255.0.0```   | ```192.168.0.0/16``` | ⇒    | ```192.168.0.1``` 〜  ```192.168.255.254``` |
| 1個                            | ```192.168.0.0/11111111.11111111.11111111.11111111``` | ```192.168.0.0/255.255.255.255``` | ```192.168.0.0/32``` | ⇒    |              ```192.168.0.0```              |

<br>

## 05-02. ルータ

### ルーティング

#### ・ルーティングとは

受信した通信を適切な宛先に転送すること．通信の宛先を制御することを表現する場合，単に『転送する』よりも『ルーティングする』と表現した方が良い．

参考：https://www.infraexpert.com/study/routing.html

<br>

### NAT（静的NAT）

#### ・NATとは

1つのグローバルIPアドレスに対して，1つのプライベートIPアドレスを紐付けられる．グローバルIPアドレスを持ち，グローバルネットワークとプライベートネットワークの双方向への通信時に，IPアドレスを変換できる．

#### ・リクエスト時のルータにおける変換

プライベートネットワークから出る時に，パケットのヘッダ情報における『送信元』のプライベートIPアドレスをグローバルIPアドレスに変換する．

  **＊例＊**

例えば，GoogleでWebページを見ながら，Gmailアプリを起動している場合，リクエストにおけるパケット情報として…

| 送信元プライベートIPアドレス |  ⇄   | 送信元グローバルIPアドレス |
| :--------------------------: | :--: | :------------------------: |
|      ```192.168.1.1```       |      |      ```200.1.1.1```       |

1. 『送信元プライベートIPアドレス』『送信先グローバルIPアドレス』『メールサーバーでPOP3プロトコルを受信する```110```番ポート』を指定して，メールサーバーにリクエストを送信する．

```http
GET https://example.com:110
```

2. 『送信元プライベートIPアドレス』『送信先グローバルIPアドレス』『WebサーバーでHTTPプロトコルを受信する```80```番ポート』を指定して，Webサーバーにリクエストを送信する．ただし．```80```番ポートは，省略可能．

```http
GET https://example.com:80
```

3. 『送信元プライベートIPアドレス』『送信先グローバルIPアドレス』『DNSサーバーでTCPプロトコルを受信する```53```番ポート』を指定して，DNSサーバーにリクエストを送信する．

```http
GET https://example.com:53
```

4. これらの『送信元プライベートIPアドレス』が，NATルータで，グローバルIPアドレスに変換される．

![プライベートからグローバルへのnat変換](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/プライベートからグローバルへのnat変換.png)

#### ・レスポンス時の変換

プライベートネットワークに入る時に，パケットのヘッダ情報における『宛先』のグローバルIPアドレスをプライベートIPアドレスに変換する．

![グローバルからプライベートへのnat変換](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/グローバルからプライベートへのnat変換.png)

<br>

### NAPT（動的NAT）

#### ・NAPTとは

1つのグローバルIPアドレスに対して，複数のプライベートIPアドレスを紐付けられる．グローバルネットワークとプライベートネットワークの双方向への通信時に，IPアドレスとポート番号を変換できる．

#### ・リクエスト時の変換

プライベートネットワークから出る時に，パケットのヘッダ情報における『送信元』のプライベートIPアドレスをグローバルIPアドレスに変換する．ただし，異なるプライベートIPアドレスが同じグローバルIPに変換されてしまうため，これを識別するために，ポート番号を複数の異なるポート番号に変換し，グローバルIPアドレスに付け加える．

  **＊例＊**

| 送信元プライベートIPアドレス | 変換前ポート番号 |  ⇄   | 送信元グローバルIPアドレス | 変換後ポート番号 |
| :--------------------------: | :--------------: | :--: | :------------------------: | :--------------: |
|      ```192.168.2.1```       |   ```50011```    |      |   ```130.X.X.X:50011```    |   ```50011```    |
|      ```192.168.3.1```       |   ```50011```    |      |   ```130.X.X.X:50012```    |   ```50012```    |

![napt変換](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/napt変換.png)

#### ・レスポンス時の変換

プライベートネットワークに入る時に，付け加えられたポート番号を元に，パケットのヘッダ情報における『宛先』のグローバルIPアドレスを，異なるプライベートIPアドレスに変換し分ける．

![napt変換_2](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/napt変換_2.png)

<br>

## 05-03. フォワード/リバースプロキシサーバー

### 機能

#### ・代理ルーティング

![フォワードプロキシサーバーとリバースプロキシサーバー](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/フォワードプロキシサーバーとリバースプロキシサーバー.png)

参考：https://qiita.com/att55/items/162950627dc593c72f23

| サーバー名         | 機能                                                         |
| ------------------ | ------------------------------------------------------------ |
| フォワードプロキシサーバー | 特定のクライアントのアウトバウンド通信を，不特定多数のサーバーに代理でルーティングする． |
| リバースプロキシサーバー   | 不特定のクライアントからのインバウンド通信を，特定のサーバーに代理でルーティングする． |

#### ・キャッシュ

![プロキシサーバーのキャッシュ機能](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/プロキシサーバーのキャッシュ機能.png)

参考：https://software.fujitsu.com/jp/manual/manualfiles/M100003/B1WN9491/07Z201/ihs02/ihs00016.htm

| サーバー名         | 機能                                                         |
| ------------------ | ------------------------------------------------------------ |
| フォワードプロキシサーバー | クライアント側にて，代理ルーティングのレスポンスのキャッシュを作成する． |
| リバースプロキシサーバー   | サーバー側にて，代理ルーティングのレスポンスのキャッシュを作成する． |

<br>

### 設置場所

#### ・物理サーバーの場合

フォワードプロキシサーバーはプロバイダの会社に，リバースプロキシサーバーはリクエスト先の社内ネットワークに設置されている．

![プロキシサーバの設置場所](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/プロキシサーバーの設置場所.png)

#### ・クラウド上の場合

クラウドの場合も，仮想環境が構築されるだけで，設置場所は同じである．
