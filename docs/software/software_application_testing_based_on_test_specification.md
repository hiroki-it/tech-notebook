---
title: 【知見を記録するサイト】テスト仕様書ベースのテスト
description: テスト仕様書ベースのテストの知見をまとめました。
---

# テスト仕様書ベースのテスト

## はじめに

本サイトにつきまして、以下をご認識のほど宜しくお願いいたします。

参考：https://hiroki-it.github.io/tech-notebook-mkdocs/about.html

<br>

## 01. テスト仕様書に基づく結合テスト

### 結合テストとは

単体テストの次に行うテスト。複数のモジュールを繋げ、モジュール間のインターフェイスが適切に動いているかを検証。

![結合テスト](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/p491-1.jpg)

<br>

### 結合テストの方向

#### ▼ トップダウンテスト

上層のモジュールから下層のモジュールに向かって、結合テストを行う。下層にはテストダブルのスタブを作成する。

![トップダウンテスト](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/トップダウンテスト.jpg)

<br>

#### ▼ ボトムアップテスト

下層のモジュールから上層のモジュールに向かって、結合テストを行う。上層にはテストダブルのドライバーを作成する。

![ボトムアップテスト](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/ボトムアップテスト.jpg)

<br>

### Scenarioテスト

実際の業務フローを参考にし、ユーザーが操作する順にテストを行う。

<br>

## 02. テスト仕様書に基づくシステムテスト

### システムテストとは

結合テストの次に行うテスト。ソフトウェア全体が適切に動いているかを検証する。User Acceptanceテスト、また総合テストともいう。

<br>

### テストケース例

以下の操作を対象として検証すると良い。

| 大分類 | 中分類               | 検証対象の操作                                               |
| ------ | -------------------- | ------------------------------------------------------------ |
| 機能   | 正常系               | 基本操作（登録、参照、更新、削除）、画面遷移、状態遷移、セキュリティ、など |
|        | 異常系               | 基本操作（登録、参照、更新、削除）、など                     |
|        | 組み合わせ           | 同時操作、割り込み操作、排他制御に関わる操作、など           |
|        | 業務シナリオ         | シナリオに沿ったユーザーによる一連の操作                     |
|        | 開発者シナリオ       | シナリオに沿った開発者による一連の操作（手動コマンドなど）   |
|        | 外部ソフトウェア連携 | 外部のAPIとの連携処理に関わる操作                            |
| 非機能 | 負荷耐性や性能       | 各種ストレステスト（性能テスト、限界テスト、耐久テスト）     |

<br>

## 02-02. 機能テスト

機能要件を満たせているかを検証する。PHPUnitでの機能テストとは意味合いが異なるので注意。

<br>

## 02-03. ストレステスト（負荷テスト）

### ストレステストとは

実際の運用時に、想定したリクエスト数に耐えられるか、を検証する。また、テスト結果から、運用時の監視で参考にするための、安全範囲（青信号）、危険範囲（黄色信号）、限界値（赤信号）、を導く必要がある。ロードテストとは区別すること。ストレステストには、性能テスト、限界テスト、耐久テストがある。

参考：

- https://www.oracle.com/jp/technical-resources/article/ats-tech/tech/useful-class-8.html
- https://engineering.dena.com/blog/2021/10/healthcare-load-testing/

| テストのパラメーター | 説明                                                         |
| -------------------- | ------------------------------------------------------------ |
| スレッド数           | ユーザー数に相当する。                                       |
| ループ数             | ユーザー当たりのリクエスト送信数に相当する。                 |
| RampUp秒             | リクエストを送信する期間に相当する。長くし過ぎすると、全てのリクエスト数を送信するまでに時間がかかるようになるため、負荷が小さくなる。 |

<br>

### 性能テスト

#### ▼ 性能テストとは

![performance-test](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/performance-test.png)

一定時間内に、ユーザーが一連のリクエスト（例：ログイン、閲覧、登録、ログアウト）を行った時に、ソフトウェアのスループットとレスポンス時間にどのような変化があるかを検証する。具体的にはテスト時に、アクセス数を段階的に増加させて、その結果をグラフ化する。グラフ結果を元に、想定されるリクエスト数が現在の性能にどの程度の負荷をかけるのかを確認し、また性能の負荷が最大になる値を導く。これらを運用時の監視の参考値にする。

参考：

- https://www.oracle.com/jp/technical-resources/article/ats-tech/tech/useful-class-8.html
- https://engineering.dena.com/blog/2021/10/healthcare-load-testing/

<br>

### 限界テスト

#### ▼ 限界テストとは

性能の限界値に達するほどのリクエスト数が送信された時に、障害回避処理（例：アクセスが込み合っている旨のページを表示）が実行されるかを検証する。具体的にはテスト時に、障害回避処理以外の動作（エラー、間違った処理、障害回復後にも復旧できない、システムダウン）が起こらないかを確認する。

参考：

- https://www.oracle.com/jp/technical-resources/article/ats-tech/tech/useful-class-8.html
- https://engineering.dena.com/blog/2021/10/healthcare-load-testing/

<br>

### 耐久テスト

#### ▼ Durability（耐久性）

長時間の高負荷にどれだけ耐えられるかの程度を表す。

#### ▼ 耐久テストとは

長時間の大量リクエストが送信された時に、短時間では検出できないどのような問題が存在するかを検証する。具体的にはテスト時に、長時間の大量リクエストを処理させ、問題（例：微量のメモリリークが蓄積してメモリを圧迫、セッションデータが蓄積してメモリやストレージを圧迫、ログが蓄積してストレージを圧迫、ヒープやトランザクションログがCPUやI/O処理を圧迫）を起こす。これにより、どんな問題が起こるかを確認する。

参考：

- https://www.oracle.com/jp/technical-resources/article/ats-tech/tech/useful-class-8.html
- https://engineering.dena.com/blog/2021/10/healthcare-load-testing/

<br>

## 02-04. ロードテスト（再現テスト）

### ロードテストとは

ソフトウェアが通常/ピーク/障害時の負荷を再現し、これに耐えられるかどうかを検証する。ストレステストとは区別すること。

参考：https://stackify.com/what-is-load-testing/

<br>

### テストケース例

#### ▼ 背景

アプリケーションで、開始からピークまでに、次のようにリクエスト数が増し、障害が起こったとする。その後、データを収集した。これの再現テストを行う。

| 障害発生期間                            | 合計閲覧ページ数<br>```(PV数/min)``` | 平均ユーザー数<br>```(UA数/min)``` | ユーザー当たり閲覧ページ数<br>```(PV数/UA数)``` |
| --------------------------------------- | ------------------------------------ | --------------------------------- | ---------------------------------------------- |
| ```13:00 ~```<br>```13:05```（開始）   | ```300```                            | ```100```                         | ```3```                                        |
| ```13:05 ~```<br>```13:10```           | ```600```                            | ```200```                         | ```3```                                        |
| ```13:10 ~```<br>```13:15```（ピーク） | ```900```                            | ```300```                         | ```3```                                        |

| ランキング | URL              | 割合       |
| ---------- | ---------------- | ---------- |
| 1          | ```/aaa/bbb/*``` | 40 ```%``` |
| 2          | ```/ccc/ddd/*``` | 30 ```%``` |
| 3          | ```/eee/fff/*``` | 20 ```%``` |
| 4          | ```/ggg/hhh/*``` | 10 ```%``` |

#### ▼ テスト内容

ユーザー当たりの閲覧ページ数はループ数に置き換わるので、ループ数は『```3```回』になる。障害発生期間の閲覧ページ数はスレッド数に置き換わるので、スレッド数は『```1800```個（```300 + 600 + 900```）』になる。障害発生期間は、Ramp-Upに置き換わるので、Ramp-Up期間は『```900```秒（```15```分間）』

| スレッド数（個） | ループ数（回） | Ramp-Up期間```(sec)``` |
| ---------------- | -------------- | ---------------------- |
| ```1800```       | ```3```        | ```900```              |

<br>

## 02-05. 可用性テスト

### Availability（可用性）

#### ▼ 可用性とは

仮に障害があったとしても、どれだけシステムの利用可能な時間を長くできるかを程度を表す。

参考：https://www.weblio.jp/content/%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7

<br>

### 可用性テストとは

可用性を定量的に検証する。

<br>

### 指標

#### ▼ RPO（目標復旧時点）

障害が起こった時に、どの時点まで、データを復旧させるかの目標値のこと。もしRPOが```5```分だとすると、障害前の```5```分間で作成されたデータは復旧できないことは許容することになる。

参考：https://e-words.jp/w/RPO.html

#### ▼ RTO（目標復旧時間）

障害が起こった時に、どの時間までに、データを復旧させるかの目標値のこと。もしRTOが```1```時間だとすると、```1```時間はデータを復旧できないままになることを許容することになる。

参考：https://e-words.jp/w/RTO.html

#### ▼ MTBF：Mean Time Between Failure

特定の障害と次の障害の間の平均稼働時間のこと。

参考：https://www.seplus.jp/dokushuzemi/fe/fenavi/easy_calc/availability/

#### ▼ MTTR：Mean Time To Repair

障害が復旧するまでの平均障害時間のこと。目標値のRTOとは異なることに注意する。

参考：https://www.seplus.jp/dokushuzemi/fe/fenavi/easy_calc/availability/

#### ▼ 稼働率

システムの実際の稼働時間割合を表す。以下の計算式で算出できる。システムが冗長化されている場合、両方の非稼働率をかけて、全体から引く。

参考：https://www.seplus.jp/dokushuzemi/fe/fenavi/easy_calc/availability/

```mathematica
(稼働率)
= (動作した時間) ÷ (全体の時間)
```

この数式は、以下ように書き換えることができる。

```mathematica
(稼働率)
= (MTBF) ÷ (MTBF ＋ MTTR)
```

**＊例＊**

システムが冗長化されている例を示す。すでに稼働率は算出されているものとする。両方の非稼働率をかけて、全体から引く。

```mathematica
(1 - (1-0.81)) × (1-0.64) = 0.9316
```

![稼働率の計算](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/稼働率の計算.jpg)

<br>

### テストケース例

#### ▼ 背景

仮想サーバーとしてのKubernetes Node上で、Kubernetesリソースが稼働している。これの可用性テストを行う。

- 仮想サーバー：AWS EC2（オートスケーリングあり）
- アプリケーション：Go
- リバースプロキシ：Nginx
- オペレーター：各種Operator
- サービスメッシュ：Istio
- 監視

  - データ収集/分析

    - メトリクス収集：kube-state-metrics、各種Exporter、Prometheus
    
    - ログルーティング：Fluentd
    
  - データ可視化
  
    - メトリクス可視化：Grafana
    
  - アラート
  
    - アラートのルーティング：Alertmanager
  

#### ▼ テスト内容

| テストケース   | 詳細                                | テスト方法例                                                 | 期待動作                                                     |
| -------------- | ----------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Nodeの停止障害 | AWS EC2が停止する。                 | ノード内でroot権限でカーネルパニックを意図的に起こし、その状態でもシステム全体として稼働し続けられるかを確認する。（```echo 1 > /proc/sys/kernel/sysrq && echo c > /proc/sysrq-trigger```） | ・冗長化された稼働中のNode上で、レプリカ数を維持できるだけのPodが起動する。<br>・オートスケーリングによって、停止したNodeに代わり新しいNodeが起動する。<br>・Nodeのヘルスチェックが正常である。 |
| Podの停止障害  | GoのPodが停止する。                 | kubectlコマンドでPodを強制終了し、その状態でもシステム全体として稼働し続けられるかを確認する。（```kubectl delete pod <ポッド名> --grace-period=0 --force```） | ・オートスケーリングによって、停止したPodに代わり新しいPodが起動する。<br>・アプリケーションが正しく動作している。 |
|                | NginxのPodが停止する。              | 同上                                                         | ・オートスケーリングによって、停止したPodに代わり新しいPodが起動する。<br>・アプリケーションが正しく動作している。 |
|                | kube-state-metricsのPodが停止する。 | 同上                                                         | ・オートスケーリングによって、停止したPodに代わり新しいPodが起動する。<br>・データを全て収集できている。 |
|                | PrometheusのPodが停止する。         | 同上                                                         | ・オートスケーリングによって、停止したPodに代わり新しいPodが起動する。<br>・データを全て収集できている。 |
|                | FluentdのPodが停止する。            | 同上                                                         | ・オートスケーリングによって、停止したPodに代わり新しいPodが起動する。<br>・ログを正しくルーティングできている。 |
|                | GrafanaのPodが停止する。            | 同上                                                         | ・オートスケーリングによって、停止したPodに代わり新しいPodが起動する。<br>・ダッシュボードにログインできる。<br>・データを正しく可視化できている。 |
|                | AlertmanagerのPodが停止する。       | 同上                                                         | ・オートスケーリングによって、停止したPodに代わり新しいPodが起動する。<br>・ダッシュボードにログインできる。<br>・アラートを正しくルーティングできている。 |

<br>

## 02-06. 耐障害性テスト

### Fault tolerance（耐障害性）

#### ▼ 耐障害性とは

障害が起きた時にユーザーへの影響をどれだけ小さくできるかの程度を表す。

#### ▼ 定量化の方法

<br>

### 耐障害性テストとは

参考：https://blog.cybozu.io/entry/2018/09/06/080000


<br>

## 02-07. その他のテスト

### Regressionテスト（回帰テスト）

ソフトウェアのコードを変更した後、他のプログラムに悪影響を与えていないかを検証。

![p496](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/p496.jpg)

<br>

## 03. グラフによるテストの可視化

### バグ管理図

プロジェクトの時、残存テスト数と不良摘出数（バグ発見数）を縦軸にとり、時間を横軸にとることで、バグ管理図を作成する。それぞれの曲線の状態から、プロジェクトの進捗状況を読み取られる。

![品質管理図](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/品質管理図.jpg)

不良摘出実績線（信頼度成長曲線）は、プログラムの品質の状態を表し、S字型でないものはプログラムの品質が良くないことを表す。

![信頼度成長曲線の悪い例](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/信頼度成長曲線の悪い例.jpg)



