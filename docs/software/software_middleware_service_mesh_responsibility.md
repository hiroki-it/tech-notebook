---
title: 【IT技術の知見】サービスメッシュの担う責務＠サービスメッシュ
description: サービスメッシュの担う責務＠サービスメッシュの知見を記録しています。
---

# サービスメッシュの担う責務＠サービスメッシュ

## はじめに

本サイトにつきまして、以下をご認識のほど宜しくお願いいたします。

> - https://hiroki-it.github.io/tech-notebook/

<br>

## 01. サービスメッシュの担う責務

サービスメッシュを採用しない場合 (Kubernetes のみ) と比較して、各サービスメッシュツールがインフラ領域のどんな責務を実装してくれるかを記載する。

もしサービスメッシュを採用しない場合、サービスメッシュと同じ責務をアプリ領域に実装する必要がある。

サービスメッシュが担う責務が要件として必要であるなら、以下の理由でサービスメッシュツールを採用した方が良い。

- マイクロサービス側にインフラ領域の責務を実装しなくて済むため、アプリエンジニアの負担が減る。
- インフラ領域の責務をサイドカーに切り分けられるため、凝集度が高くなる
- 各マイクロサービスに共通して提供できるため、単純性が高くなる

一方で要件として不要ならば、サービスメッシュツール自体を採用する必要はない、という判断になる。

> - https://www.amazon.co.jp/dp/1492043788
> - https://servicemesh.es/
> - https://hiroki-it.github.io/tech-notebook/infrastructure_as_code/infrastructure_as_code_kubernetes_cncf_project_istio.html

<br>

## 02. トラフィック管理

### プロトコル

サービスメッシュは、任意のプロトコルを扱える。

| 責務     | Kubernetes<br>(サービスメッシュ採用せず) | Istio | Linkerd | Consul | AWS App Mesh |
| -------- | ---------------------------------------- | :---: | :-----: | :----: | :----------: |
| TCP      | Service + kube-proxy                     | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |
| HTTP/1.2 | Ingress                                  | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |
| HTTP/2.0 | Ingress                                  | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |
| gRPC     | Ingress、Service + kube-proxy            | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |

<br>

### ネットワーク

Kubernetesでは、Serviceは単一のバージョンのPodとしか通信できない。

もし複数の異なるバージョンのPodを対象にしたい場合、Podのバージョンに応じたServiceを作成する必要がある。

一方で、サービスメッシュツールは異なるバージョンのPodに、さまざまな手法 (例：カナリア方式、トラフィックミラーリング方式、など) で通信できる。

| 責務                                                   | Kubernetes<br>(サービスメッシュ採用せず) | Istio | Linkerd | Consul | AWS App Mesh |
| ------------------------------------------------------ | ---------------------------------------- | :---: | :-----: | :----: | :----------: |
| `L4`ロードバランシング                                 | Service + kube-proxy                     | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |
| `L7`ロードバランシング                                 | Ingress                                  | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |
| ルーティング<br>(ホストベース、パスベース、割合ベース) | Service + kube-proxy、Ingress            | `⭕️`  |    ×    |   ×    |      ×       |
| サービスディスカバリー                                 | Service + kube-proxy                     | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |
| CNIアドオン                                            | 記入中...                                | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |

<br>

## 03. 復旧性の管理

サービスメッシュは、マイクロサービスの復旧性を管理する。

| 責務                                 | Kubernetes<br>(サービスメッシュ採用せず) | Istio | Linkerd | Consul | AWS App Mesh |
| ------------------------------------ | ---------------------------------------- | :---: | :-----: | :----: | :----------: |
| サーキットブレイカー                 | 記入中...                                | `⭕️`  |    ×    |  `⭕️`  |     `⭕️`     |
| フォールトインジェクション           | 記入中...                                | `⭕️`  |  `⭕️`   |   ×    |      ×       |
| 再試行処理                           | 記入中...                                | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |
| タイムアウト                         | 記入中...                                | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |
| リクエスト数制限<br>(レートリミット) | 記入中...                                | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |

<br>

## 04. 通信の認証/認可

サービスメッシュは、ゼロトラストネットワークに基づいて、通信にも認証/認可を実施する。

アプリ側の認証/認可はサービスメッシュの管理外であるため、別に実装する必要がある。

| 責務                | Kubernetes<br>(サービスメッシュ採用せず)                                               |              Istio               | Linkerd | Consul | AWS App Mesh |
| ------------------- | -------------------------------------------------------------------------------------- | :------------------------------: | :-----: | :----: | :----------: |
| 相互TLS認証         | 相互TLS認証ツール<br>(例：Spiffe)                                                      | `⭕️`<br>(Spiffeへ置き換えできる) |  `⭕️`   |  `⭕️`  |     `⭕️`     |
| JWTによるBearer認証 | アプリで実装、OAuth`2.0`プロキシ (例：oauth2-proxy、など) やSSOプロキシ(例：dex、など) |               `⭕️`               |    ×    |  `⭕️`  |      ×       |

> - https://speakerdeck.com/ido_kara_deru/secure-microservices-with-istio?slide=18

<br>

## 05. 通信データの暗号化

サービスメッシュは、通信データをSSL証明書で暗号化する。

Kubernetesでは、Podの作成に応じて証明書のKubernetesリソース (Certificate、CertificateSigningRequest、など) を作成する必要がある。

| 責務                | Kubernetes<br>(サービスメッシュ採用せず) |              Istio               | Linkerd | Consul | AWS App Mesh |
| ------------------- | ---------------------------------------- | :------------------------------: | :-----: | :----: | :----------: |
| 相互TLS認証         | 相互TLS認証ツール<br>(例：Spiffe)        | `⭕️`<br>(Spiffeへ置き換えできる) |  `⭕️`   |  `⭕️`  |     `⭕️`     |
| SSL証明書の自動更新 | SSL証明書管理ツール<br>(例：CertManager) |               `⭕️`               |    ×    |  `⭕️`  |     `⭕️`     |

> - https://speakerdeck.com/ido_kara_deru/secure-microservices-with-istio?slide=18

<br>

## 06. テレメトリー管理

### ログの場合

サービスメッシュツールを使用する場合、マイクロサービスの代わりにサイドカープロキシがアクセスログを作成し、ログ監視バックエンドに送信する。

ただし、マイクロサービスでもアクセスログを作成しても良い。

| 責務                                                                                | Kubernetes<br>(サービスメッシュ採用せず) | Istio | Linkerd | Consul | AWS App Mesh |
| ----------------------------------------------------------------------------------- | ---------------------------------------- | :---: | :-----: | :----: | :----------: |
| マイクロサービスの実行ログを作成する                                                | -                                        |   ×   |    ×    |   ×    |      ×       |
| マイクロサービスの実行ログをログルーター<br>(例：Fluentd、FluentBit) へ送信する     | -                                        |   ×   |    ×    |   ×    |      ×       |
| マイクロサービスのアクセスログを作成する                                            | 各言語のロギングパッケージ               | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |
| マイクロサービスのアクセスログをログルーター<br>(例：Fluentd、FluentBit) へ送信する | 各言語のロギングパッケージ               | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |

<br>

### メトリクスの場合

サービスメッシュツールを使用する場合、マイクロサービスの代わりにサイドカープロキシがメトリクスを作成し、メトリクス監視バックエンドに送信する。

| 責務                                                                                            |             Kubernetes<br>(サービスメッシュ採用せず)             | Istio | Linkerd | Consul | AWS App Mesh |
| ----------------------------------------------------------------------------------------------- | :--------------------------------------------------------------: | :---: | :-----: | :----: | :----------: |
| マイクロサービスのゴールデンシグナルを作成する                                                  | クライアントパッケージ<br>(例：OTelクライアントパッケージ、など) | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |
| マイクロサービスのゴールデンシグナルをメトリクス監視バックエンド<br>(例：Prometheus) へ送信する | クライアントパッケージ<br>(例：OTelクライアントパッケージ、など) | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |
| マイクロサービスのエンドポイント別にメトリクスをフィルタリングする                              |                            記入中...                             | `⭕️`  |  `⭕️`   |  `⭕️`  |      ×       |

<br>

### 分散トレースの場合

サービスメッシュツールを使用する場合、マイクロサービスの代わりにサイドカープロキシがメトリクスを作成し、トレース監視バックエンドに送信する。

ただし、マイクロサービス間でのトレースIDの伝播はマイクロサービスに実装する必要がある。

| 責務                                                                                        |             Kubernetes<br>(サービスメッシュ採用せず)             | Istio | Linkerd | Consul | AWS App Mesh |
| ------------------------------------------------------------------------------------------- | :--------------------------------------------------------------: | :---: | :-----: | :----: | :----------: |
| 分散トレースを作成する                                                                      | クライアントパッケージ<br>(例：OTelクライアントパッケージ、など) | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |
| 分散トレースをトレースコレクター<br>(例：Otelコレクター、jaegerコレクター、など) に送信する | クライアントパッケージ<br>(例：OTelクライアントパッケージ、など) | `⭕️`  |  `⭕️`   |  `⭕️`  |     `⭕️`     |

<br>

### サービスメッシュトポロジーの場合

| 責務                                       | Kubernetes<br>(サービスメッシュ採用せず) | Kiali | X-Ray |
| ------------------------------------------ | ---------------------------------------- | :---: | :---: |
| 必要なメトリクスのデータポイントを収集する | 記入中...                                | `⭕`️ | `⭕️`  |
| サービスメッシュトポロジーをモデリングする | 記入中...                                | `⭕️`  | `⭕️`  |
| サービスメッシュトポロジーをモデリングする | 記入中...                                | `⭕️`  | `⭕️`  |

<br>

## 07. アーキテクチャ

### サービスメッシュのパターン

| 責務                         |             Istio              | Linkerd | Consul | AWS App Mesh |
| ---------------------------- | :----------------------------: | :-----: | :----: | :----------: |
| サイドカープロキシメッシュ   |              `⭕️`              |  `⭕️`   |  `⭕️`  |     `⭕️`     |
| Nodeエージェント型のメッシュ | `⭕️`<br>(アンビエントメッシュ) |    ×    |   ×    |      ×       |

<br>

### 外部データプレーン

サービスメッシュは、Cluster外にあるデータプレーンも管理する。

| 責務                                                               | Istio | Linkerd | Consul | AWS App Mesh |
| ------------------------------------------------------------------ | :---: | :-----: | :----: | :----------: |
| 異なるClusterにあるデータプレーンの管理<br>(マルチClusterメッシュ) | `⭕️`  |  `⭕️`   |  `⭕️`  |      ×       |
| Cluster外の仮想サーバーにあるデータプレーンの管理                  | `⭕️`  |    ×    |  `⭕️`  |     `⭕️`     |

<br>

### Kubernetesとの親和性

| 責務                  | Istio | Linkerd | Consul | AWS App Mesh |
| --------------------- | :---: | :-----: | :----: | :----------: |
| Ingressコントローラー | `⭕️`  |  `⭕️`   |  `⭕️`  |      ×       |
| Egressコントローラー  | `⭕️`  |    ×    |   ×    |      ×       |
| カスタムリソース      | `⭕️`  |  `⭕️`   |   ×    |      ×       |

<br>
