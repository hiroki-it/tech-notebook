---
title: 【知見を記録するサイト】監視
---

# 監視

## はじめに

本サイトにつきまして，以下をご認識のほど宜しくお願いいたします．

参考：https://hiroki-it.github.io/tech-notebook-mkdocs/about.html

<br>

## 01. 監視の要素

### 監視とは

既知のメトリクスとログを基に，システムにおける想定内の不具合の発生を未然に防ぐこと．想定内という点で，可観測性と区別できる．

参考：

- https://en.wikipedia.org/wiki/Website_monitoring
- https://blog.thundra.io/observability-driven-development-for-serverless

<br>

### 監視を構成するアクション

監視は，以下の要素からなる．

参考：https://www.amazon.co.jp/dp/4873118646

| アクション     | 説明                                                         |
| -------------- | ------------------------------------------------------------ |
| データの収集   | 監視対象からデータを収集する．データとしては，メトリクス，アプリケーションログ，ブラウザログ，ユーザートラフィック，ユーザーエンゲージメント，検索クローラーのサイト評価などがある． |
| ↓              |                                                              |
| データの保管   | データをストレージに保管する．                               |
| データの分析   | データを数学的に分析し，集計結果を算出する．                 |
| データの可視化 | データを監視ダッシュボードに表示し，目視できるようにする．   |
| レポートの作成 | 算出値をグラフ化として，レポートを作成する．                 |
| ↓              |                                                              |
| アラート       | データや算出値に異常がある場合，これをイベントとしてオンコール担当の開発者に通知する．全ての異常値をアラートする必要はなく，異常値とみなすためのアラートレベルを決めておく． |

<br>

### 監視のアラート後のアクション

| アクション       | 説明                                                         |
| ---------------- | ------------------------------------------------------------ |
| オンコール       | 通知を受けたオンコール担当は，イベントがインシデントか否かを判断する． |
| インシデント管理 | オンコール担当は，エラーを解決するためのタスクを作成し，完了させる．エラーがインシデントの場合，担当者はこれを迅速に解決する必要がある． |
| SLAとの照合      | インシデントによって，サービス利用者に提供できたサービスのレベルがSLAに満たなかった場合，サービス利用者に利用料を返金する． |

<br>

## 01-02. 監視の種類

### フロントエンド監視

#### ・フロントエンド監視とは

ブラウザに関するトラフィックを監視する．

#### ・リアルユーザー監視（RUM）

Webページのローディング時に，Navigation-timing-APIに対してリクエストを送信すると，Webページパフォーマンスに関するメトリクスを収集できる．JavaScriptにNavigation-timing-APIにリクエストを送信する処理を組み込み，ページパフォーマンスに関するメトリクスを収集した後，これを監視する．

参考：https://developer.mozilla.org/ja/docs/Web/API/Navigation_timing_API

ページローディング時間は特に重要である．Amazonの自社調査では，ローディング時間が100ms短くなるごとに，売り上げが```1```%増加することが明らかになった．```4```秒以下を目指すと良い．

参考：https://bit.ly/2y494hq

#### ・Googleアナリティクスによる監視

サイト訪問後のユーザーエンゲージメントをデータとして監視する．リアルユーザー監視の一種ともみなせるが，パフォーマンスの監視が主目的ではなく，リアルユーザー監視と補完し合う監視方法である．

参考：

- https://blog.uptrends.com/web-performance/rum-and-google-analytics-understanding-the-difference/
- https://developer.akamai.com/blog/2017/03/29/RUM-data-google-analytics
- https://www.amazon.co.jp/dp/4873118646

#### ・Googleサーチコンソールによる監視

検索エンジン上（サイト訪問前）のユーザーエンゲージメントをデータとして監視する．監視の一種

参考：

- https://support.google.com/webmasters/answer/9128668?hl=en
- https://semlabo.com/seo/blog/difference-between-ga-and-gsc/

#### ・合成監視（外部監視）

『外部監視』ともいう．実際のユーザーの一連の操作を模したリクエストをアプリケーションに送信し，レスポンスに関するメトリクスを収集した後，これを監視する．ユーザーを模したリクエストを生成するという意味合いで，『合成』という．ユーザー視点で監視できる．

参考：

- https://takehora.hatenadiary.jp/entry/2019/07/05/012036
- https://www.manageengine.jp/products/Applications_Manager/solution_synthetic-monitoring.html

<br>

### アプリケーション監視（APM）

#### ・アプリケーション監視とは

『APM（アプリケーションパフォーマンス監視）』ともいう．アプリケーション内に常駐させたSaaSエージェントを用いて，稼働中のアプリケーションのメトリクスやアプリケーションログを収集した後，これらを監視する．メトリクスの例は以下に示す．

- SQLにかかる時間  
- ビルドまたはデプロイの開始/終了時間  
- 外部APIコールにかかる時間  
- リクエストの受信数  
- ログイン数  

#### ・StatsDを用いたメトリクスの作成

サーバー内にStatsDを常駐させ，アプリケーションでStatsDライブラリを用いると，メトリクスを収集できる．

参考：https://github.com/statsd/statsd/wiki

CloudWatchではStatsDからのメトリクスの送信がサポートされている．

参考：

- https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/monitoring/CloudWatch-Agent-custom-metrics-statsd.html
- https://qiita.com/murata-tomohide/items/9bd1320865b2eba47538

<br>

### サーバー/コンテナ監視

#### ・サーバー/コンテナ監視とは

サーバー/コンテナのOSに関するメトリクスを収集した後，これを監視する．メトリクスの例は以下に示す．

- CPU
- メモリ
- ロードアベレージ
- ネットワーク
- ディスク

<br>

### ネットワーク監視

<br>

### セキュリティ監視

#### ・セキュリティ監視とは

ログ，メトリクス，分散トレースを収集した後，これを解析し，脆弱的であるか否かを監視する．

<br>

## 02. オンコールからインシデント対応まで

### Slackを用いた場合

ここでは，AWSを用いた手順を記載する．

（１）Slackの通知を確認する．

（２）アラーム名（例：prd-foo-ecs-container-laravel-log-alarm）から，CloudWatchアラームを探す．

（３）アラームがどのロググループに紐づいているかを探す．2021/12/09現在，AWSの仕様ではこれがわかりにくくなっている．メトリクスフィルターが設定されているロググループは，アラームに紐づいている可能性があり，メトリクスフィルターで作成されているメトリクス名（例：ErrorCount）がアラームに記載されたものであれば，紐づいているとわかる．

（４）Log Insightsを用いて，ロググループの直近のエラーログを抽出する．

```bash
# 小文字と大文字を区別せずに，Errorを含むログを検索する．
fields @timestamp, @message, @logStream
| filter @message like /(?i)(Error)/
| sort @timestamp desc
| limit 100
```

（５）クエリの結果から，アラートの原因になっているエラーを見つける．CloudWatchのタイムスタンプとSlackの通知時刻には若干のタイムラグがある．

（６）クエリの結果をコピーし，アラートのThreadに貼り付ける．

```log
 [2021-12-01 00:00:00] request.ERROR: Uncaught PHP Exception ***** 
```

（７）ログイベントが許容できるものあれば，保留として，その旨を連絡する．

（８）ログイベントがインシデントであれば，その旨を連絡する．また，タスク化し，迅速に対応する．

（９）ログイベントがインシデントでないエラーイベントであれば，その旨を連絡する．タスク化し，時間のある時に対応する．

<br>

### アラートレベル

#### ・アラートレベルとは

全ての異常値をアラートすると，アラート疲れしてしまう．そのため，ステータスに応じてアラートするかどうか（アラートレベル）を決めておく必要がある．

#### ・異常値がログステータスの場合

アラートするログステータスの目安は以下の通りである．

参考：https://engineering.otobank.co.jp/entry/2016/09/20/181756

| ログステータス | 説明                                             | 本番環境のアラートの目安 |
| -------------- | ------------------------------------------------ | ------------------------ |
| emergency      | システムが使用できない状態にある緊急事態         | する                     |
| alert          | 早急に対応すべき事態                             | する                     |
| critical       | 対処すべき重要な問題                             | する                     |
| error          | 何かが失敗している                               | どちらでも               |
| warn           | 普通ではないことが起こったが、心配する必要はない | どちらでも               |
| notice         | いたって普通だが、注意すべきことが起こっている   | しない                   |
| info           | 知っておくといいかもしれない情報                 | しない                   |
| debug          | 問題が起こっている場所を知るのに有効な情報       | しない                   |

#### ・異常値がステータスコードの場合

アラートするステータスコードとログステータスへの変換の目安は以下の通りである．各ステータスコードをバラバラに扱うことは大変なので，系ごとにまとめて扱えるように，レベルを割り当てる．

| ステータスコード | 本番環境のアラートの目安 | レベル   | 本番環境のアラートの目安 |
| ---------------- | ------------------------ | -------- | ------------------------ |
| ```500```系      | する                     | critical | する                     |
| ```400```系      | どちらでも               | warning  | しない                   |
| ```300```系      | しない                   | notice   | しない                   |
| ```200```系      | しない                   | info     | しない                   |

<br>

## 03. インシデント管理

### インシデントとは

サービスの停止を起こし得る想定外のイベントのこと．

参考：https://www.atlassian.com/ja/incident-management/devops/incident-vs-problem-management

<br>

### MTTxメトリクス

#### ・MTTxメトリクスとは

![mttx-metrics](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/mttx-metrics.png)

| 区分           | 説明                                                         |      |
| -------------- | ------------------------------------------------------------ | ---- |
| 検出時間       | インシデントが起こってから，これがオンコール担当にアラートされるまで． |      |
| エンゲージ時間 | インシデントがオンコール担当にアラートされ，オンコール担当本人/アサインされたエンジニアがタスクとして着手するまで． |      |
| 修正時間       | オンコール担当がタスクに着手してから，これを完了するまで．   |      |

インシデント管理に要した時間を計測したメトリクスのこと．

参考：

- https://www.amazon.co.jp/dp/4873119618
- https://medium.com/@yoannutc/setting-objectives-for-incident-response-634fff2d8262

#### ・ダッシュボード

MTTxメトリクスをダッシュボード化する．実際に時間と目標時間を比較すれば，今回のインシデント管理の良し悪しを判断できるため，インシデント管理自体をソフトウェア開発と同様に反復的に改善しやすくになる．DRI Hops（インシデントの直接責任者）の値を用いて人的コストを可視化することにより，エンジニアリングマネージャがインシデント管理を扱いやすくなる．

参考：https://www.amazon.co.jp/dp/4873119618

![mttx-metrics_dash-board](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/mttx-metrics_dash-board.png)

<br>

### インシデントコマンドシステムに基づく役割分離

#### ・インシデントコマンドシステムとは

災害や事故の発生時に，組織が混乱せずに問題に対処できるようにするためのマネージメント手法のこと．

参考：https://fastalert.jp/column/disaster-prevention/incident-command-system

#### ・指揮

インシデントの状況把握を担当する．また，インシデント担当チームを組織し，各担当者にタスクを割り振る．

#### ・実行

インシデントの解決を担当する．

#### ・計画

ステークホルダーへの状況報告やドキュメントの作成を担当する．

#### ・後方支援

作業者のサポートを担当する．作業者間引継ぎの調整，夕食の発注，などがある．

<br>

### ポストモーテム

#### ・ポストモーテムとは

アラートで通知されたインシデントがビジネスに大きな影響を与えた場合，振り返りとして，ポストモーテムを作成する．ポストモーテムは，障害報告書とは異なり，原因特定とシステム改善に重きを置いた報告書である．障害報告書は，責任の報告の意味合いが強くなってしまう．

#### ・テンプレート

参考：https://ueokande.github.io/incident-response-docs-ja/after/post_mortem_template/

```markdown
# ポストモーテム

## タイトル

## 日付

## 担当者

**※担当者を絶対に責めず，障害は誰のせいでもないという意識を強く持つ．**

## 原因と対応

**※原因特定とシステム改善に重きを置くこと．**

## システム的/収益的な影響範囲

## 幸運だったこと

## 仕組みの改善策

**※『以後は注意する』ではなく，再発しない仕組み作りになるようにする．**

## 障害発生から対応までのタイムライン

```

<br>

#### ・他社事例

参考：https://ueokande.github.io/incident-response-docs-ja/after/post_mortem_process/#_6

| サービス | リンク                                                       |
| -------- | ------------------------------------------------------------ |
| AWS      | https://aws.amazon.com/jp/message/5467D2/                    |
| Heroku   | https://status.heroku.com/incidents/151                      |
| Twilio   | https://www.twilio.com/blog/2013/07/billing-incident-post-mortem-breakdown-analysis-and-root-cause.html |

<br>

## 04. 監視に基づく意思決定

### SLI：Service Level Indicator（サービスレベル指標）

#### ・SLIとは

サービスレベルの指標とするメトリクスのこと．

#### ・SLIの例

- サーバー稼働率
- データベース稼働率
- レイテンシー
- レスポンスタイム
- レスポンスのステータスコード率
- スループット
- MTTxメトリクス

<br>

### SLO：Service Level Objective（サービスレベル目標）

#### ・SLOとは

SLIとして採用した指標の目標値のこと．ユーザーの視点で設定する必要がある．```99.9```%の成功率を目標とすることが多い．また，サイトの一部の機能が社内部署向け（例：マーケティング部）の場合は，社内向けのSLOとなる．

#### ・SLOの例

| 指標                           | 目標値の例                                         |
| ------------------------------ | -------------------------------------------------- |
| サーバー稼働率                   | 日当たり```0.1```%以下のダウンタイム               |
| データベース稼働率             | 日当たり```0.1```%以下のダウンタイム               |
| レイテンシー                   | 日当たり```0.1```%以下のレイテンシー               |
| レスポンスのステータスコード率 | 日当たり```99.9```%以上の```200```ステータスコード |
| スループット                   | 日当たり```0.1```%以下のスループット低下           |

<br>

### エラーバジェット

#### ・エラーバジェットとは

年月当たりで許容するエラーやダウンタイムの程度のこと．エラーやダウンタイムの発生によって，システムの信頼性に影響を与える可能性があったとしても，SLOの閾値を超えない限りはこれを許容し，技術を優先する．ビジネスより技術を優先する場合に素早く意思決定できる．

<br>

### SLA：Service Level Agreement

#### ・SLAとは

サービスレベル合意と訳せる．インターネットサービスに最低限のサービスのレベルを保証し，これを下回った場合には返金できるように合意するもの．SLAとして，例えば以下がある．

| 項目             | 説明                                 | レベル例                | 返金率    |
| ---------------- | ------------------------------------ | ----------------------- | --------- |
| サーバー稼働率     | サーバーの時間当たりの稼働率           | ```99.9```%以上         | ```10```% |
| 障害回復時間     | 障害が起こってから回復するまでの時間 | ```2```時間以内         | ```10```% |
| 障害お問い合わせ | 障害発生時のお問い合わせ可能時間帯   | ```24```時間```365```日 | ```10```% |

#### ・AWSの場合

AWSではサービスレベルの項目として，サーバー稼働率を採用している．これに対して，ほとんどのAWSリソースで，以下のSLAが設定されている．各リソースにSLAが定義されている．

参考：https://aws.amazon.com/jp/legal/service-level-agreements/

**＊例＊**

EC2，EBS，ECS，EKS，の例を示す．

| 毎月の稼働率                       | 発生したダウンタイム        | 返金率     |
| ---------------------------------- | --------------------------- | ---------- |
| ```99.0```％以上，```99.99```%未満 | ```87.6```～```0.876```時間 | ```10```%  |
| ```95.0```％以上，```99.0```％未満 | ```438```～```87.6```時間   | ```30```%  |
| ```95.0```%未満                    | ```438```時間以上           | ```100```% |

#### ・PureCloudの場合

参考：https://jp-help.mypurecloud.com/articles/service-level-agreements/
