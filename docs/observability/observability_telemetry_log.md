---
title: 【IT技術の知見】ログ＠テレメトリー
description: ログ＠テレメトリーの知見を記録しています。
---

# ログ＠テレメトリー

## はじめに

本サイトにつきまして、以下をご認識のほど宜しくお願いいたします。

> - https://hiroki-it.github.io/tech-notebook/

<br>

## 01. ログ

### ログとは

特定の瞬間に発生したイベントが記載されたデータのこと。

> - https://newrelic.com/jp/blog/how-to-relic/metrics-events-logs-and-traces

<br>

### 構造からみた種類

#### ▼ 非構造化ログ

構造が無く、イベントの値だけが表示されたログのこと。

```bash
192.168.0.1 [2021-01-01 12:00:00] GET /foo/1 200
```

#### ▼ 構造化ログ

イベントの項目名と値の対応関係を持つログのこと。

JSON型で表すが、拡張子が`json`であるというわけでないことに注意する。

```yaml
{
  "client_ip": "192.168.0.1",
  "timestamp": "2021-01-01 12:00:00",
  "method": "GET",
  "url": "/foo/1",
  "status_code": 200,
}
```

<br>

## 02. ログ収集方式

### Distributed logging (分散ロギング)

マイクロサービスアーキテクチャの各サービスから収集したログを、バラバラに分析/管理する。

> - https://www.splunk.com/en_us/data-insider/what-is-distributed-tracing.html#centralized-logging

<br>

### Centralized logging (集中ロギング)

マイクロサービスアーキテクチャの各サービスから収集したログを、一元的に分析/管理する。

各コンテナ (例：マイクロサービス、サービスメッシュサイドカー) が作成するログに一意なIDを割り当て、人繋ぎに紐付ける必要がある。

例えば、監視バックエンドでこのログをクエリしさえすれば、リクエストの経路がわかる。

```bash
# Cloud Loggingでログをクエリする
jsonPayload.traceId="<トレースID>"
```

> - https://www.splunk.com/en_us/data-insider/what-is-distributed-tracing.html#centralized-logging

<br>

## 03. ログのフィールド

### 一覧

#### ▼ フロントエンド

| フィールド | 値                                                            |
| ---------- | ------------------------------------------------------------- |
| ペイロード | タイムスタンプ、 ログメッセージ、リクエストの各ヘッダー値など |
| ラベル     | 実行環境名など                                                |

#### ▼ バックエンド

| フィールド | 値                                                                                                                                                                                                                                                         |
| ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ペイロード | タイムスタンプ、 ログステータス、ログメッセージ、エラーコード、トレースID、スパンID、親スパンID、サーバー/クライアントのIPアドレス、ユーザーエージェント、ステータスコード、その他セキュリティ上問題ないID (トランザクションID、相関ID、リクエストID) など |
| ラベル     | 実行環境名、リージョン名、Cluster名、Node名、Namespace名、Pod名、マイクロサービス名、コンテナ名など                                                                                                                                                        |

> - https://qiita.com/kawasima/items/569a06c934e8f81e731d

#### ▼ インフラ

| フィールド | 値                                                                                                  |
| ---------- | --------------------------------------------------------------------------------------------------- |
| ペイロード | タイムスタンプ、OSイベント、ミドルウェアイベント、セキュリティイベントなど                          |
| ラベル     | 実行環境名、リージョン名、Cluster名、Node名、Namespace名、Pod名、マイクロサービス名、コンテナ名など |

<br>

### ログメッセージ

ログメッセージは文章ではないため、ピリオドや句点はつけない。

> - https://github.com/olsh/resharper-structured-logging/discussions/28#discussioncomment-676481

<br>

### ログレベル

#### ▼ FATAL

重要度が最も高いログレベルである。

重要なビジネス機能が動作しなくなったことを表す。

以下のような場合にFATALとする。

- アプリに必要不可欠な外部依存システム (例：DB、APIなど) が動作しなくなった場合
- サーバーのディスク容量やメモリが不足し、アプリケーションが停止したり応答しなくなった場合
- セキュリティ侵害や機密データへの不正アクセスを検出した場合

> - https://sematext.com/blog/logging-levels/

#### ▼ ERROR

重要度が高いログレベルである。

重要なビジネス機能は動作しているが、その他の一部が動作しなくなったことを表す。

以下のような場合にERRORレベルとする。

- アプリケーションの機能に影響を与える外部依存システム (例：DB、APIなど) で障害が起こった場合
- 接続のタイムアウトやDNS解決の失敗などのネットワーク接続で問題が起こった場合
- アプリケーションのCRUD処理に失敗した場合
- JSONオブジェクトのデコードに失敗した場合

> - https://sematext.com/blog/logging-levels/

#### ▼ WARNING

全体としてビジネス機能は動作しているが、動作しなくなる可能性があることを表す。

以下のような場合にWARNINGレベルとする。

- リトライで回復の可能性があるエラー (例：ネットワーク接続の問題など) の場合
- ハードウェアリソースの閾値を超えそうな場合
- アプリケーションの機能に影響を与える外部依存システム (例：DB、APIなど) のレスポンス速度が閾値を超えている場合
- 推奨の設定になっていない場合
- 脆弱性がある場合

> - https://sematext.com/blog/logging-levels/

#### ▼ INFO

全体としてビジネス機能は動作しており、イベントが起こったことを表す。

以下のような場合にINFOレベルとする。

- イベントの変化 (例：`PENDING`イベントから`IN PROGRESS`イベントへの移行など) が起こった場合
- アプリケーションの機能に影響を与える外部依存システム (例：DB、APIなど) でイベントが起こった場合

> - https://sematext.com/blog/logging-levels/

#### ▼ DEBUG

開発者が開発しやすくするための詳細な情報を含むイベントが起こったことを表す。

詳細な情報を持つ、アプリケーションのパフォーマンスに影響が出るため、本番環境では無効にしておく。

- アプリケーションのイベントに関する詳細情報
- 外部依存システム (例：DB、APIなど) の送信 (例：リクエスト、クエリ) と受信 (例：レスポンス、DBレコード) の詳細情報

> - https://sematext.com/blog/logging-levels/

<br>
