---
title: 【IT技術の知見】可観測性
description: 可観測性の知見を記録しています。
---

# 可観測性

## はじめに

本サイトにつきまして、以下をご認識のほど宜しくお願いいたします。

> - https://hiroki-it.github.io/tech-notebook/

<br>

## 01. 可観測性

### 可観測性とは

![observality_and_monitoring](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/observality_and_monitoring.png)

『収集されたデータから、システムと想定内と想定外 (想定できない) の両方の不具合を、どれだけ正確に推測できるか』を表す程度のこと。

システムの想定内の不具合は『監視』や『テスト (ホワイトボックステスト、ブラックボックステスト) 』によって検知できるが、想定外のものを検知できない。

可観測性は、監視やテストも含むスーパーセットであり、想定内の不具合のみでなく、想定外の不具合も表面化する。

想定外の不具合はインシデントの原因になるため、想定外の不具合の表面化はインシデントの予防につながる。

> - https://blog.thundra.io/observability-driven-development-for-serverless
> - https://sookocheff.com/post/architecture/testing-in-production/
> - https://www.sentinelone.com/blog/observability-production-systems-why-how/
> - https://kakakakakku.hatenablog.com/entry/2020/05/25/064548

<br>

### 可観測性を高める方法

#### ▼ マイクロサービスアーキテクチャの場合

テレメトリーを十分に収集し、これらを紐付けて可視化する必要がある。

#### ▼ モノリシックアーキテクチャにおける可観測性

可観測性は、基本的にマイクロサービスアーキテクチャの文脈で語られる。

モノリシックでどのようにして可観測性を高めるのかを記入中... (情報が全然見つからない)

<br>

## 02. テレメトリー

### テレメトリーとは

可観測性を実現するために収集する必要のあるデータ要素 (『メトリクス』『ログ』『分散トレース』) のこと。

NewRelicやDatadogはテレメトリーの要素を全て持つ。

また、AWSではCloudWatch (メトリクス+ログ) とX-Ray (分散トレース) を両方利用すると、これらの要素を満たせたことになり、可観測性を実現できる。

> - https://www.forbes.com/sites/andythurai/2021/02/02/aiops-vs-observability-vs-monitoringwhat-is-the-difference-are-you-using-the-right-one-for-your-enterprise/
> - https://knowledge.sakura.ad.jp/26395/

<br>

### 計装 (インスツルメント化)

システムを、テレメトリーを収集できるような状態にすること。

計装するためには、メトリクス収集用のツール、ロギングパッケージ、分散トレースのためのリクエストIDの付与、などを用意する必要がある。

多くの場合、各テレメトリーの収集ツールは別々に用意する必要があるが、OpenTelemetryではこれらの収集機能をフレームワークとして提供しようとしている。

> - https://syu-m-5151.hatenablog.com/entry/2022/07/12/115434
> - https://www.splunk.com/en_us/data-insider/what-is-opentelemetry.html

<br>

## 03. メトリクスの設計

### メトリクスの種類

どのような種類のメトリクスのデータポイントを収集するかについては、監視の種類ごとに異なる。

<br>

## 04. ログの設計

### ログレベル

#### ▼ FATAL

重要度が最も高いログレベルである。

重要なビジネス機能が動作しなくなったことを表す。

以下のような場合にFATALとする。

- アプリに必要不可欠な外部依存システム（例：DB、API、など) が動作しなくなった場合
- サーバーのディスク容量やメモリが不足し、アプリが停止したり応答しなくなった場合
- セキュリティ侵害や機密データへの不正アクセスを検出した場合

> - https://sematext.com/blog/logging-levels/

#### ▼ ERROR

重要度が高いログレベルである。

重要なビジネス機能は動作しているが、その他の一部が動作しなくなったことを表す。

以下のような場合にERRORレベルとする。

- アプリの機能に影響を与える外部依存システム (例：DB、API、など) で障害が起こった場合
- 接続のタイムアウトやDNS解決の失敗などのネットワーク接続で問題が起こった場合
- アプリのCRUD処理に失敗した場合
- JSONオブジェクトのデコードに失敗した場合

> - https://sematext.com/blog/logging-levels/

#### ▼ WARNING

全体としてビジネス機能は動作しているが、動作しなくなる可能性があることを表す。

以下のような場合にWARNINGレベルとする。

- リトライで回復の可能性があるエラー (例：ネットワーク接続の問題、など) の場合
- ハードウェアリソースの閾値を超えそうな場合
- アプリの機能に影響を与える外部依存システム (例：DB、API、など) のレスポンス速度が閾値を超えている場合
- 推奨の設定になっていない場合
- 脆弱性がある場合

> - https://sematext.com/blog/logging-levels/

#### ▼ INFO

全体としてビジネス機能は動作しており、イベントが起こったことを表す。

以下のような場合にINFOレベルとする。

- イベントの変化 (例：`PENDING`イベントから`IN PROGRESS`イベントへの移行など) が起こった場合
- アプリの機能に影響を与える外部依存システム (例：DB、API、など) でイベントが起こった場合

> - https://sematext.com/blog/logging-levels/

#### ▼ DEBUG

開発者が開発しやすくするための詳細な情報を含むイベントが起こったことを表す。

詳細な情報を持つ、アプリのパフォーマンスに影響が出るため、本番環境では無効にしておく。

- アプリのイベントに関する詳細情報
- 外部依存システム (例：DB、API、など) の送信 (例：リクエスト、クエリ) と受信 (例：レスポンス、DBレコード) の詳細情報

> - https://sematext.com/blog/logging-levels/

<br>

### ログの種類

どのような種類のログを収集するかについては、監視の種類ごとに異なる。

<br>

### ログの持つ情報

#### ▼ フロントエンド

| 内容           | 値                                                              |
| -------------- | --------------------------------------------------------------- |
| イベントの内容 | タイムスタンプ、 ログメッセージ、リクエストの各ヘッダー値、など |
| ラベル         | 実行環境名、など                                                |

#### ▼ バックエンド

| 内容           | 値                                                                                                    |
| -------------- | ----------------------------------------------------------------------------------------------------- |
| イベントの内容 | タイムスタンプ、 ログステータス、ログメッセージ、エラーコード、トレースID、スパンID、親スパンID、など |
| ラベル         | 実行環境名、リージョン名、Cluster名、Node名、Namespace名、Pod名、マイクロサービス名、コンテナ名、など |

#### ▼ インフラ

| 内容           | 値                                                                                                    |
| -------------- | ----------------------------------------------------------------------------------------------------- |
| イベントの内容 | タイムスタンプ、OSイベント、ミドルウェアイベント、セキュリティイベント、など                          |
| ラベル         | 実行環境名、リージョン名、Cluster名、Node名、Namespace名、Pod名、マイクロサービス名、コンテナ名、など |

<br>

<br>

## 05. 分散トレースの基になるスパンの設計

### スパンの持つ情報

| 領域         | 内容           | 値                                                                                                                                         |
| ------------ | -------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| バックエンド | イベントの内容 | トレースID、スパンID、親スパンID、処理の開始時間、処理の所要時間、エラーの有無、マイクロサービスの役割名、コールされたエンドポイント、など |
|              | ラベル         | マイクロサービス名、など                                                                                                                   |

> - https://speakerdeck.com/hiroki_hasegawa/ke-guan-ce-xing-niru-men-siyou?slide=17

<br>

## 06. テレメトリー間の紐付け

### メトリクスと分散トレースの紐付け

記入中...

<br>

### ログと分散トレースの紐付け

記入中...

<br>

## 07. プロファイルの用途

分散トレースだけではマイクロサービス間のレスポンスタイムしかわからない。

プロファイルを導入すると、各マイクロサービスのハードウェアリソース消費量もわかるようになる。

これにより、性能デグレーションのボトルネックを特定しやすくなる。

<br>

## 08. その他のテレメトリー

メトリクス/ログ/分散トレース/プロファイルに加えて、新しいテレメトリーがいくつか提唱されている。

- Events (ドメインイベントのようなユーザー定義の処理イベント)
- Exception

> - https://medium.com/@YuriShkuro/temple-six-pillars-of-observability-4ac3e3deb402
> - https://www.appdynamics.com/ja_jp/topics/what-is-open-telemetry#~1-what-is-opentelemetry

<br>
