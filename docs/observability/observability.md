---
title: 【IT技術の知見】可観測性
description: 可観測性の知見を記録しています。
---

# 可観測性

## はじめに

本サイトにつきまして、以下をご認識のほど宜しくお願いいたします。

> - https://hiroki-it.github.io/tech-notebook/

<br>

## 01. 可観測性

### 可観測性とは

![observality_and_monitoring](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/observality_and_monitoring.png)

『収集されたデータから、システムと想定内と想定外 (想定できない) の両方の不具合を、どれだけ正確に推測できるか』を表す程度のこと。

システムの想定内の不具合は『監視』や『テスト (ホワイトボックステスト、ブラックボックステスト) 』によって検知できるが、想定外のものを検知できない。

可観測性は、監視やテストも含むスーパーセットであり、想定内の不具合のみでなく、想定外の不具合も表面化する。

想定外の不具合はインシデントの原因になるため、想定外の不具合の表面化はインシデントの予防につながる。

> - https://blog.thundra.io/observability-driven-development-for-serverless
> - https://sookocheff.com/post/architecture/testing-in-production/
> - https://www.sentinelone.com/blog/observability-production-systems-why-how/
> - https://kakakakakku.hatenablog.com/entry/2020/05/25/064548

<br>

### 可観測性を高める方法

#### ▼ マイクロサービスアーキテクチャの場合

テレメトリーを十分に収集し、これらを紐付けて可視化する必要がある。

#### ▼ モノリシックアーキテクチャにおける可観測性

可観測性は、基本的にマイクロサービスアーキテクチャの文脈で語られる。

モノリシックでどのようにして可観測性を高めるのかを記入中... (情報が全然見つからない)

<br>

## 02. テレメトリー

### テレメトリーとは

可観測性を実現するために収集する必要のあるデータ要素 (『メトリクス』『ログ』『分散トレース』) のこと。

NewRelicやDatadogはテレメトリーの要素を全て持つ。

また、AWSではCloudWatch (メトリクス+ログ) とX-Ray (分散トレース) を両方利用すると、これらの要素を満たせたことになり、可観測性を実現できる。

> - https://www.forbes.com/sites/andythurai/2021/02/02/aiops-vs-observability-vs-monitoringwhat-is-the-difference-are-you-using-the-right-one-for-your-enterprise/
> - https://knowledge.sakura.ad.jp/26395/

<br>

### 計装 (インスツルメント化)

システムを、テレメトリーを収集できるような状態にすること。

計装するためには、メトリクス収集用のツール、ロギングパッケージ、分散トレースのためのリクエストIDの付与、などを用意する必要がある。

多くの場合、各テレメトリーの収集ツールは別々に用意する必要があるが、OpenTelemetryではこれらの収集機能をフレームワークとして提供しようとしている。

> - https://syu-m-5151.hatenablog.com/entry/2022/07/12/115434
> - https://www.splunk.com/en_us/data-insider/what-is-opentelemetry.html

<br>

## 03. メトリクスの設計

### メトリクスの種類

どのような種類のメトリクスのデータポイントを収集するかについては、監視の種類ごとに異なる。

<br>

## 04. ログの設計

### ログレベル

#### ▼ FATAL

アプリケーションでイベントが発生したり、重要なビジネス機能の1つが動作しない状態になったことを示すログレベル。

このログレベルは、アプリケーションがデータベースのような重要なデータストアに接続できない場合や、データの破損や他の有害な影響を防ぐために、アプリケーションをシャットダウンする直前に記録される

- アプリケーションのコア操作に必要不可欠な外部依存関係やサービス（データベースなど）の喪失
- サーバーのディスク容量やメモリが不足し、アプリケーションが停止したり応答しなくなったりする場合
- セキュリティ侵害や機密データへの不正アクセスが検出された場合。

> - https://sematext.com/blog/logging-levels/

#### ▼ ERROR

特定の操作の実行を妨げるアプリケーション内のエラー状態を示す。ERRORログは、アプリケーションが有用な作業を継続できるため、FATALと違い同じ緊急性を持たない

しかし、アプリケーションで発生したエラーや例外のすべてを ERROR レベルでログに記録する必要はない。例えば、例外が予期された動作であり、アプリケーションの機能や性能の低下をもたらさない場合、DEBUG のような低いレベルでログに記録することができる。同様に、リトライ可能なネットワーク接続の問題など、回復の可能性があるエラーは WARN レベルでログに記録することができる。このような状態は、何度試みても回復しない場合、ERRORレベルに昇格することが可能

- アプリケーションの機能に影響を与える外部APIまたはサービスの障害（自動回復の試みが失敗した後）
- 接続のタイムアウトやDNS解決の失敗などのネットワーク通信エラー
- システム内のリソースの作成または更新に失敗した
- JSONオブジェクトのデコードに失敗するなど、予期しないエラー

> - https://sematext.com/blog/logging-levels/

#### ▼ WARNING

通常、予期せぬことが発生したことを示すが、アプリケーションは当分の間、正常に機能し続けることができる場合やアプリケーションの問題に発展する前に、速やかに対処すべき状態を示すためにも使用される。

- 事前に定義されたしきい値に近いリソース消費
- アプリケーションが大きな影響を受けることなく回復できるエラー
- 推奨プラクティスに沿っていない古い構成設定。
- 潜在的なセキュリティ脅威を示す、ログイン試行失敗の過剰回数
- 外部APIの応答時間が許容しきい値を超えている

> - https://sematext.com/blog/logging-levels/

#### ▼ INFO

アプリケーションのビジネス目的にとって重要なシステム内のイベントを捕捉する。INFOはシステムが正常に動作していることを示すためにログに記録される。

- "PENDING" から "IN PROGRESS"への移行など、操作の状態の変化
- スケジュールされたジョブやタスクが正常に完了すること
- サービスまたはアプリケーションコンポーネントの起動または停止
- アプリケーション内の重要なマイルストーンや重要なイベントの記録
- 長時間実行中のプロセスやタスクの進捗更新

> - https://sematext.com/blog/logging-levels/

#### ▼ DEBUG

デバッグ・セッション中に問題を特定するために開発者を支援ために使用される。メッセージの内容は一般的には開発者が効率的に問題を解決するための詳細な情報を含める。

主に生成されるレコードの量が多く、高負荷時にはディスクI/Oとストレージの要求が増加するため、本番環境では有効にしない。本番環境でデバッグセッションのためにDEBUGを使用しなければならない場合は、パフォーマンスへの影響を最小にするために、終了後すぐにDEBUGをオフにする。

環境変数`LOG_LEVEL`で制御できる

- データベースクエリ
  - データ検索や操作に関するパフォーマンスのボトルネックや問題を特定する
- 外部APIコールの詳細とそのレスポンス
- 設定ミスや不一致のトラブルシューティングに役立つ設定値
- 特定の操作やメソッドの実行時間などのタイミング情報

> - https://sematext.com/blog/logging-levels/

<br>

### ログの種類

どのような種類のログを収集するかについては、監視の種類ごとに異なる。

<br>

### ログの持つ情報

#### ▼ フロントエンド

| 内容           | 値                                                              |
| -------------- | --------------------------------------------------------------- |
| イベントの内容 | タイムスタンプ、 ログメッセージ、リクエストの各ヘッダー値、など |
| ラベル         | 実行環境名、など                                                |

#### ▼ バックエンド

| 内容           | 値                                                                                                    |
| -------------- | ----------------------------------------------------------------------------------------------------- |
| イベントの内容 | タイムスタンプ、 ログステータス、ログメッセージ、エラーコード、トレースID、スパンID、親スパンID、など |
| ラベル         | 実行環境名、リージョン名、Cluster名、Node名、Namespace名、Pod名、マイクロサービス名、コンテナ名、など |

#### ▼ インフラ

| 内容           | 値                                                                                                    |
| -------------- | ----------------------------------------------------------------------------------------------------- |
| イベントの内容 | タイムスタンプ、OSイベント、ミドルウェアイベント、セキュリティイベント、など                          |
| ラベル         | 実行環境名、リージョン名、Cluster名、Node名、Namespace名、Pod名、マイクロサービス名、コンテナ名、など |

<br>

<br>

## 05. 分散トレースの基になるスパンの設計

### スパンの持つ情報

| 領域         | 内容           | 値                                                                                                                                         |
| ------------ | -------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| バックエンド | イベントの内容 | トレースID、スパンID、親スパンID、処理の開始時間、処理の所要時間、エラーの有無、マイクロサービスの役割名、コールされたエンドポイント、など |
|              | ラベル         | マイクロサービス名、など                                                                                                                   |

> - https://speakerdeck.com/hiroki_hasegawa/ke-guan-ce-xing-niru-men-siyou?slide=17

<br>

## 06. テレメトリー間の紐付け

### メトリクスと分散トレースの紐付け

記入中...

<br>

### ログと分散トレースの紐付け

記入中...

<br>

## 07. プロファイルの用途

分散トレースだけではマイクロサービス間のレスポンスタイムしかわからない。

プロファイルを導入すると、各マイクロサービスのハードウェアリソース消費量もわかるようになる。

これにより、性能劣化のボトルネックを特定しやすくなる。

<br>

## 08. その他のテレメトリー

メトリクス/ログ/分散トレース/プロファイルに加えて、新しいテレメトリーがいくつか提唱されている。

- Events (ドメインイベントのようなユーザー定義の処理イベント)
- Exception

> - https://medium.com/@YuriShkuro/temple-six-pillars-of-observability-4ac3e3deb402
> - https://www.appdynamics.com/ja_jp/topics/what-is-open-telemetry#~1-what-is-opentelemetry

<br>
