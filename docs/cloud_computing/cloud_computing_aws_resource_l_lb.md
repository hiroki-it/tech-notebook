---
title: 【IT技術の知見】LB＠Lで始まるAWSリソース
description: LB＠Lで始まるAWSリソースの知見を記録しています。
---

# LB＠```L```で始まるAWSリソース

## はじめに

本サイトにつきまして、以下をご認識のほど宜しくお願いいたします。



> ↪️ 参考：https://hiroki-it.github.io/tech-notebook-mkdocs/

<br>

## 01. LB

| LB名                          | OSI階層モデルのレイヤー             | リスナーが処理できるプロトコル      | ターゲット                | リクエストヘッダー（```L7```） | パケットヘッダーのフィールド（```L4```） | セキュリティグループ |
|-------------------------------|-----------------------------|------------------------|----------------------|---------------------|--------------------------|------------|
| ALB：Application Load Balancer | ```L7```（アプリケーション層）        | HTTP、HTTPS、gRPC        | IPアドレス、インスタンス、Lambda | URL、HTTPヘッダー        | ポート番号フィールド             | 可         |
| NLB：Network Load Balancer     | ```L4```（トランスポート層）         | TCP、UDP、TLS            | IPアドレス、インスタンス、ALB    | 不可                | IPアドレスフィールド、ポート番号フィールド | 不可       |
| GLB：Gateway Load Balancer     | ```L3```（ネットワーク層）、```L4``` | IP                     | IPアドレス、インスタンス        | 不可                | IPアドレスフィールド、ポート番号フィールド | 不可       |
| CLB：Classic Load Balancer     | ```L4```、```L7```           | HTTP、HTTPS、TCP、SSL/TLS | なし                   | URL、HTTPヘッダー        | IPアドレスフィールド、ポート番号フィールド | 可         |



> ↪️ 参考：
>
> - https://aws.amazon.com/jp/elasticloadbalancing/features/
> - https://faq.support.nifcloud.com/faq/show/420?site_domain=default
> - https://www.infraexpert.com/study/tcpip8.html

<br>

## 02. ALB：Application Load Balancing

### ALBとは

クラウドリバースプロキシサーバー、かつクラウドロードバランサーとして働く。

リクエストを代理で受信し、EC2インスタンスへのアクセスをバランスよく分配することによって、サーバーへの負荷を緩和する。

![aws_alb](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/aws_alb.png)


> ↪️ 参考：https://www.slideshare.net/AmazonWebServicesJapan/application-load-balancer/24


<br>

### セットアップ

#### ▼ コンソール画面

| 設定項目   | 説明                                                                                        | 補足                                                                                                                                                                                                                   |
|------------|-------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| リスナー       | ALBに割り振るポート番号と受信するプロトコルを設定する。リバースプロキシサーバーかつロードバランサ－として、これらの通信をターゲットグループにルーティングする。 |                                                                                                                                                                                                                        |
| スキマー       | パブリックネットワークからのインバウンド通信を待ち受けるか、あるいはプライベートネットワークからのインバウンド通信を待ち受けるかを設定する。            |                                                                                                                                                                                                                        |
| セキュリティポリシー | リクエストの送信者が使用するSSL/TLSプロトコルや暗号化方式のバージョンに合わせて、ALBが受信できるこれらのバージョンを設定する。         | ・リクエストの送信者には、ブラウザ、APIにリクエストを送信する外部サービス、転送元のAWSリソース（例：CloudFrontなど）、などを含む。<br>・↪️ 参考：https://docs.aws.amazon.com/elasticloadbalancing/latest/application/create-https-listener.html#describe-ssl-policies |
| ルール        | リクエストのルーティングのロジックを設定する。                                                                   |                                                                                                                                                                                                                        |
| ターゲットグループ  | ルーティング時に使用するプロトコルと、宛先とするポート番号を設定する。                                                | ターゲットグループ内のターゲットのうち、トラフィックはヘルスチェックがOKになっているターゲットにルーティングされる。                                                                                                                                                           |
| ヘルスチェック    | ターゲットグループに属するプロトコルとアプリケーションのポート番号を指定して、定期的にリクエストを送信する。                            |                                                                                                                                                                                                                        |

#### ▼ ターゲットグループ

| ターゲットの指定方法 | 補足                              |
|----------------|-----------------------------------|
| インスタンス         | ターゲットが、EC2インスタンスでなければならない。        |
| IPアドレス         | ターゲットのパブリックIPアドレスが、静的でなければならない。 |
| Lambda         | ターゲットが、Lambdaでなければならない。           |

<br>

### ルールの設定例

| ユースケース                                                  | ポート       | IF                          | THEN                                                                           |
|---------------------------------------------------------|-----------|-----------------------------|--------------------------------------------------------------------------------|
| リクエストが```80```番ポートを指定した時に、```443```番ポートにリダイレクトしたい。 | ```80```  | それ以外の場合はルーティングされないリクエスト | ルーティング先：```https://#{host}:443/#{path}?#{query}```<br>ステータスコード：```HTTP_301``` |
| リクエストが```443```番ポートを指定した時に、ターゲットグループに転送したい。       | ```443``` | それ以外の場合はルーティングされないリクエスト | 特定のターゲットグループ                                                                 |

<br>

### ALBインスタンス

#### ▼ ALBインスタンスとは

ALBの実体で、各ALBインスタンスが異なるグローバルIPアドレスを持つ。

複数のAZにルーティングするようにALBを設定した場合、各AZにALBインスタンスが1つずつ配置される。

![alb-instance](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/alb-instance.png)


> ↪️ 参考：https://blog.takuros.net/entry/2019/08/27/075726


#### ▼ 割り当てられるIPアドレス

ALBに割り当てられるIPアドレスには、VPCのものが適用される。

そのため、EC2インスタンスのセキュリティグループでは、VPCのCIDRブロックを許可するように設定する必要がある。



#### ▼ 自動スケーリング

単一障害点にならないように、負荷が高まるとALBインスタンスが増えるように自動スケールアウトする仕組みを持つ。



#### ▼ ```500```系ステータスコードの原因

> ↪️ 参考：https://aws.amazon.com/jp/premiumsupport/knowledge-center/troubleshoot-http-5xx/

#### ▼ ALBのセキュリティグループ

Route53からルーティングされるパブリックIPアドレスを受信できるようにしておく必要がある。

パブリックネットワークに公開するサイトであれば、IPアドレスは全ての範囲（```0.0.0.0/0```と``` ::/0```）にする。

社内向けのサイトであれば、社内のプライベートIPアドレスのみ（```*.*.*.*/32```）を許可する。



<br>

### 常時SSLのアプリケーションへのルーティング

#### ▼ 問題

アプリケーションが常時SSLになっているアプリケーション（例：WordPress）の場合、ALBからアプリケーションにHTTPプロトコルでルーティングすると、HTTPSプロトコルへのリダイレクトループが発生してしまう。

常時SSLがデフォルトになっていないアプリケーションであれば、これは起こらない。



> ↪️ 参考：https://cloudpack.media/525

#### ▼ webサーバーにおける対処方法

ALBを経由したリクエストには、リクエストヘッダーに```X-Forwarded-Proto```ヘッダーが付与される。

これには、ALBに対するリクエストのプロトコルの種類が文字列で代入されている。

これが『HTTPS』だった場合、webサーバーに対するリクエストをHTTPSであるとみなすように対処する。

これにより、アプリケーションに対するリクエストのプロトコルがHTTPSとなる（こちらを行った場合は、アプリケーション側の対応不要）。


**＊実装例＊**

```apacheconf
SetEnvIf X-Forwarded-Proto https HTTPS=on
```

> ↪️ 参考：https://www.d-wood.com/blog/2017/11/29_9354.html


#### ▼ アプリケーションにおける対処方法

![ALBからEC2に対するリクエストのプロトコルをHTTPSと見なす](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/ALBからEC2に対するリクエストのプロトコルをHTTPSと見なす.png)

ALBを経由したリクエストには、リクエストヘッダーに```HTTP_X_FORWARDED_PROTO```ヘッダーが付与される。

これには、ALBに対するリクエストのプロトコルの種類が文字列で代入されている。

そのため、もしALBに対するリクエストがHTTPSプロトコルだった場合は、ALBからアプリケーションに対するリクエストもHTTPSであるとみなすように、```index.php```に追加実装を行う（こちらを行った場合は、webサーバー側の対応不要）。




**＊実装例＊**


```php
<?php
    
// index.php
if (isset($_SERVER["HTTP_X_FORWARDED_PROTO"])
    && $_SERVER["HTTP_X_FORWARDED_PROTO"] == "https") {
    $_SERVER["HTTPS"] = "on";
}
```

> ↪️ 参考：https://www.d-wood.com/blog/2017/11/29_9354.html


<br>

### ロードバランシングアルゴリズム

#### ▼ ロードバランシングアルゴリズムとは

ターゲットに対するリクエスト転送時の加重ルールを設定する。



> ↪️ 参考：https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html#application-load-balancer-overview

#### ▼ ラウンドロビン方式

受信したリクエストを、ターゲットに均等にルーティングする。



#### ▼ 最小未処理リクエスト（ファステスト）

受信したリクエストを、未処理のリクエスト数が最も少ないターゲットにルーティングする。



> ↪️ 参考：https://www.infraexpert.com/study/loadbalancer4.html

<br>

## 03. NLB：Network Load Balancer


<br>

