---
title: 【IT技術の知見】Aで始まるAWSリソース＠AWS
description: Aで始まるAWSリソース＠AWSの知見を記録しています。
---

# `A`で始まるAWSリソース＠AWS

## はじめに

本サイトにつきまして、以下をご認識のほど宜しくお願いいたします。

> ↪️ 参考：https://hiroki-it.github.io/tech-notebook/

<br>

## 01. AWSアカウント、リージョン、AZ

### AWSアカウント

AWSリソースの操作単位である。

Webサイトのクラウドインフラの実行環境ごとに作成したほうが良い。

アカウントIDは機密ではないため、仮にバージョン管理してしまうようなことがあっても問題ない。

> ↪️ 参考：
>
> - https://docs.aws.amazon.com/accounts/latest/reference/accounts-welcome.html
> - https://www.lastweekinaws.com/blog/are-aws-account-ids-sensitive-information/

<br>

### リージョン

#### ▼ リージョンとは

物理サーバーのあるデータセンターの地域名のこと。

#### ▼ グローバルサービス

グローバルサービスは、物理サーバーが世界中にあり、これらの間ではパブリックネットワークが作成されている。

そのため、特定のリージョンに依存せずに、全てのリージョンと連携できる。

![edge-location](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/edge-location.png)

<br>

### AZ：Availability Zones

#### ▼ AZとは

リージョンは、各データセンターは物理的に独立したAZというロケーションから構成されている。

例えば、東京リージョンには、`3`個のAZ (`a`、`c`、`d`) がある。

AZに跨いで冗長化すると、いずれかのデータセンターで障害が起こっても、残ったAZ上でシステムを稼働し続けられる (可用性を高められる) 。

もし、AZを跨いで作成できないようなAWSリソースの場合は、リージョンを跨ぐようにする。

<br>

## 02. Amplify

### Amplifyとは

サーバーレスアプリケーションを作成するためのクラウドインフラストラクチャのフレームワーク。

> ↪️ 参考：https://d1.awsstatic.com/webinars/jp/pdf/services/20200520_AWSBlackBelt_Amplify_A.pdf

<br>

### アーキテクチャ

#### ▼ フロントエンド

SSGの場合、静的ファイルをデプロイしさえすれば、アプリケーションとしての要件が全て整う。

SPAの場合、サーバーレスのバックエンドを自動作成してくれ、フロントエンドをデプロイしさえすれば、要件が全て整う。

これのAWSリソースはCloudFormationによって作成されるが、Amplify経由でしか設定を変更できず、各AWSリリースのコンソール画面を見ても、非表示になっている。

ただし、Route53の設定は表示されており、Amplifyが追加したDNSレコードをユーザーが編集できるようになっている。

| 役割                    | 使用されているAWSリソース |
| ----------------------- | ------------------------- |
| 静的サイトホスティング  | CloudFront、S3            |
| GraphQLによるリクエスト | S3                        |

#### ▼ バックエンド

フロントエンドでGraphQLによるリクエストを実装している場合、AppSyncを使用して、これを受信できるAPIを作成する必要がある。

| 役割                     | 使用されているAWSリソース | クリーンアーキテクチャで相当するレイヤー |
| ------------------------ | ------------------------- | ---------------------------------------- |
| リアルタイム通知         | AppSync、IoT Core         | インフラストラクチャ層                   |
| RESTful-API、GraphQL-API | API Gateway、AppSync      | インフラストラクチャ層                   |
| 認証                     | Cognito                   | インターフェース層                       |
| 認可                     | Cognito                   | ユースケース層                           |
| ビジネスロジック         | Lambda                    | ドメイン層                               |
| 全文検索                 | Elastic Search            | ドメイン層                               |

#### ▼ ストレージ

| 役割         | 使用されているAWSリソース |
| ------------ | ------------------------- |
| NoSQL        | DynamoDB                  |
| ファイル保管 | S3                        |

#### ▼ CI/CDパイプライン

Amplifyは、連携先のリポジトリからソースコードをプルし、アプリケーションをビルドする。

GitHubのブランチごとにアプリケーションのCI/CDパイプラインが発火するようにすれば、プルリクエストごとにアプリケーションの実行環境を用意できる。

プルリクごとに実行環境を作成できると、例えば、`1`個のプルリクをデザイナーサイドとビジネスサイド (例：SEOとか) が一緒にレビューできるようになる。

ただし、App Runnerを使用した方がよいかもしれない。

> ↪️ 参考：
>
> - https://zenn.dev/intercept6/articles/4016e9d61ab36761685d
> - https://devblog.thebase.in/entry/2021/12/22/110000

<br>

## 02-02. セットアップ

### コンソール画面の場合

#### ▼ 設定項目と説明

| 項目                   | 説明                                                   | 補足                                                                                                                                                                  |
| ---------------------- | ------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| アプリケーションの名前 | Amplify上でのアプリケーション名を設定する。            |                                                                                                                                                                       |
| 本番稼働ブランチ       | 基点ブランチを設定する。                               | Amplifyを本番運用しない場合は、`develop`ブランチを設定すれば良い。                                                                                                    |
| ブランチの自動検出     | ブランチの自動検出を有効化するか否かを設定する。       | ワイルドカード (`*`) を組み込む場合、アスタリスクを2つ割り当てないと、ブランチが検知されないことがある。例：『`**foo**,**bar**`』                                     |
| プレビュー             | GitHubのプルリクエスト上にAmplify環境のURLを通知する。 | 執筆時点 (2021/02/07) では、プルリクエストを新しく作成しても、これは自動的に登録されない。そのため、その都度手動で登録する必要がある。                                |
| アクセスコントロール   | Amplify環境に認証機能を設定する。                      | 執筆時点 (2021/02/07) では、Basic認証を使用できる。                                                                                                                   |
| リダイレクト           | リダイレクトするパスを設定する。                       | `404`ステータスで404ページにリダイレクトする場合は、以下の通りに設定する。<br>・送信元：`/<*>`<br>・ターゲットアドレス：`<404ページへのパス>`<br>・404 (リダイレクト) |

<br>

### 手動ビルド＆デプロイ

#### ▼ 開発環境で擬似再現

サーバーレスアプリケーションを開発環境で再現する。

```bash
$ amplify mock api
```

#### ▼ 開発環境から手動でビルド&デプロイ

開発/ステージング/本番環境に切り替える必要がある。

```bash
# アプリケーションの設定
$ amplify add hosting

# ビルド&デプロイ
$ amplify publish
```

<br>

### 自動ビルド&デプロイ

#### ▼ 連携できるバージョン管理システム

> ↪️ 参考：https://docs.aws.amazon.com/amplify/latest/userguide/getting-started.html#step-1-connect-repository

#### ▼ 対応するバージョン管理リポジトリ構造

| 構造名           | ビルド開始ディレクトリ                         |
| ---------------- | ---------------------------------------------- |
| 非モノリポジトリ | リポジトリ名からなるディレクトリ               |
| モノリポジトリ   | モノリポジトリの各アプリケーションディレクトリ |

#### ▼ `amplify.yml`ファイル

バージョン管理リポジトリのルートに`amplify.yml`ファイルを配置する。

Next.jsではSSG/SSRの両モードでビルド＆デプロイできる。

`package.json`ファイルで使用される`next`コマンドに応じて、SSGまたはSSRのいずれかのインフラが作成され、デプロイされる。

SSGの場合、裏側ではS3、CloudFront、Route53などが作成され、静的ホスティングが実行される。

SSRの場合、フロントエンドのみでなくバックエンドの実行環境が必要になるため、LambdaやCogniteが作成される。

```yaml
version: 1

#=====================
# 環境変数
#=====================
env:
  variables:
    key: # 環境変数のハードコーディング

#=====================
# バックエンドのCI/CDパイプライン
#=====================
backend:
  phases:
    preBuild:
      commands:
        -  # コマンド
    build:
      commands:
        -  # コマンド
    postBuild:
      commands:
        -  # コマンド

#=====================
# フロントエンドのCI/CDパイプライン
#=====================
frontend:
  phases:
    preBuild:
      commands:
        - npm install
        # base64方式のエンコード値をデコード
        - echo "$ENV" | base64 -d > .env
        - cat .env
    build:
      commands:
        - nuxt generate --fail-on-error
        - ls -la ./dist
  artifacts:
    # デプロイ先のディレクトリ
    files:
      # 全てのディレクトリ
      - "**/*"
    discard-paths: yes
    # ビルドのアーティファクトを配置するディレクトリ
    baseDirectory: dist
  # 指定したディレクトリのキャッシュを作成
  cache:
    paths:
      - node_modules/**/*

#=====================
# ホワイトボックステスト
#=====================
test:
  phases:
    preTest:
      commands:
        -  # コマンド
    test:
      commands:
        -  # コマンド
    postTest:
      commands:
        -  # コマンド
  artifacts:
    # デプロイ先のディレクトリ
    files:
      # 全てのディレクトリ
      - "**/*"
    configFilePath: <パス>
    # ビルドのアーティファクトのディレクトリ
    baseDirectory: <パス>
```

> ↪️ 参考：
>
> - https://docs.aws.amazon.com/amplify/latest/userguide/build-settings.html
> - https://docs.aws.amazon.com/amplify/latest/userguide/server-side-rendering-amplify.html#deploy-nextjs-app

<br>

## 03. オートスケーリング

### オートスケーリングとは

ALBを使用して、起動テンプレートを基にしたEC2インスタンスの自動水平スケーリングを実行する。

注意点として、オートスケーリングに紐付けるALBでは、ターゲットを登録する必要はなく、起動テンプレートに応じたインスタンスが自動的に登録される。

言い換えると、オートスケーリングにターゲットグループを紐付けて初めて、ターゲットにルーティングできるようになる。

![Auto-scaling](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/Auto-scaling.png)

> ↪️ 参考：https://www.a-frontier.jp/technology/aws10/

<br>

## 03-03. セットアップ

### コンソール画面の場合

#### ▼ 設定項目と説明

| 項目                 | 説明                                                                                                 | 補足                                                                                              |
| -------------------- | ---------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------- |
| スケーリンググループ | スケーリングのグループ構成を定義する。各グループで最大最小必要数を設定できる。                       |                                                                                                   |
| 起動テンプレート     | スケーリングで起動するインスタンスの詳細 (例：マシンイメージ、インスタンスタイプ、など) を設定する。 |                                                                                                   |
| ネットワーク         | いずれのAZのサブネットでインスタンスを作成するかを設定する。                                         | 選択したAZの個数よりも少ない個数のEC2インスタンスを作成する場合、作成先のAZをランダムに選択する。 |
| スケーリングポリシー | スケーリングの方法を設定する。                                                                       |                                                                                                   |

<br>

### Terraformの場合

#### ▼ 起動テンプレート

```terraform
resource "aws_launch_template" "foo" {

  name = "foo-instance"

  block_device_mappings {
    device_name = "/dev/sdf"

    ebs {
      volume_size = 20
    }
  }

  cpu_options {
    core_count       = 4
    threads_per_core = 2
  }

  ebs_optimized = true

  iam_instance_profile {
    name = aws_iam_role.instance_iam_role.name
  }

  # 最適化AMIを使用する
  image_id = "ami-*****"

  instance_market_options {
    market_type = "spot"
  }

  instance_type = "t2.micro"

  metadata_options {
    http_endpoint               = "enabled"
    http_tokens                 = "required"
    http_put_response_hop_limit = 1
    instance_metadata_tags      = "enabled"
  }

  monitoring {
    enabled = true
  }

  network_interfaces {
    associate_public_ip_address = true
    security_groups = [
      "sg-*****",
      "sg-*****",
      "sg-*****",
    ]
  }

  tag_specifications {
    resource_type = "instance"

    tags = {
      Name = "test"
    }
  }

  user_data = base64encode(templatefile(
    "${path.module}/templates/userdata.sh.tpl",
    {}
  ))
}
```

<br>

### シンプルスケーリング

#### ▼ シンプルスケーリングとは

特定のメトリクスに単一の閾値を設定し、それに応じてスケールアウトとスケールインを行う。

<br>

### ステップスケーリング

#### ▼ ステップスケーリングとは

特定のメトリクスに段階的な閾値を設定し、それに応じて段階的にスケールアウトを実行する。

スケールアウトの実行条件となる閾値期間は、CloudWatchメトリクスの連続期間として設定できる。

AWSとしては、ターゲット追跡スケーリングの使用を推奨している。

**＊例＊**

CPU平均使用率に段階的な閾値を設定する。

- 40%の時にEC2インスタンスが1つスケールアウト
- `70`%の時にEC2インスタンスを2つスケールアウト
- `90`%の時にEC2インスタンスを`3`個スケールアウト

#### ▼ ECSの場合

記入中...

> ↪️ 参考：https://docs.aws.amazon.com/AmazonECS/latest/userguide/service-autoscaling-stepscaling.html

<br>

### ターゲット追跡スケーリング

#### ▼ ターゲット追跡スケーリングとは

特定のメトリクス (CPU平均使用率やメモリ平均使用率) にターゲット値を設定し、それに収束するように自動的にスケールインとスケールアウトを実行する。

ステップスケーリングとは異なり、スケーリングの実行条件となる閾値期間を設定できない。

**＊例＊**

- ECSサービスのECSタスク数
- DBクラスターのAuroraのリードレプリカ数
- Lambdaのスクリプト同時実行数

#### ▼ ECSの場合

ターゲット値の設定に応じて、自動的にスケールアウトやスケールインが起こるシナリオ例を示す。

`【１】`

: 最小ECSタスク数を`2`、必要ECSタスク数を`4`、最大数を`6`、CPU平均使用率を`40`%に設定する例を考える。

`【２】`

: 平常時、CPU使用率`40`%に維持される。

`【３】`

: リクエストが増加し、CPU使用率`55`%に上昇する。

`【４】`

: ECSタスク数が`6`個にスケールアウトし、CPU使用率`40`%に維持される。

`【５】`

: リクエスト数が減少し、CPU使用率が`20`%に低下する。

`【６】`

: ECSタスク数が`2`個にスケールインし、CPU使用率`40`%に維持される。

| 設定項目                           | 説明                                                                                                  | 補足                                                                                                                                                                                                                              |
| ---------------------------------- | ----------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ターゲット追跡スケーリングポリシー | 監視対象のメトリクスがターゲット値を超過しているか否かを基に、ECSタスク数のスケーリングが実行される。 |                                                                                                                                                                                                                                   |
| ECSサービスメトリクス              | 監視対象のメトリクスを設定する。                                                                      | 『平均CPU』、『平均メモリ』、『ECSタスク当たりのALBからのリクエスト数』を監視できる。SLIに対応するCloudWatchメトリクスも参考にせよ。                                                                                              |
| ターゲット値                       | ECSタスク数のスケーリングが実行される収束値を設定する。                                               | ターゲット値を超過している場合、ECSタスク数がスケールアウトされる。反対に、ターゲット値未満 (正確にはターゲット値の`90`%未満) の場合、ECSタスク数がスケールインされる。                                                           |
| スケールアウトクールダウン期間     | スケールアウトを完了してから、次回のスケールアウトを発動できるまでの時間を設定する。                  | ・期間を短くし過ぎると、ターゲット値を超過する状態が断続的に続いた場合、余分なスケールアウトが連続して実行されてしまうため注意する。<br>・期間を長く過ぎると、スケールアウトが不十分になり、ECSの負荷が緩和されないため注意する。 |
| スケールインクールダウン期間       | スケールインを完了してから、次回のスケールインを発動できるまでの時間を設定する。                      |                                                                                                                                                                                                                                   |
| スケールインの無効化               |                                                                                                       |                                                                                                                                                                                                                                   |

> ↪️ 参考：https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-autoscaling-targettracking.html

<br>

### スケーリングなし

#### ▼ スケーリングなしとは

ややわかりにくい機能名であるが、スケジューリングスケーリングと予測スケーリングを指す。

負荷に合わせて動的にスケーリングするのではなく、一定の間隔で規則的にスケーリングする。

> ↪️ 参考：
>
> - https://blog.takuros.net/entry/2020/08/11/082712
> - https://docs.aws.amazon.com/autoscaling/ec2/userguide/ec2-auto-scaling-scheduled-scaling.html

<br>
