---
title: 【IT技術の知見】セキュリティ＠AWS
description: セキュリティ＠AWSの知見を記録しています。
---

# セキュリティ＠AWS

## はじめに

本サイトにつきまして、以下をご認識のほど宜しくお願いいたします。

> ℹ️ 参考：https://hiroki-it.github.io/tech-notebook-mkdocs/about.html

<br>

## 01. ファイアウォール設計

### セキュリティグループ（インバウンド）の設計

#### ▼ アプリケーションEC2の場合

ALBに割り振られる可能性のあるIPアドレスを許可するために、ALBのセキュリティグループID、またはサブネットのCIDRブロックを設定する。

| タイプ | プロトコル | ポート    | ソース                            | 説明                        |
| ------ | ---------- | --------- | --------------------------------- | --------------------------- |
| HTTP   | TCP        | ```80```  | ALBのセキュリティグループID       | HTTP access from ALB        |
| HTTPS  | TCP        | ```443``` | 踏み台EC2のセキュリティグループID | SSH access from bastion EC2 |

#### ▼ 踏み台EC2の場合

| タイプ | プロトコル | ポート   | ソース                     | 説明                              |
| ------ | ---------- | -------- | -------------------------- | --------------------------------- |
| SSH    | TCP        | ```22``` | 社内のグローバルIPアドレス | SSH access from global ip address |

#### ▼ EFSの場合

EC2に割り振られる可能性のあるIPアドレスを許可するために、EC2のセキュリティグループID、またはサブネットのCIDRブロックを設定する。

| タイプ | プロトコル | ポート     | ソース                      | 説明                    |
| ------ | ---------- | ---------- | --------------------------- | ----------------------- |
| NFS    | TCP        | ```2049``` | EC2のセキュリティグループID | NFS access from app EC2 |

#### ▼ RDSの場合

EC2に割り振られる可能性のあるIPアドレスを許可するために、EC2のセキュリティグループID、またはサブネットのCIDRブロックを設定する。

| タイプ       | プロトコル | ポート     | ソース                      | 説明                      |
| ------------ | ---------- | ---------- | --------------------------- | ------------------------- |
| MYSQL/Aurora | TCP        | ```3306``` | EC2のセキュリティグループID | MYSQL access from app EC2 |

#### ▼ Redisの場合

EC2に割り振られる可能性のあるIPアドレスを許可するために、EC2のセキュリティグループID、またはサブネットのCIDRブロックを設定する。

| タイプ      | プロトコル | ポート     | ソース                      | 説明                    |
| ----------- | ---------- | ---------- | --------------------------- | ----------------------- |
| カスタムTCP | TCP        | ```6379``` | EC2のセキュリティグループID | TCP access from app EC2 |

#### ▼ ALBの場合

CloudFrontと連携する場合、CloudFrontに割り振られる可能性のあるIPアドレスを許可するために、全てのIPアドレスを許可する。代わりに、CloudFrontにWAFを紐付け、ALBの前でIPアドレスを制限する。CloudFrontとは連携しない場合、ALBのセキュリティグループでIPアドレスを制限する。

| タイプ | プロトコル | ポート    | ソース          | 説明                         |      |
| ------ | ---------- | --------- | --------------- | ---------------------------- | ---- |
| HTTP   | TCP        | ```80```  | ```0.0.0.0/0``` | HTTP access from CloudFront  |      |
| HTTPS  | TCP        | ```443``` | ```0.0.0.0/0``` | HTTPS access from CloudFront |      |

#### ▼ NLBの場合

NLBはセキュリティグループに対応していない。そのため、NLBのルーティング先（EC2、など）でファイアーウォールを設定する必要がある。

<br>

### セキュリティグループ（アウトバウンド）の設計

#### ▼ ALBの場合

ALBからEC2にインバウンド通信をルーティングする場合、特定のEC2のみへのルーティングを許可するために、アウトバウンドのルールでEC2のセキュリティグループIDを設定する。

> ℹ️ 参考：https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-update-security-groups.html#security-group-recommended-rules

| タイプ | プロトコル | ポート    | 送信先                              | 説明        |
| ------ | ---------- | --------- | ----------------------------------- | ----------- |
| HTTPS  | TCP        | ```443``` | 送信先のEC2のセキュリティグループID | Full access |

<br>

## 02. クラウド型WAFの設計

### WAFルールの設計

#### ▼ ユーザーエージェント拒否

**＊例＊**

悪意のあるユーザーエージェントを拒否する。

ルール：```block-user-agents```

| Statementの順番 | If a request  | Inspect        | Match type                                   | Regex pattern set | Then  | 挙動                                                         |
| --------------- | ------------- | -------------- | -------------------------------------------- | ----------------- | ----- | ------------------------------------------------------------ |
| ```0```         | ```matches``` | ```URI path``` | ```Matches pattern from regex pattern set``` | 文字列セット      | Block | 指定した文字列を含むユーザーエージェントの場合、アクセスすることを拒否する。 |

| Default Action | 説明                                                         |
| -------------- | ------------------------------------------------------------ |
| Allow          | 指定したユーザーエージェントでない場合、全てのパスにアクセスすることを許可する。 |

#### ▼ CIツールのアクセスを許可

**＊例＊**

社内の送信元IPアドレスのみ許可した状態で、CIツール（例：CircleCI）が社内サービスにアクセスできるようにする。

ルール：```allow-request-including-access-token```

| Statementの順番 | If a request  | Inspect      | Header field name   | Match type                    | String to match                                     | Then  | 挙動                                                         |
| --------------- | ------------- | ------------ | ------------------- | ----------------------------- | --------------------------------------------------- | ----- | ------------------------------------------------------------ |
| ```0```         | ```matches``` | ```Header``` | ```authorization``` | ```Exactly matched  string``` | 『```Bearer <トークン文字列>```』で文字列を設定する | Allow | authorizationヘッダーに指定した文字列を含むリクエストの場合、アクセスすることを拒否する。 |

| Default Action | 説明                                                         |
| -------------- | ------------------------------------------------------------ |
| Block          | 正しいトークンを持たないアクセスの場合、全てのパスにアクセスすることを拒否する。 |

#### ▼ 特定のパスを社内アクセスに限定

**＊例＊**

アプリケーションでは、特定のURLパスにアクセスできる送信元IPアドレスを社内だけに制限する。```2```個のルールを作成する必要がある。

ルール：```allow-access--to-url-path```

| Statementの順番 | If a request        | Inspect                                | IP set       | Match type                                   | Regex pattern set | Then  | 挙動                                                         |
| --------------- | ------------------- | -------------------------------------- | ------------ | -------------------------------------------- | ----------------- | ----- | ------------------------------------------------------------ |
| ```0```         | ```matches (AND)``` | ```Originates from an IP address in``` | 社内IPセット | -                                            | -                 | -     | 社内の送信元IPアドレスの場合、指定したパスにアクセスすることを許可する。 |
| ```1```         | ```matches```       | ```URI path```                         | -            | ```Matches pattern from regex pattern set``` | 文字列セット      | Allow | 0番目かつ、指定した文字列を含むURLパスアクセスの場合、アクセスすることを許可する。 |

ルール：```block-access-to-url-path```

| Statementの順番 | If a request  | Inspect        | Match type                                   | Regex pattern set | Then  | 挙動                                                         |
| --------------- | ------------- | -------------- | -------------------------------------------- | ----------------- | ----- | ------------------------------------------------------------ |
| ```0```         | ```matches``` | ```URI path``` | ```Matches pattern from regex pattern set``` | 文字列セット      | Block | 指定した文字列を含むURLパスアクセスの場合、アクセスすることを拒否する。 |

| Default Action | 説明                                                         |
| -------------- | ------------------------------------------------------------ |
| Allow          | 指定したURLパス以外のアクセスの場合、そのパスにアクセスすることを許可する。 |

#### ▼ 社内アクセスに限定

**＊例＊**

アプリケーション全体にアクセスできる送信元IPアドレスを、特定のIPアドレスだけに制限する。

ルール：```allow-global-ip-addresses```

| Statementの順番 | If a request        | Inspect                                | IP set           | Originating address | Then  | 挙動                                                         |
| --------------- | ------------------- | -------------------------------------- | ---------------- | ------------------- | ----- | ------------------------------------------------------------ |
| ```0```         | ```matches  (OR)``` | ```Originates from an IP address in``` | 社内IPセット     | Source IP address   | -     | 社内の送信元IPアドレスの場合、全てのパスにアクセスすることを許可する。 |
| ```1```         | ```matches```       | ```Originates from an IP address in``` | 協力会社IPセット | Source IP address   | Allow | 0番目あるいは、協力会社の送信元IPアドレスの場合、全てのパスにアクセスすることを許可する。 |

| Default Action | 説明                                                         |
| -------------- | ------------------------------------------------------------ |
| Block          | 指定した送信元IPアドレス以外の場合、全てのパスにアクセスすることを拒否する。 |

#### ▼ ALBを直接的に指定することを防ぐ

**＊例＊**

Route53のドメイン経由ではなく、ALBの直接的に指定して、リクエストとを送信することを防ぐ。ALBのIPアドレスは定期的に変化するため、任意のIPアドレスを指定できる正規表現を定義する必要がある。

```
^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])$
```

ルール：```block-direct-access-to-lb```

| Statementの順番 | If a request  | Inspect      | Match type                                   | Regex pattern set | Then  | 挙動                                                         |
| --------------- | ------------- | ------------ | -------------------------------------------- | ----------------- | ----- | ------------------------------------------------------------ |
| ```0```         | ```matches``` | ```Header``` | ```Matches pattern from regex pattern set``` | 文字列セット      | Block | 指定した```Host```ヘッダーに対するアクセスの場合、アクセスすることを拒否する。 |

| Default Action | 説明                                                         |
| -------------- | ------------------------------------------------------------ |
| Allow          | 指定した```Host```ヘッダー以外に対するアクセスの場合、アクセスすることを許可する。 |

<br>

### WAFマネージドルールの設計

#### ▼ マネージドルールの動作確認の必要性

マネージドルールを導入する時は、事前にルールのカウント機能を使用することが推奨されている。カウントで検知されたリクエストのほとんどが悪意のないものであれば、設定したマネージドルールの使用をやめる必要がある。

#### ▼ ブラウザを送信元とした場合

ブラウザを送信元とした場合、リクエストのヘッダーやボディはブラウザによって作成されるため、これに基づいた判断が必要である。

- ブラウザからのリクエスト自体が悪意判定されているか否か
- サイトのURLの記法によって、悪意判定されているか否か
- 送信元の国名が『日本』であるのにも関わらず、悪意判定されているか否か
- サイトに送信された全リクエストのうち、カウントで検知されたリクエスト数が多すぎないか否か

#### ▼ 連携するアプリケーションを送信元とした場合

アプリケーションを送信元とした場合、リクエストのヘッダーやボディは連携するアプリケーションによって作成されるため、これに基づいた判断が必要である。

<br>
