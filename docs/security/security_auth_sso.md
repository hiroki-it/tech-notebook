---
title: 【IT技術の知見】認可＠認証/認可
description: 認可＠認証/認可の知見を記録しています。
---

# 認可＠認証/認可

## はじめに

本サイトにつきまして、以下をご認識のほど宜しくお願いいたします。

> - https://hiroki-it.github.io/tech-notebook/

<br>

## 01. SSO：Single Sign On

### SSOとは

Webサイトごとに認証フェーズと認可フェーズを行うのではなく、認証フェーズは他のWebサイトに統一的に委譲し、認可フェーズだけはWebサイトごとに実施する。

セキュリティ強度の向上というよりは、利便性の向上のために使用することが多い。

そのため別途、SSOと二要素認証などを組み合わせて、セキュリティ強度を向上させた方が良い。

二要素認証とSSOを組み合わせる場合、認証フェーズの委譲先で二要素認証を追加することになる (例：GitHubアカウントを用いたSSO時に、ワンタイムパスワードの入力も要求される) 。

> - https://www.idnetworks.co.jp/wP/2014/04/04/sso-with-2fa/

<br>

### SSOの仕組み

![sso](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/sso.jpg)

`(1)`

: APIクライアント (あるいは認証プロキシ) が、HTTPリクエストにIDとパスワードを設定し、IPプロバイダーにリクエストを送信する。

`(2)`

: IDプロバイダーが、クライアントを『認証』し、クライアント側にトークン (例：アクセストークン、IDトークン、など) を発行する。

`(3)`

: クライアントが、HTTPリクエストのヘッダーにトークンを設定してリクエストする。

`(4)`

: トークンが『認可』されれば、API側がデータをレスポンスする。

SSOには、認証フェーズと認可フェーズがあり、`3`個の役割が定義されている。

| 役割            | 説明                                                                         | 例                                          |
| --------------- | ---------------------------------------------------------------------------- | ------------------------------------------- |
| APIクライアント | APIに対して、リクエストを送信したいサーバーのこと。                          | Ouath認証の仕組みにおけるクライアント。     |
| IDプロバイダー  | トークン (例：アクセストークン、IDトークン、など) を作成するサーバーのこと。 | Ouath認証の仕組みにおける認可サーバー。     |
| APIサーバー     | クライアントに対して、リソースのレスポンスを返信するサーバーのこと。         | Ouath認証の仕組みにおけるリソースサーバー。 |

> - https://japan.zdnet.com/article/35126144/

<br>

### APIクライアント

#### ▼ IDプロバイダーとの通信

APIクライアントは、IDプロバイダーに認証情報 (例：クライアントID、クライアントシークレット、など) を送信する必要がある。

これらの認証情報はIDプロバイダーで事前に発行しておく。

ただし、APIクライアントからIDプロバイダーにこれらを直接するする代わりに、OAuthプロキシ (例：OAuth2 Proxy、など) やSSOプロキシ(例：Dex、など) に送信しても良い。

その場合、APIクライアントが認証プロキシにリクエストを送信した後、認証プロキシはIDプロバイダーからトークン (例：アクセストークン、IDトークン、など) を取得し、APIクライアントを認証する。

#### ▼ ステータスコードの選定

認証フェーズにて、誤ったトークン (例：アクセストークン、IDトークン、など) が発行されたことを表現したい場合、`401`ステータスを使用する。

認可フェーズにて、正しいトークンが発行されたが、トークンの所有者に参照権限がないことを表現したい場合、`403`ステータスを使用する。

<br>

### IDプロバイダー

#### ▼ IDプロバイダーの種類

- Auth0
- Facebook
- Keycloak
- AWS Cognito
- Google Cloud Auth

![auth0_sso](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/auth0_sso.png)

> - https://speakerdeck.com/lmi/ginzarails-vol35-presentation?slide=25

<br>
