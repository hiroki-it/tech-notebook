---
title: 【IT技術の知見】ホワイトボックステスト
description: ホワイトボックステストの知見を記録しています。
---

# ホワイトボックステスト

## はじめに

本サイトにつきまして、以下をご認識のほど宜しくお願いいたします。

> ↪️ 参考：https://hiroki-it.github.io/tech-notebook/

<br>

## 01. ホワイトボックステスト

### ホワイトボックステストとは

ブラックボックステストと組み合わせて単体テストを構成する。

実装内容が適切かを確認しながら、入力に対して、適切な出力が行われているかを検証する。

![testing_whitebox-test](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/testing_whitebox-test.png)

> ↪️ 参考：https://hldc.co.jp/blog/2018/05/25/1387/

<br>

### ホワイトボックステストの種類

ブラックボックステストと同じ名前のテストがあるが、実装内容を気にするか否かという点で、テスト内容は異なる。

- 整形
- 静的解析 (例：文法の誤りテスト 、ベストプラクティス違反テスト 、脆弱性テスト、など)
- ドライラン
- 単体テスト
- 機能テスト
- 回帰テスト

> ↪️ 参考：https://xtech.nikkei.com/it/article/Watcher/20060809/245528/

<br>

## 02. 静的解析

### 静的解析とは

#### ▼ 文法の誤りテスト

ソースコードの実行前に、字句解析、構文解析、型解析、を行い、ソースコードの文法上の問題を検証する。

ソースコードの機械語翻訳の仕組みの違いのために、コンパイラ方式言語の場合はアプリケーションの実行前に文法の誤りを検出できるが、インタプリタ方式言語は実行時でしか検出できない。

そのため、特にインタプリタ方式言語では実施した方が良い。

> ↪️ 参考：
>
> - https://golangtokyo.github.io/codelab/find-gophers/?index=codelab#5
> - https://devblog.thebase.in/entry/2018/12/24/110000

#### ▼ ベストプラクティス違反テスト

ソースコードのベストプラクティス違反を検証する。

言語によって、ビルトインのコマンド (例：`go vet`コマンド) で実現できる場合や、外部ツールが必要な場合がある。

#### ▼ 脆弱性テスト

ソースコードの実装方法に起因する脆弱性を検証する。

#### ▼ その他

テストされるソースコード (例：Dockerfile、Kubernetesのマニフェスト、Terraform) によって、静的解析には他にも種類がある。

<br>

## 03. 単体テスト (ユニットテスト)

### 単体テストとは

クラスや構造体のメソッドが、それ単体で正しく動作するかを検証する。

言語によって、ビルトインのコマンド (例：`go test`コマンド) で実現できる場合や、外部テストツールが必要な場合がある。

検証対象以外の処理はスタブとして定義する。理想としては、アーキテクチャの層ごとに単体テストを実施する必要がある。

この時、データアクセスに関わる層の単体テストのために、本来のDBとは別に、あらかじめテスト用DBを用意した方が良い。

テスト用DBを`docker-compose.yml`ファイルによって用意する方法については、以下のリンクを参考にせよ。

> ↪️ 参考：https://hiroki-it.github.io/tech-notebook/infrastructure_as_code/infrastructure_as_code_docker_compose_yml.html

<br>

### 設計ポリシー

#### ▼ 単体テストの構成

単体テストはテストスイート (テストの組) から構成され、テストスイートはテストケース (テスト関数) に分類できる。

例えば、Goでは構造体をテストスイートとし、単体テストを定義する。

![test-plan_test-suite_test-case](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/test-plan_test-suite_test-case.jpg)

#### ▼ テストケース名

Roy Osherove氏の命名規則に従って、『テスト対象のメソッド名』『入力値』『期待される返却値』の三要素でテスト関数を命名する。

期待される返却値の命名で『正常系テスト』か『異常系テスト』かと識別する。

例えば、正常系であれば『`testFoo_Xxx_ReturnXxx`』、また異常系であれば『`testFoo_Xxx_ExceptionThrown`』や『`testFoo_Xxx_ErrorThrown`』とする。

Roy Osherove氏の命名規則については、以下のリンクを参考にせよ。

> ↪️ 参考：https://osherove.com/blog/2005/4/3/naming-standards-for-unit-tests.html

#### ▼ アサーションの比較値

単体テストのアサーションメソッドで、期待値と実際値を比較する場合、期待値を定数として管理した方が良い。

> ↪️ 参考：https://osherove.com/blog/2005/4/3/naming-standards-for-unit-tests.html

<br>

## 03-02. テストダブル

### テストダブル

単体テストでは、各コンポーネントの依存対象のコンポーネントをテストダブル (代替品) に置き換える。

> ↪️ 参考：https://en.wikipedia.org/wiki/Test_double

<br>

### テストダブルの種類

#### ▼ モック

上層クラス (上層構造体) が下層クラスを正しくコールできるか否かを検証したい時に、上層クラス以外の部分的処理は不要であり、下層クラスの実体があるかのように見せかける。

この時、見せかけの下層クラスとして使用する擬似オブジェクトを『モック』という。

スタブとは、使用されるテストが異なるが、どちらも擬似オブジェクトである。

モックでは、クラスのメソッドとデータが全てダミー実装に置き換わる。

もし下層クラスを正しい回数実行できているかを検証したい場合は、下層クラスのモックを定義し、実体のある上層クラスが下層クラスにパラメーターを渡した時のコール回数と指定回数を比較する。

注意点として、用語の定義はテストフレームワークごとにやや異なることに注意する。

PHPUnitにおけるモックについては、以下のリンクを参考にせよ。

| ツール名 | モックのメソッドの返却値                                                                                  | 補足                                                                                                                                                                   |
| -------- | --------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| PHPUnit  | メソッドは、`null`を返却する。                                                                            | 注意点として、`final`、`private`なメソッドはモック化されず、実体をそのまま引き継ぐ。また、`static`なメソッドは`BadMethodCallException`をスローするモックに置き換わる。 |
| JUnit    | メソッドは、元のオブジェクトのメソッドの返却値の型を基に、初期値を返却する<br> (例：boolean型なら`false`) |                                                                                                                                                                        |

> ↪️ 参考：https://phpunit.readthedocs.io/ja/latest/test-doubles.html#test-doubles-mock-objects

#### ▼ スタブ

クラスのメソッドの処理を検証したい時に、依存している下層クラスは、実体があるかのように見せかける。

この時、見せかけの下層クラスとして使用する擬似オブジェクトを『スタブ』という。

モックとは、使用されるテストが異なるが、どちらも擬似オブジェクトである。

モックと同様にスタブでも、クラスのメソッドとデータが全てダミー実装に置き換わる。

スタブには、正しい処理を実行するように引数と返却値を持つメソッドを定義し、その他の実体のある処理が正しく実行されるかを検証する。

これらにより、検証対象の処理のみが実体であっても、一連の処理を実行できる。

注意点として、用語の定義はテストフレームワークごとにやや異なることに注意する。

PHPUnitにおけるスタブについては、以下のリンクを参考にせよ。

> ↪️ 参考：https://phpunit.readthedocs.io/ja/latest/test-doubles.html#test-doubles-stubs

<br>

### モックツール、スタブツール

- PHPUnit
- Phake
- Mockery
- JUnit

<br>

## 03-03. 網羅率

### 網羅率とは

網羅条件に基づいた単体テストの品質指標である。

採用した網羅で考えられる全ての条件のうち、テストで検証できている割合で表す。

網羅率はテストスイートやパッケージを単位として解析され、これは言語別に異なる。

言語やツールごとに網羅率を解析する方法が異なり、PHPのPHPUnitでは以下のリンクを参考にせよ。

> ↪️ 参考：https://phpunit.readthedocs.io/ja/latest/code-coverage-analysis.html

<br>

### 網羅条件の種類

#### ▼ C０：Statement Coverage (命令網羅)

![p494-1](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/p494-1.png)

全ての命令が実行されるかを検証する。

**＊例＊**

AとBは、『1』または『0』になり得るとする。

| 条件         | 処理実行の有無               |
| ------------ | ---------------------------- |
| A = 1、B = 1 | `return X`が実行されること。 |

> ↪️ 参考：https://www.amazon.co.jp/dp/4297124513

#### ▼ C１：Decision Coverage (判定条件網羅/分岐網羅)

![p494-2](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/p494-2.png)

全ての判定が実行されるかを検証する。

**＊例＊**

AとBは、『1』または『0』になり得るとする。

| 条件         | 処理実行の有無                 |
| ------------ | ------------------------------ |
| A = 1、B = 1 | `return X`が実行されること。   |
| A = 1、B = 0 | `return X`が実行されないこと。 |

> ↪️ 参考：https://www.amazon.co.jp/dp/4297124513

#### ▼ C２：Condition Coverage (条件網羅)

![p494-3](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/p494-3.png)

各条件が、取り得る全ての値で実行されるかを検証する。

**＊例＊**

AとBは、『1』または『0』になり得るとする。

| 条件         | 処理実行の有無                 |
| ------------ | ------------------------------ |
| A = 1、B = 0 | `return X`が実行されないこと。 |
| A = 0、B = 1 | `return X`が実行されないこと。 |

または、次の組み合わせでも良い。

| 条件         | 処理実行の有無                 |
| ------------ | ------------------------------ |
| A = 1、B = 1 | `return X`が実行されること。   |
| A = 0、B = 0 | `return X`が実行されないこと。 |

> ↪️ 参考：https://www.amazon.co.jp/dp/4297124513

#### ▼ MCC：Multiple Condition Coverage (複数条件網羅)

![p494-4](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/p494-4.png)

各条件が、取り得る全ての値で、かつ全ての組み合わせが実行されるかを検証する。

一般的に、複数条件網羅を採用すれば、最低限のソフトウェア品質を担保できていると言える。

**＊例＊**

AとBは、『1』または『0』になり得るとする。

| 条件         | 処理実行の有無                 |
| ------------ | ------------------------------ |
| A = 1、B = 1 | `return X`が実行されること。   |
| A = 1、B = 0 | `return X`が実行されないこと。 |
| A = 0、B = 1 | `return X`が実行されないこと。 |
| A = 0、B = 0 | `return X`が実行されないこと。 |

> ↪️ 参考：https://www.amazon.co.jp/dp/4297124513

<br>

## 03-04. 循環的複雑度

### 循環的複雑度とは

コードの複雑さの程度のこと。

単体テストの品質の指標になる。

おおよそ判定条件網羅の経路数の程度である。

<br>

### 循環複雑度の種類

| 循環的複雑度 | 複雑さの状態                 | バグ混入率 |
| ------------ | ---------------------------- | ---------- |
| `10`以下     | 非常に良い                   | `25`%      |
| `30`以上     | 構造的なリスクあり           | `40`%      |
| `50`以上     | テストできない               | `70`%      |
| `75`以上     | 変更によって誤修正が生じる。 | `98`%      |

> ↪️ 参考：
>
> - https://jp.mathworks.com/discovery/cyclomatic-complexity.html
> - https://szk-takanori.hatenablog.com/entry/20111219/p1

<br>

## 04. 機能テスト (フィーチャーテスト)

### 機能テストとは

アプリケーションの各エンドポイントを`1`個の機能ととらえる。

アプリケーション (またはその前段のAPI Gateway) のエンドポイントにリクエストを送信し、外部Webサービスとの連携も含めて、レスポンスが機能要件通りに返信されるか否かを検証する。

スタブを使用することは少ない。

ブラックボックステストの機能テストとは意味合いが異なることに注意する。

> ↪️ 参考：https://eh-career.com/engineerhub/entry/action/2019/10/03/103000/#%E5%A2%83%E7%95%8C%E5%80%A4%E3%83%86%E3%82%B9%E3%83%88

<br>

## 05. 回帰テスト

テストの期待値ファイルを作成しておき、何らかの機能追加/変更によって、機能追加/変更を含むコンポーネントが既存のコンポーネントに影響を与えていないか (既存の機能がデグレーションしていないか) を検証する。

特にGoでは、このテストデータをファイルを『ゴールデンファイル』という。

ゴールデン (金) は化学的に安定した物質であることに由来しており、『安定したプロダクト』とかけている。

> ↪️ 参考：https://softwareengineering.stackexchange.com/a/358792

<br>

## 06. マイクロサービス固有のホワイトボックステスト手法

### マイクロサービス固有のホワイトボックステスト手法とは

マイクロサービスアーキテクチャを採用している場合、マイクロサービス固有の観点でホワイトボックステストが必要になる。

<br>

### マイクロサービスの単体テスト

#### ▼ マイクロサービスの単体テストとは

単体テストは、マイクロサービスアーキテクチャでも同じである。

マイクロサービスのクラスや構造体のメソッドが、それ単体で正しく動作するかを検証する。

> ↪️ 参考：
>
> - https://engineering.mercari.com/blog/entry/20210928-mtf2021-day5-3/
> - https://www.parasoft.com/blog/what-are-different-types-of-tests-for-microservices/
> - https://semaphoreci.com/blog/test-microservices

#### ▼ 単体テストツール例

言語によって、ビルトインのコマンド (例：`go test`コマンド) で実現できる場合や、外部テストツールが必要な場合がある。

<br>

### コンポーネントテスト

#### ▼ コンポーネントテストとは

マイクロサービスがそれのみで正しく動作するかを検証する。

下流のマイクロサービスは検証対象ではないため、サービスモックとする。

> ↪️ 参考：
>
> - https://engineering.mercari.com/blog/entry/20210928-mtf2021-day5-3/
> - https://www.parasoft.com/blog/what-are-different-types-of-tests-for-microservices/
> - https://semaphoreci.com/blog/test-microservices

#### ▼ コンポーネントテストツール例

言語によって、ビルトインのコマンド (例：`go test`コマンド) で実現できる場合や、外部テストツールが必要な場合がある。

<br>

### マイクロサービスの結合テスト (≒機能テスト)

#### ▼ マイクロサービスの結合テストとは

マイクロサービスアーキテクチャの文脈では、機能テストを結合テストと呼ぶ。

マイクロサービスの各エンドポイントを`1`個の機能ととらえる。

最上流のマイクロサービス (またはその前段のAPI Gateway) のエンドポイントにリクエストを送信し、下流のマイクロサービスや外部Webサービス (正常である前提) との連携も含めて、レスポンスが機能要件通りに返信されるか否かを検証する。

もしマイクロサービスの結合テストを自動化する場合、マイクロサービスのCIパイプライン上ではなく、結合テスト専用のパイプライン上で実施する。

またパイプライン実行環境がマイクロサービスのエンドポイントにリクエストを送信できるよう、パイプライン実行環境からマイクロサービスまでの通信経路を用意する必要がある。

> ↪️ 参考：
>
> - https://engineering.mercari.com/blog/entry/20210928-mtf2021-day5-3/
> - https://www.parasoft.com/blog/what-are-different-types-of-tests-for-microservices/
> - https://semaphoreci.com/blog/test-microservices

#### ▼ 結合テストツール例

- Postman

<br>

### CDCテスト：Consumer Drive Contract

調査中...

> ↪️ 参考：
>
> - https://engineering.mercari.com/blog/entry/20210928-mtf2021-day5-3/
> - https://www.parasoft.com/blog/what-are-different-types-of-tests-for-microservices/
> - https://semaphoreci.com/blog/test-microservices

<br>

### End-to-Endテスト (E2Eテスト)

調査中...

> ↪️ 参考：https://www.chalkboard.me/2020/08/%E3%83%9E%E3%82%A4%E3%82%AF%E3%83%AD%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%86%E3%82%B9%E3%83%88%E6%96%B9%E6%B3%95%E3%81%AE%E8%AA%BF%E6%9F%BB/

<br>
