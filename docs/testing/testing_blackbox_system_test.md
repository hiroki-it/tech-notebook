---
title: 【IT技術の知見】総合テスト＠ブラックボックステスト
description: 総合テスト＠ブラックボックステストの知見を記録しています。
---

# 総合テスト＠ブラックボックステスト

## 01. 総合テスト（システムテスト）

### 総合テストとは

既存機能/追加/変更を含む全てのコンポーネントを組み合わせ、全てのコンポーネント間の連携が正しく機能しているかを検証する。

ℹ️ 参考：https://pm-rasinban.com/ut-it-st

![testing_blackbox-test_unit_integration_system](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/testing_blackbox-test_unit_integration_system.png)

<br>

### 総合テストの種類

#### ▼ 機能テスト

| テストの種類         | 検証内容                                                     |
| -------------------- | ------------------------------------------------------------ |
| 正常系               | 基本操作（登録、参照、更新、削除）、画面遷移、状態遷移、セキュリティ、など |
| 異常系               | 基本操作（登録、参照、更新、削除）、など                     |
| 組み合わせ           | 同時操作、割り込み操作、排他制御に関わる操作、など           |
| 業務シナリオ         | シナリオに沿ったユーザーによる一連の操作                     |
| 開発者シナリオ       | シナリオに沿った開発者による一連の操作（手動コマンドなど）   |
| 外部ソフトウェア連携 | 外部のAPIとの連携処理に関わる操作                            |

#### ▼ 非機能テスト

ℹ️ 参考：https://www.qbook.jp/column/20180806_667.html

| テストの種類          | 検証内容                     |
| --------------------- | ---------------------------- |
| ストレステスト        | 許容可能な最大の負荷耐性     |
| ロードテスト          | 実地を再現した負荷耐性       |
| 可用性テスト          | 可用性                       |
| 耐障害性テスト        | 耐障害性                     |
| Testing in production | リリース後の実地での負荷耐性 |

<br>

### テスト結果の可視化

#### ▼ バグ管理図

プ4ジェクトの時、残存テスト数と不良摘出数（バグ発見数）を縦軸にとり、時間を横軸にとることにより、バグ管理図を作成する。それぞれの曲線の状態から、プロジェクトの進捗状況を読み取られる。

![品質管理図](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/品質管理図.jpg)

不良摘出実績線（信頼度成長曲線）は、プログラムの品質の状態を表し、S字型でないものはプログラムの品質が良くないことを表す。

![信頼度成長曲線の悪い例](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/信頼度成長曲線の悪い例.jpg)

<br>

## 02. 機能テスト

機能要件を満たせているかを検証する。ホワイトボックスでの機能テストとは意味合いが異なるので注意する。

ℹ️ 参考：https://eh-career.com/engineerhub/entry/action/2019/10/03/103000/#%E5%A2%83%E7%95%8C%E5%80%A4%E3%83%86%E3%82%B9%E3%83%88

<br>

## 03. ストレステスト（負荷テスト）

### ストレステスト

#### ▼ ストレステストとは

許容可能な最大の負荷を検証する。また、テスト結果から、運用時の監視で参考にするための、安全範囲（青信号）、危険範囲（黄色信号）、限界値（赤信号）、を導く必要がある。ロードテストとは区別すること。ストレステストには、性能テスト、限界テスト、耐久テストがある。

ℹ️ 参考：

- https://www.oracle.com/jp/technical-resources/article/ats-tech/tech/useful-class-8.html
- https://engineering.dena.com/blog/2021/10/healthcare-load-testing/

#### ▼ パラメーター

![stress-test_parameter](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/stress-test_parameter.png)

ℹ️ 参考：https://tech-blog.rakus.co.jp/entry/2017/08/24/111332

| テストのパラメーター | 説明                                                         |
| -------------------- | ------------------------------------------------------------ |
| スレッド数           | リクエストのユーザー数に相当する。                           |
| ループ数             | ユーザー当たりのリクエスト送信数に相当する。                 |
| RampUp秒             | リクエストを送信する期間に相当する。長くし過ぎすると、全てのリクエスト数を送信するまでに時間がかかるようになるため、負荷が小さくなる。 |

<br>

### 性能テスト

#### ▼ 性能テストとは

![performance-test](https://raw.githubusercontent.com/hiroki-it/tech-notebook/master/images/performance-test.png)

一定時間内に、ユーザーが一連のリクエスト（例：ログイン、閲覧、登録、ログアウト）を行った時に、ソフトウェアのスループットとレスポンス時間にどのような変化があるかを検証する。具体的にはテスト時に、アクセス数を段階的に増加させて、その結果をグラフ化する。グラフ結果を元に、想定されるリクエスト数が現在の性能にどの程度の負荷をかけるのかを確認し、また性能の負荷が最大になる値を導く。これらを運用時の監視の参考値にする。

ℹ️ 参考：

- https://www.oracle.com/jp/technical-resources/article/ats-tech/tech/useful-class-8.html
- https://engineering.dena.com/blog/2021/10/healthcare-load-testing/

<br>

### 限界テスト

#### ▼ 限界テストとは

性能の限界値に達するほどのリクエスト数が送信された時に、障害回避処理（例：アクセスが込み合っている旨のページを表示）が実行されるかを検証する。具体的にはテスト時に、障害回避処理以外の動作（エラー、間違った処理、障害回復後にも復旧できない、システムダウン）が起こらないかを確認する。

ℹ️ 参考：

- https://www.oracle.com/jp/technical-resources/article/ats-tech/tech/useful-class-8.html
- https://engineering.dena.com/blog/2021/10/healthcare-load-testing/

<br>

### 耐久テスト

#### ▼ Durability（耐久性）

長時間の高負荷にどれだけ耐えられるかの程度を表す。

#### ▼ 耐久テストとは

長時間の大量リクエストが送信された時に、短時間では検出できないどのような問題が存在するかを検証する。具体的にはテスト時に、長時間の大量リクエストを処理させ、問題（例：微量のメモリリークが蓄積してメモリを圧迫、セッションデータが蓄積してメモリやストレージを圧迫、ログが蓄積してストレージを圧迫、ヒープやトランザクションログがCPUやI/O処理を圧迫）を起こす。これにより、どんな問題が起こるかを確認する。

ℹ️ 参考：

- https://www.oracle.com/jp/technical-resources/article/ats-tech/tech/useful-class-8.html
- https://engineering.dena.com/blog/2021/10/healthcare-load-testing/

<br>

## 03-02. ロードテスト（再現テスト）

### ロードテストとは

ソフトウェアが通常/ピーク/障害時の実地的な負荷を再現し、これに耐えられるか否かを検証する。ストレステストとは区別すること。

ℹ️ 参考：https://stackify.com/what-is-load-testing/

<br>

### テストケース例

#### ▼ 背景

アプリケーションで、開始からピークまでに、次のようにリクエスト数が増し、障害が発生したとする。その後、データを収集した。これの再現テストを実施する。

| 障害発生期間                           | 合計閲覧ページ数<br>```(PV数/min)``` | 平均ユーザー数<br>```(UA数/min)``` | ユーザー当たり閲覧ページ数<br>```(PV数/UA数)``` |
| -------------------------------------- | ------------------------------------ | ---------------------------------- | ----------------------------------------------- |
| ```13:00 ~```<br>```13:05```（開始）   | ```300```                            | ```100```                          | ```3```                                         |
| ```13:05 ~```<br>```13:10```           | ```600```                            | ```200```                          | ```3```                                         |
| ```13:10 ~```<br>```13:15```（ピーク） | ```900```                            | ```300```                          | ```3```                                         |

| ランキング | URL              | 割合       |
| ---------- | ---------------- | ---------- |
| 1          | ```/aaa/bbb/*``` | 40 ```%``` |
| 2          | ```/ccc/ddd/*``` | 30 ```%``` |
| 3          | ```/eee/fff/*``` | 20 ```%``` |
| 4          | ```/ggg/hhh/*``` | 10 ```%``` |

#### ▼ テスト内容

ユーザー当たりの閲覧ページ数はループ数に置き換わるので、ループ数は『```3```回』になる。障害発生期間の閲覧ページ数はスレッド数に置き換わるので、スレッド数は『```1800```個（```300 + 600 + 900```）』になる。障害発生期間は、Ramp-Upに置き換わるので、Ramp-Up期間は『```900```秒（```15```分間）』になる。

| スレッド数（個） | ループ数（回） | Ramp-Up期間```(sec)``` |
| ---------------- | -------------- | ---------------------- |
| ```1800```       | ```3```        | ```900```              |

<br>

## 03-03. 可用性テスト

### Availability（可用性）

#### ▼ 可用性とは

仮に障害があったとしても、どれだけシステムの利用可能な時間を長くできるかを程度を表す。

ℹ️ 参考：https://www.weblio.jp/content/%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7

<br>

### 可用性テストとは

可用性を定量的に検証する。

<br>

### 目標値の指標

#### ▼ RPO（目標復旧時点）

障害が発生した時に、どの時点まで、データを復旧させるかの目標値のこと。もしRPOが```5```分だとすると、障害前の```5```分間で作成されたデータは復旧できないことは許容することになる。

ℹ️ 参考：https://e-words.jp/w/RPO.html

#### ▼ RTO（目標復旧時間）

障害が発生した時に、どの時間までに、データを復旧させるかの目標値のこと。もしRTOが```1```時間だとすると、```1```時間はデータを復旧できないままになることを許容することになる。

ℹ️ 参考：https://e-words.jp/w/RTO.html

<br>

### テストケース例

#### ▼ 背景

Kubernetes Nodeに相当する仮想サーバー上で、Kubernetesリソースが稼働している。これの可用性テストを実施する。

- 仮想サーバー：AWS EC2（オートスケーリングあり）
- アプリケーション：Go
- リバースプロキシ：Nginx
- オペレーター：各種Operator
- サービスメッシュ：Istio
- 監視

  - データ収集/分析

    - メトリクス収集：kube-state-metrics、各種Exporter、Prometheus

    - ログルーティング：Fluentd

  - データ可視化

    - メトリクス可視化：Grafana

  - アラート

    - 受信したアラートの通知：Alertmanager

#### ▼ テスト内容

| テストケース   | 詳細                                | テスト方法説明                                               | コマンド                                                     | 期待動作                                                     |
| -------------- | ----------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Nodeの停止障害 | AWS EC2が停止する。                 | ノード内でroot権限でカーネルパニックを意図的に起こし、その状態でもシステム全体として稼働し続けられるかを確認する。 | ・```aws ec2 stop-instances --instance-ids <インスタンスID>```<br>・```echo 1 > /proc/sys/kernel/sysrq && echo c > /proc/sysrq-trigger``` | ・冗長化された稼働中のNode上で、レプリカ数を維持できるだけのPodが起動する。<br>・オートスケーリングによって、停止したNodeに代わり新しいNodeが起動する。<br>・Nodeのヘルスチェックが正常である。 |
| Podの停止障害  | GoのPodが停止する。                 | ```kubectl```コマンドでPodを強制終了し、その状態でもシステム全体として稼働し続けられるかを確認する。 | ・```kubectl delete pod <Pod名> --grace-period=0 --force```  | ・オートスケーリングによって、停止したPodに代わり新しいPodが起動する。<br>・アプリケーションが正しく動作している。 |
|                | NginxのPodが停止する。              | 同上                                                         | 同上                                                         | ・オートスケーリングによって、停止したPodに代わり新しいPodが起動する。<br>・アプリケーションが正しく動作している。 |
|                | kube-state-metricsのPodが停止する。 | 同上                                                         | 同上                                                         | ・オートスケーリングによって、停止したPodに代わり新しいPodが起動する。<br>・データを全て収集できている。 |
|                | PrometheusのPodが停止する。         | 同上                                                         | 同上                                                         | ・オートスケーリングによって、停止したPodに代わり新しいPodが起動する。<br>・データを全て収集できている。 |
|                | FluentdのPodが停止する。            | 同上                                                         | 同上                                                         | ・オートスケーリングによって、停止したPodに代わり新しいPodが起動する。<br>・ログを正しくルーティングできている。 |
|                | GrafanaのPodが停止する。            | 同上                                                         | 同上                                                         | ・オートスケーリングによって、停止したPodに代わり新しいPodが起動する。<br>・ダッシュボードにログインできる。<br>・データを正しく可視化できている。 |
|                | AlertmanagerのPodが停止する。       | 同上                                                         | 同上                                                         | ・オートスケーリングによって、停止したPodに代わり新しいPodが起動する。<br>・ダッシュボードにログインできる。<br>・アラートを正しくルーティングできている。 |

<br>

## 03-04. 耐障害性テスト

### Fault tolerance（耐障害性）

#### ▼ 耐障害性とは

障害が起きた時にユーザーへの影響をどれだけ小さくできるかの程度を表す。

#### ▼ 定量化の方法

<br>

### 耐障害性テストとは

ℹ️ 参考：https://blog.cybozu.io/entry/2018/09/06/080000

<br>

## 03-05. Testing in production

### Testing in productionとは

本番環境にて、実際のユーザーの手を借りて実地的にテストする。

- カナリアリリース中のテスト
- カオスエンジニアリング

ℹ️ 参考：https://www.optimizely.com/optimization-glossary/testing-in-production/

### カオスエンジニアリング

#### ▼ カオスエンジニアリング

実験的に、本番環境のシステムに『カオス』を挿入し、高負荷な状態に至らせる。その結果から、システムに潜む想定外の問題を表面化させる。カオスエンジニアリングは、実地的なテストであり、今まさに実際のユーザーが使用しているソフトウェアに対して実施することになるため、ビジネスサイドの理解が必要になる。対象となるシステムは、マイクロサービスアーキテクチャであっても、モノリスアーキテクチャであっても、問題ない。本格的なカオスエンジニアリングを採用している日系企業は少なく、国内事例はまだ少ない。

ℹ️ 参考：

- https://principlesofchaos.org/
- https://codezine.jp/article/detail/14526
- https://dev.classmethod.jp/articles/what-is-suitable-for-chaos-engineering-chaosconf2019-recap/#toc-6

#### ▼ 手順

ℹ️ 参考：https://zenn.dev/hodagi/articles/3ce6ccdb00538c

1. 本番環境のシステムから様々なテレメトリーを収集し、安定している通常状態（定常状態）を定義する。
2. 定常状態を対照群、またカオスエンジニアリングが実施された状態を実験群とする。『実験群では障害が起こる』という仮説の下、これを反証することを目指す。
3. 実験群でカオスエンジニアリングを実施する。
4. 対照群と比較し、『障害は起こる』という仮説を反証する。

<br>
