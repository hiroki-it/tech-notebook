
<!doctype html>
<html lang="ja" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="EKS＠AWSリソースの知見を記録しています。">
      
      
        <meta name="author" content="Hiroki Hasegawa">
      
      
        <link rel="canonical" href="https://hiroki-it.github.io/tech-notebook/cloud_computing/cloud_computing_aws_resource_eks.html">
      
      
        <link rel="prev" href="cloud_computing_aws_resource_efs.html">
      
      
        <link rel="next" href="cloud_computing_aws_resource_elasticache.html">
      
      
      <link rel="icon" href="../assets/images/logo_v2.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.3.1">
    
    
      
        <title>【IT技術の知見】EKS＠AWSリソース - 俺の技術ノート</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.046329b4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.85d0ee34.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+Japanese:300,300i,400,400i,700,700i%7CNoto+Sans+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans Japanese";--md-code-font:"Noto Sans Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/css/custom.css">
    
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-HPJGWKTH9W"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-HPJGWKTH9W",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-HPJGWKTH9W",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="dark" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#eksaws" class="md-skip">
          コンテンツにスキップ
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="ヘッダー">
    <a href="https://hiroki-it.github.io/tech-notebook/" title="俺の技術ノート" class="md-header__button md-logo" aria-label="俺の技術ノート" data-md-component="logo">
      
  <img src="../assets/images/logo_v2.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            俺の技術ノート
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              【IT技術の知見】EKS＠AWSリソース
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="検索" placeholder="検索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="検索">
        
        <button type="reset" class="md-search__icon md-icon" title="クリア" aria-label="クリア" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            検索を初期化
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hiroki-it/" title="リポジトリへ" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHubアカウントはこちら
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="タブ" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../index.html" class="md-tabs__link">
        
  
    
  
  当サイトについて

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../about.html" class="md-tabs__link">
        
  
    
  
  『俺』

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../system/index.html" class="md-tabs__link">
          
  
    
  
  🌳 システム

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../software/index.html" class="md-tabs__link">
          
  
    
  
  🧬 ソフトウェア

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../software/application/index.html" class="md-tabs__link">
          
  
    
  
  🚀 アプリ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../software/middleware/index.html" class="md-tabs__link">
          
  
    
  
  🤝🏻 ミドルウェア

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../software/basic/index.html" class="md-tabs__link">
          
  
    
  
  🐧 OS

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../language/index.html" class="md-tabs__link">
          
  
    
  
  🔠 言語

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../testing/index.html" class="md-tabs__link">
          
  
    
  
  🧪 テスト

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../hardware/index.html" class="md-tabs__link">
          
  
    
  
  💻 ハードウェア

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../network/index.html" class="md-tabs__link">
          
  
    
  
  🌏 ネットワーク

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../security/index.html" class="md-tabs__link">
          
  
    
  
  🔐 セキュリティ

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="index.html" class="md-tabs__link">
          
  
    
  
  ⛅️ 3大クラウド

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../virtualization/index.html" class="md-tabs__link">
          
  
    
  
  📦 仮想化

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../infrastructure_as_code/index.html" class="md-tabs__link">
          
  
    
  
  ⚙️ IaC

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../infrastructure_as_code/kubernetes/index.html" class="md-tabs__link">
          
  
    
  
  ☸️ K8s

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../infrastructure_as_code/kubernetes_addon/index.html" class="md-tabs__link">
          
  
    
  
  ⏬ K8sアドオン

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../infrastructure_as_code/cncf_projects/index.html" class="md-tabs__link">
          
  
    
  
  🌊 CNCF

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../devops/index.html" class="md-tabs__link">
          
  
    
  
  ♾️ DevOps

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../devops/cicd/index.html" class="md-tabs__link">
          
  
    
  
  🔄 CI/CD

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../observability/index.html" class="md-tabs__link">
          
  
    
  
  🔎 可観測性

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../software_development_methodology/index.html" class="md-tabs__link">
          
  
    
  
  👥 開発手法

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="ナビゲーション" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://hiroki-it.github.io/tech-notebook/" title="俺の技術ノート" class="md-nav__button md-logo" aria-label="俺の技術ノート" data-md-component="logo">
      
  <img src="../assets/images/logo_v2.png" alt="logo">

    </a>
    俺の技術ノート
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hiroki-it/" title="リポジトリへ" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHubアカウントはこちら
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    当サイトについて
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../about.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    『俺』
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../system/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    🌳 システム
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../software/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    🧬 ソフトウェア
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../software/application/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    🚀 アプリ
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../software/middleware/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    🤝🏻 ミドルウェア
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../software/basic/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    🐧 OS
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../language/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    🔠 言語
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../testing/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    🧪 テスト
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../hardware/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    💻 ハードウェア
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../network/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    🌏 ネットワーク
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../security/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    🔐 セキュリティ
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    ⛅️ 3大クラウド
  </span>
  

            </a>
            
              <label class="md-nav__link " for="__nav_13">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            ⛅️ 3大クラウド
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3大クラウド
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13_3" checked>
        
          <label class="md-nav__link" for="__nav_13_3" id="__nav_13_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ■ AWS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_13_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_13_3">
            <span class="md-nav__icon md-icon"></span>
            ■ AWS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_cli.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS CLI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13_3_2" checked>
        
          <label class="md-nav__link" for="__nav_13_3_2" id="__nav_13_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ■ AWSリソース
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_13_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_13_3_2">
            <span class="md-nav__icon md-icon"></span>
            ■ AWSリソース
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_account.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    アカウント
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_amplify.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Amplify
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="cloud_computing_aws_resource_api_gateway.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    ■ API Gateway
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_autoscaling.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AutoScaling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_backup.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Backup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_certificate_manager.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Certificate Manager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_chatbot.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chatbot
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_cloudformation.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CloudFormation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_cloudfront.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CloudFront
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_cloudtrail.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CloudTrail
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_cloudwatch.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CloudWatch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_code.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code兄弟
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_control_tower.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Control Tower
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_direct_connect.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DirectConnect
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_ec2.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EC2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_ecr.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ECR
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_ecs.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ECS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_efs.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EFS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    EKS
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="cloud_computing_aws_resource_eks.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    EKS
  </span>
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="このページの内容">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      このページの内容
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    はじめに
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#01-ekselastic-kubernetes-service" class="md-nav__link">
    01. EKS：Elastic Kubernetes Service
  </a>
  
    <nav class="md-nav" aria-label="01. EKS：Elastic Kubernetes Service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    コントロールプレーン
  </a>
  
    <nav class="md-nav" aria-label="コントロールプレーン">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    ▼ コントロールプレーンとは
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    ▼ 仕組み
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    データプレーン
  </a>
  
    <nav class="md-nav" aria-label="データプレーン">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    ▼ データプレーンとは
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#01-02" class="md-nav__link">
    01-02. セットアップ
  </a>
  
    <nav class="md-nav" aria-label="01-02. セットアップ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    コンソール画面の場合
  </a>
  
    <nav class="md-nav" aria-label="コンソール画面の場合">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    ▼ 設定項目と説明
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terraform" class="md-nav__link">
    Terraformの公式モジュールの場合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-cluster" class="md-nav__link">
    EKS Clusterの認証情報の追加
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#02" class="md-nav__link">
    02. コントロールプレーンのコンポーネント
  </a>
  
    <nav class="md-nav" aria-label="02. コントロールプレーンのコンポーネント">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    対応関係
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kube-apiserver" class="md-nav__link">
    kube-apiserver
  </a>
  
    <nav class="md-nav" aria-label="kube-apiserver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubernetes-rbac" class="md-nav__link">
    ▼ Kubernetes RBACとの連携
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    ▼ パブリックアクセス/プライベートアクセス
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#03" class="md-nav__link">
    03. データプレーンのコンポーネント
  </a>
  
    <nav class="md-nav" aria-label="03. データプレーンのコンポーネント">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    対応関係
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-cluster_1" class="md-nav__link">
    EKS Cluster
  </a>
  
    <nav class="md-nav" aria-label="EKS Cluster">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#eks-cluster_2" class="md-nav__link">
    ▼ EKS Clusterとは
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node" class="md-nav__link">
    マルチワーカーNode
  </a>
  
    <nav class="md-nav" aria-label="マルチワーカーNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node_1" class="md-nav__link">
    ▼ マルチワーカーNodeとは
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node_2" class="md-nav__link">
    ▼ ワーカーNode間のファイル共有
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#irsaiam-roles-for-service-accounts" class="md-nav__link">
    IRSA：IAM Roles for Service Accounts
  </a>
  
    <nav class="md-nav" aria-label="IRSA：IAM Roles for Service Accounts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#irsa" class="md-nav__link">
    ▼ IRSAとは
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    ▼ セットアップ
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    デバッグ
  </a>
  
    <nav class="md-nav" aria-label="デバッグ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    ▼ ダッシュボード
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node_3" class="md-nav__link">
    ▼ ワーカーNodeへの接続
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#03-02" class="md-nav__link">
    03-02. ネットワーク
  </a>
  
    <nav class="md-nav" aria-label="03-02. ネットワーク">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vpc" class="md-nav__link">
    VPC、サブネット
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    プライベートサブネット内のデータプレーンへのインバウンド通信
  </a>
  
    <nav class="md-nav" aria-label="プライベートサブネット内のデータプレーンへのインバウンド通信">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod" class="md-nav__link">
    ▼ Podへのインバウンド通信
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    コントロールプレーンへのインバウンド通信
  </a>
  
    <nav class="md-nav" aria-label="コントロールプレーンへのインバウンド通信">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    ▼ アクセス制限
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    ▼ パブリックのみ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    ▼ パブリックとプライベートの場合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    ▼ プライベートのみ
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#04-on-ec2-ec2node" class="md-nav__link">
    04. on-EC2 (EC2ワーカーNode)
  </a>
  
    <nav class="md-nav" aria-label="04. on-EC2 (EC2ワーカーNode)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ec2node" class="md-nav__link">
    EC2ワーカーNode
  </a>
  
    <nav class="md-nav" aria-label="EC2ワーカーNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ec2node_1" class="md-nav__link">
    ▼ EC2ワーカーNodeとは
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    セットアップ
  </a>
  
    <nav class="md-nav" aria-label="セットアップ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#iam" class="md-nav__link">
    ▼ IAMポリシー
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#04-02-node-on-ec2" class="md-nav__link">
    04-02. Nodeグループ (on-EC2)
  </a>
  
    <nav class="md-nav" aria-label="04-02. Nodeグループ (on-EC2)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    マネージド
  </a>
  
    <nav class="md-nav" aria-label="マネージド">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node_4" class="md-nav__link">
    ▼ マネージドNodeグループ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node_5" class="md-nav__link">
    ▼ Nodeグループの定期アクション
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    セルフマネージド
  </a>
  
    <nav class="md-nav" aria-label="セルフマネージド">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node_6" class="md-nav__link">
    ▼ セルフマネージドNodeグループ
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2nodeami" class="md-nav__link">
    EC2ワーカーNodeの最適化AMI
  </a>
  
    <nav class="md-nav" aria-label="EC2ワーカーNodeの最適化AMI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ec2nodeami_1" class="md-nav__link">
    ▼ EC2ワーカーNodeの最適化AMIとは
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-amazon-linux" class="md-nav__link">
    ▼ EKS 最適化 Amazon Linux
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-amazon-linux_1" class="md-nav__link">
    ▼ EKS 最適化高速 Amazon Linux
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-arm-amazon-linux" class="md-nav__link">
    ▼ EKS 最適化 ARM Amazon Linux
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-bottlerocket-ami" class="md-nav__link">
    ▼ EKS 最適化 Bottlerocket AMI
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2nodeami_2" class="md-nav__link">
    EC2ワーカーNodeのカスタムAMI
  </a>
  
    <nav class="md-nav" aria-label="EC2ワーカーNodeのカスタムAMI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ec2nodeami_3" class="md-nav__link">
    ▼ EC2ワーカーNodeのカスタムAMIとは
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2node_2" class="md-nav__link">
    ▼ EC2ワーカーNodeのイメージキャッシュ削除
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2node_3" class="md-nav__link">
    ▼ 安全なEC2ワーカーNodeシャットダウン
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2" class="md-nav__link">
    EC2へのタグ付けの例
  </a>
  
    <nav class="md-nav" aria-label="EC2へのタグ付けの例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node_7" class="md-nav__link">
    ▼ マネージドNodeグループ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node_8" class="md-nav__link">
    ▼ セルフマネージドNodeグループ
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    パブリックサブネット内のデータプレーンからのアウトバウンド通信
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    プライベートサブネット内のデータプレーンからのアウトバウンド通信
  </a>
  
    <nav class="md-nav" aria-label="プライベートサブネット内のデータプレーンからのアウトバウンド通信">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    ▼ 宛先情報の管理方法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vpcaws" class="md-nav__link">
    ▼ VPC外の他のAWSリソースへのアウトバウンド通信
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vpc_1" class="md-nav__link">
    ▼ VPC外のコントロールプレーンへのアウトバウンド通信
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vpcaws_1" class="md-nav__link">
    ▼ VPC内の他のAWSリソースへのアウトバウンド通信
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#04-03" class="md-nav__link">
    04-03. セットアップ
  </a>
  
    <nav class="md-nav" aria-label="04-03. セットアップ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    コンソール画面の場合
  </a>
  
    <nav class="md-nav" aria-label="コンソール画面の場合">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node_9" class="md-nav__link">
    ▼ マネージドNodeグループの場合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node_10" class="md-nav__link">
    ▼ セルフマネージドNodeグループの場合
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terraform_1" class="md-nav__link">
    Terraformの場合
  </a>
  
    <nav class="md-nav" aria-label="Terraformの場合">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node_11" class="md-nav__link">
    ▼ マネージドNodeグループの場合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node_12" class="md-nav__link">
    ▼ セルフマネージドNodeグループの場合
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#05-on-fargate-fargatenode" class="md-nav__link">
    05. on-Fargate (FargateワーカーNode)
  </a>
  
    <nav class="md-nav" aria-label="05. on-Fargate (FargateワーカーNode)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#on-fargate-fargatenode" class="md-nav__link">
    on-Fargate (FargateワーカーNode) とは
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#05-02" class="md-nav__link">
    05-02. セットアップ
  </a>
  
    <nav class="md-nav" aria-label="05-02. セットアップ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    コンソール画面の場合
  </a>
  
    <nav class="md-nav" aria-label="コンソール画面の場合">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    ▼ 制約
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    ▼ メトリクス収集
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    ▼ ログルーティング
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fargatenode" class="md-nav__link">
    FargateワーカーNode
  </a>
  
    <nav class="md-nav" aria-label="FargateワーカーNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fargatenode_1" class="md-nav__link">
    ▼ FargateワーカーNodeとは
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fargatenode_2" class="md-nav__link">
    ▼ FargateワーカーNodeを使用できない場合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fargate" class="md-nav__link">
    ▼ Fargateプロファイル
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#05-02-node-on-fargate" class="md-nav__link">
    05-02. Nodeグループ (on-Fargate)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#06" class="md-nav__link">
    06. アップグレード
  </a>
  
    <nav class="md-nav" aria-label="06. アップグレード">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    アップグレードとは
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    仕組み
  </a>
  
    <nav class="md-nav" aria-label="仕組み">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    ▼ データプレーンの場合
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    手順
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_elasticache.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ︎ElastiCache
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_eventbridge.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EventBridge
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_firelens.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FireLens
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_global_accelerator.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Global Accelerator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_glue.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Glue
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_iam.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IAM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_kinesis.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kinesis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_kms.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    KMS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="cloud_computing_aws_resource_lambda.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    ■ Lambda
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_lb.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LB
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_rds.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RDS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_redshift.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redshift
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_route53.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Route53
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_s3.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    S3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_secrets_manager.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Secrets Manager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_ses.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SES
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_sns.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SNS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_sqs.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SQS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_step_functions.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step Functions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_sts.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    STS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_systems_manager.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Systems Manager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_vpc.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VPC
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_waf.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WAF
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_resource_work_mail.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WorkMail
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="cloud_computing_aws_policy_availability.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    ■ 設計規約
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="cloud_computing_aws_tools.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ツール
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="cloud_computing_gcp_cli.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    ■ GCP
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../virtualization/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    📦 仮想化
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../infrastructure_as_code/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    ⚙️ IaC
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../infrastructure_as_code/kubernetes/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    ☸️ K8s
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../infrastructure_as_code/kubernetes_addon/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    ⏬ K8sアドオン
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../infrastructure_as_code/cncf_projects/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    🌊 CNCF
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../devops/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    ♾️ DevOps
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../devops/cicd/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    🔄 CI/CD
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../observability/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    🔎 可観測性
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../software_development_methodology/index.html" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    👥 開発手法
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  

<nav class="md-nav md-nav--secondary" aria-label="このページの内容">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      このページの内容
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    はじめに
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#01-ekselastic-kubernetes-service" class="md-nav__link">
    01. EKS：Elastic Kubernetes Service
  </a>
  
    <nav class="md-nav" aria-label="01. EKS：Elastic Kubernetes Service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    コントロールプレーン
  </a>
  
    <nav class="md-nav" aria-label="コントロールプレーン">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    ▼ コントロールプレーンとは
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    ▼ 仕組み
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    データプレーン
  </a>
  
    <nav class="md-nav" aria-label="データプレーン">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    ▼ データプレーンとは
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#01-02" class="md-nav__link">
    01-02. セットアップ
  </a>
  
    <nav class="md-nav" aria-label="01-02. セットアップ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    コンソール画面の場合
  </a>
  
    <nav class="md-nav" aria-label="コンソール画面の場合">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    ▼ 設定項目と説明
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terraform" class="md-nav__link">
    Terraformの公式モジュールの場合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-cluster" class="md-nav__link">
    EKS Clusterの認証情報の追加
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#02" class="md-nav__link">
    02. コントロールプレーンのコンポーネント
  </a>
  
    <nav class="md-nav" aria-label="02. コントロールプレーンのコンポーネント">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    対応関係
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kube-apiserver" class="md-nav__link">
    kube-apiserver
  </a>
  
    <nav class="md-nav" aria-label="kube-apiserver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubernetes-rbac" class="md-nav__link">
    ▼ Kubernetes RBACとの連携
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    ▼ パブリックアクセス/プライベートアクセス
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#03" class="md-nav__link">
    03. データプレーンのコンポーネント
  </a>
  
    <nav class="md-nav" aria-label="03. データプレーンのコンポーネント">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    対応関係
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-cluster_1" class="md-nav__link">
    EKS Cluster
  </a>
  
    <nav class="md-nav" aria-label="EKS Cluster">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#eks-cluster_2" class="md-nav__link">
    ▼ EKS Clusterとは
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node" class="md-nav__link">
    マルチワーカーNode
  </a>
  
    <nav class="md-nav" aria-label="マルチワーカーNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node_1" class="md-nav__link">
    ▼ マルチワーカーNodeとは
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node_2" class="md-nav__link">
    ▼ ワーカーNode間のファイル共有
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#irsaiam-roles-for-service-accounts" class="md-nav__link">
    IRSA：IAM Roles for Service Accounts
  </a>
  
    <nav class="md-nav" aria-label="IRSA：IAM Roles for Service Accounts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#irsa" class="md-nav__link">
    ▼ IRSAとは
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    ▼ セットアップ
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    デバッグ
  </a>
  
    <nav class="md-nav" aria-label="デバッグ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    ▼ ダッシュボード
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node_3" class="md-nav__link">
    ▼ ワーカーNodeへの接続
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#03-02" class="md-nav__link">
    03-02. ネットワーク
  </a>
  
    <nav class="md-nav" aria-label="03-02. ネットワーク">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vpc" class="md-nav__link">
    VPC、サブネット
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    プライベートサブネット内のデータプレーンへのインバウンド通信
  </a>
  
    <nav class="md-nav" aria-label="プライベートサブネット内のデータプレーンへのインバウンド通信">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod" class="md-nav__link">
    ▼ Podへのインバウンド通信
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    コントロールプレーンへのインバウンド通信
  </a>
  
    <nav class="md-nav" aria-label="コントロールプレーンへのインバウンド通信">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    ▼ アクセス制限
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    ▼ パブリックのみ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    ▼ パブリックとプライベートの場合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    ▼ プライベートのみ
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#04-on-ec2-ec2node" class="md-nav__link">
    04. on-EC2 (EC2ワーカーNode)
  </a>
  
    <nav class="md-nav" aria-label="04. on-EC2 (EC2ワーカーNode)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ec2node" class="md-nav__link">
    EC2ワーカーNode
  </a>
  
    <nav class="md-nav" aria-label="EC2ワーカーNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ec2node_1" class="md-nav__link">
    ▼ EC2ワーカーNodeとは
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    セットアップ
  </a>
  
    <nav class="md-nav" aria-label="セットアップ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#iam" class="md-nav__link">
    ▼ IAMポリシー
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#04-02-node-on-ec2" class="md-nav__link">
    04-02. Nodeグループ (on-EC2)
  </a>
  
    <nav class="md-nav" aria-label="04-02. Nodeグループ (on-EC2)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    マネージド
  </a>
  
    <nav class="md-nav" aria-label="マネージド">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node_4" class="md-nav__link">
    ▼ マネージドNodeグループ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node_5" class="md-nav__link">
    ▼ Nodeグループの定期アクション
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    セルフマネージド
  </a>
  
    <nav class="md-nav" aria-label="セルフマネージド">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node_6" class="md-nav__link">
    ▼ セルフマネージドNodeグループ
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2nodeami" class="md-nav__link">
    EC2ワーカーNodeの最適化AMI
  </a>
  
    <nav class="md-nav" aria-label="EC2ワーカーNodeの最適化AMI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ec2nodeami_1" class="md-nav__link">
    ▼ EC2ワーカーNodeの最適化AMIとは
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-amazon-linux" class="md-nav__link">
    ▼ EKS 最適化 Amazon Linux
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-amazon-linux_1" class="md-nav__link">
    ▼ EKS 最適化高速 Amazon Linux
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-arm-amazon-linux" class="md-nav__link">
    ▼ EKS 最適化 ARM Amazon Linux
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eks-bottlerocket-ami" class="md-nav__link">
    ▼ EKS 最適化 Bottlerocket AMI
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2nodeami_2" class="md-nav__link">
    EC2ワーカーNodeのカスタムAMI
  </a>
  
    <nav class="md-nav" aria-label="EC2ワーカーNodeのカスタムAMI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ec2nodeami_3" class="md-nav__link">
    ▼ EC2ワーカーNodeのカスタムAMIとは
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2node_2" class="md-nav__link">
    ▼ EC2ワーカーNodeのイメージキャッシュ削除
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2node_3" class="md-nav__link">
    ▼ 安全なEC2ワーカーNodeシャットダウン
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2" class="md-nav__link">
    EC2へのタグ付けの例
  </a>
  
    <nav class="md-nav" aria-label="EC2へのタグ付けの例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node_7" class="md-nav__link">
    ▼ マネージドNodeグループ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node_8" class="md-nav__link">
    ▼ セルフマネージドNodeグループ
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    パブリックサブネット内のデータプレーンからのアウトバウンド通信
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    プライベートサブネット内のデータプレーンからのアウトバウンド通信
  </a>
  
    <nav class="md-nav" aria-label="プライベートサブネット内のデータプレーンからのアウトバウンド通信">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    ▼ 宛先情報の管理方法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vpcaws" class="md-nav__link">
    ▼ VPC外の他のAWSリソースへのアウトバウンド通信
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vpc_1" class="md-nav__link">
    ▼ VPC外のコントロールプレーンへのアウトバウンド通信
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vpcaws_1" class="md-nav__link">
    ▼ VPC内の他のAWSリソースへのアウトバウンド通信
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#04-03" class="md-nav__link">
    04-03. セットアップ
  </a>
  
    <nav class="md-nav" aria-label="04-03. セットアップ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    コンソール画面の場合
  </a>
  
    <nav class="md-nav" aria-label="コンソール画面の場合">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node_9" class="md-nav__link">
    ▼ マネージドNodeグループの場合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node_10" class="md-nav__link">
    ▼ セルフマネージドNodeグループの場合
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terraform_1" class="md-nav__link">
    Terraformの場合
  </a>
  
    <nav class="md-nav" aria-label="Terraformの場合">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node_11" class="md-nav__link">
    ▼ マネージドNodeグループの場合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node_12" class="md-nav__link">
    ▼ セルフマネージドNodeグループの場合
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#05-on-fargate-fargatenode" class="md-nav__link">
    05. on-Fargate (FargateワーカーNode)
  </a>
  
    <nav class="md-nav" aria-label="05. on-Fargate (FargateワーカーNode)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#on-fargate-fargatenode" class="md-nav__link">
    on-Fargate (FargateワーカーNode) とは
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#05-02" class="md-nav__link">
    05-02. セットアップ
  </a>
  
    <nav class="md-nav" aria-label="05-02. セットアップ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    コンソール画面の場合
  </a>
  
    <nav class="md-nav" aria-label="コンソール画面の場合">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    ▼ 制約
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    ▼ メトリクス収集
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    ▼ ログルーティング
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fargatenode" class="md-nav__link">
    FargateワーカーNode
  </a>
  
    <nav class="md-nav" aria-label="FargateワーカーNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fargatenode_1" class="md-nav__link">
    ▼ FargateワーカーNodeとは
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fargatenode_2" class="md-nav__link">
    ▼ FargateワーカーNodeを使用できない場合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fargate" class="md-nav__link">
    ▼ Fargateプロファイル
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#05-02-node-on-fargate" class="md-nav__link">
    05-02. Nodeグループ (on-Fargate)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#06" class="md-nav__link">
    06. アップグレード
  </a>
  
    <nav class="md-nav" aria-label="06. アップグレード">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    アップグレードとは
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    仕組み
  </a>
  
    <nav class="md-nav" aria-label="仕組み">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    ▼ データプレーンの場合
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    手順
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="eksaws">EKS＠AWSリソース<a class="headerlink" href="#eksaws" title="Permanent link">&para;</a></h1>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>本サイトにつきまして、以下をご認識のほど宜しくお願いいたします。</p>
<blockquote>
<ul>
<li><a href="https://hiroki-it.github.io/tech-notebook/">https://hiroki-it.github.io/tech-notebook/</a></li>
</ul>
</blockquote>
<p><br></p>
<h2 id="01-ekselastic-kubernetes-service">01. EKS：Elastic Kubernetes Service<a class="headerlink" href="#01-ekselastic-kubernetes-service" title="Permanent link">&para;</a></h2>
<h3 id="_2">コントロールプレーン<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<h4 id="_3">▼ コントロールプレーンとは<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<p>コンテナオーケストレーションを実行する環境を提供する。</p>
<p>データプレーンのVPC外に存在している。</p>
<blockquote>
<ul>
<li><a href="https://aws.github.io/aws-eks-best-practices/reliability/docs/controlplane/">https://aws.github.io/aws-eks-best-practices/reliability/docs/controlplane/</a></li>
</ul>
</blockquote>
<h4 id="_4">▼ 仕組み<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<p>EKSのコントロールプレーンは、開発者や他のAWSリソースからのアクセスを待ち受けるAPI、アクセスをAPIにルーティングするNLB、データプレーンを管理するコンポーネント、からなる。</p>
<p><img alt="eks_control-plane" src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/eks_control-plane.png" /></p>
<blockquote>
<ul>
<li><a href="https://www.sunnycloud.jp/column/20210315-01/">https://www.sunnycloud.jp/column/20210315-01/</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="_5">データプレーン<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<h4 id="_6">▼ データプレーンとは<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p>複数のホスト (EC2、Fargate) のOS上でコンテナオーケストレーションを実行する。</p>
<p>『<code>on-EC2</code>』『<code>on-Fargate</code>』という呼び方は、データプレーンがEKSの実行環境 (<code>on environment</code>) の意味合いを持つからである。</p>
<p><br></p>
<h2 id="01-02">01-02. セットアップ<a class="headerlink" href="#01-02" title="Permanent link">&para;</a></h2>
<h3 id="_7">コンソール画面の場合<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<h4 id="_8">▼ 設定項目と説明<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>設定項目</th>
<th>説明</th>
<th>補足</th>
</tr>
</thead>
<tbody>
<tr>
<td>名前</td>
<td>クラスターの名前を設定する。</td>
<td></td>
</tr>
<tr>
<td>Kubernetesバージョン</td>
<td>EKS上で稼働するKubernetesのバージョンを設定する。</td>
<td>EKSが対応できるKubernetesのバージョンは以下を参考にせよ。<br>- <a href="https://docs.aws.amazon.com/eks/latest/userguide/platform-versions.html">https://docs.aws.amazon.com/eks/latest/userguide/platform-versions.html</a></td>
</tr>
<tr>
<td>クラスターサービスロール</td>
<td>EKS Clusterのサービスリンクロールを設定する。</td>
<td>- <a href="https://docs.aws.amazon.com/eks/latest/userguide/service_IAM_role.html">https://docs.aws.amazon.com/eks/latest/userguide/service_IAM_role.html</a></td>
</tr>
<tr>
<td>シークレット</td>
<td>Secretに保持するデータをKMSの暗号化キーで暗号化するか否かを設定する。</td>
<td></td>
</tr>
<tr>
<td>VPC、サブネット</td>
<td>ENIを配置するサブネットを設定する。</td>
<td>複数のAZにまたがっている必要がある。</td>
</tr>
<tr>
<td>クラスターセキュリティグループ</td>
<td>EKS Clusterのセキュリティグループを設定する。</td>
<td>インバウンドとアウトバウンドの両方のルールで、全てのIPアドレスを許可する必要がある。このセキュリティグループは、追加のセキュリティグループとして設定され、別途、AWSによって<code>eks-cluster-sg-&lt;EKS Cluster名&gt;</code>というセキュリティグループも自動設定される。<br>- <a href="https://yuutookun.hatenablog.com/entry/fargate_for_eks">https://yuutookun.hatenablog.com/entry/fargate_for_eks</a></td>
</tr>
<tr>
<td>クラスターIPアドレスファミリー</td>
<td>PodとServiceに割り当てるClusterIPのIPアドレスタイプ (IPv4、IPv6) を設定する。</td>
<td></td>
</tr>
<tr>
<td>CIDRブロック</td>
<td>ClusterIP Serviceに割り当てるIPアドレスのCIDRブロックを設定する。</td>
<td></td>
</tr>
<tr>
<td>クラスターエンドポイントアクセス</td>
<td>kube-apiserverのアクセス制限を設定する。</td>
<td></td>
</tr>
<tr>
<td>ネットワークアドオン</td>
<td>ネットワークに関するAWS EKSアドオンを設定する。</td>
<td>執筆時点 (2023/02/05) では、aws-eks-kube-proxyアドオン、aws-eks-corednsアドオン、aws-eks-vpc-cniアドオン、を使用できる。</td>
</tr>
<tr>
<td>コントロールプレーンのログ</td>
<td>コントロールプレーンコンポーネントのログをCloudWatchログに出力するかどうかを設定する。</td>
<td>執筆時点 (2023/02/05) では、kube-apiserver (処理ログと監査ログの両方) 、aws-iam-authenticator-server (処理ログ) 、kube-controller-manager (処理ログ) 、cloud-controller-manager (処理ログ) 、kube-scheduler (処理ログ) 、のログを出力できる。</td>
</tr>
</tbody>
</table>
<p><br></p>
<h3 id="terraform">Terraformの公式モジュールの場合<a class="headerlink" href="#terraform" title="Permanent link">&para;</a></h3>
<p>ここでは、Terraformの公式モジュールを使用する。</p>
<div class="highlight"><pre><span></span><code><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;eks&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;terraform-aws-modules/eks/aws&quot;</span>

<span class="w">  </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&lt;モジュールのバージョン&gt;&quot;</span>

<span class="w">  </span><span class="na">cluster_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="err">foo-eks-cluster</span>
<span class="w">  </span><span class="na">cluster_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&lt;Kubernetesのバージョン&gt;&quot;</span>

<span class="c1">  # kube-apiserverをプライベートアクセスにするか否か</span>
<span class="w">  </span><span class="na">cluster_endpoint_private_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>

<span class="c1">  # kube-apiserverにパブリックアクセスできるか否か</span>
<span class="w">  </span><span class="na">cluster_endpoint_public_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>

<span class="c1">  # EKS Clusterのkube-apiserverにアクセスできるCIDR</span>
<span class="w">  </span><span class="na">cluster_endpoint_public_access_cidrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*.*.*.*/32&quot;, &quot;*.*.*.*/32&quot;, &quot;*.*.*.*/32&quot;</span><span class="p">]</span>

<span class="c1">  # CloudWatchログに送信するログの種類</span>
<span class="w">  </span><span class="na">cluster_enabled_log_types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;api&quot;, &quot;audit&quot;, &quot;authenticator&quot;, &quot;controllerManager&quot;, &quot;scheduler&quot;</span><span class="p">,]</span>

<span class="c1">  # ログの保管期間</span>
<span class="w">  </span><span class="na">cluster_log_retention_in_days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">365</span>

<span class="c1">  # セキュリティグループを作成するか否か</span>
<span class="w">  </span><span class="na">cluster_create_security_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>

<span class="c1">  # セキュリティグループのID</span>
<span class="w">  </span><span class="na">cluster_security_group_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;*****&quot;</span>

<span class="c1">  # IRSAを有効化するか否か</span>
<span class="w">  </span><span class="na">enable_irsa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>

<span class="c1">  # ワーカーNodeのセキュリティグループを作成するか否か</span>
<span class="w">  </span><span class="na">worker_create_security_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>

<span class="c1">  # VPCのID</span>
<span class="w">  </span><span class="na">vpc_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;vpc-*****&quot;</span>

<span class="c1">  # サブネットのID</span>
<span class="w">  </span><span class="na">subnets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;subnet-*****&quot;, &quot;subnet-*****&quot;, &quot;subnet-*****&quot;</span><span class="p">]</span>

<span class="c1">  # AWS EKSアドオン</span>
<span class="w">  </span><span class="nb">cluster_addons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nb">coredns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">resolve_conflicts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;OVERWRITE&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">kube-proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">resolve_conflicts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;OVERWRITE&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">vpc-cni</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">resolve_conflicts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;OVERWRITE&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">  # AWS EKSマネージドグループ</span>
<span class="w">  </span><span class="nb">eks_managed_node_groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">node_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;foo-group&quot;</span>
<span class="w">    </span><span class="na">instance_types</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;m5.large&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="na">min_size</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>
<span class="w">    </span><span class="na">max_size</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="m">4</span>
<span class="w">    </span><span class="na">desired_size</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest#usage">https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest#usage</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="eks-cluster">EKS Clusterの認証情報の追加<a class="headerlink" href="#eks-cluster" title="Permanent link">&para;</a></h3>
<p><code>kubectl</code>コマンドでEKS Clusterを操作するためには、<code>kubeconfig</code>ファイルへClusterの認証情報を登録する必要がある。</p>
<dl>
<dt><code>(1)</code></dt>
<dd>
<p>AWS CLIに認証情報を設定する。</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>aws<span class="w"> </span>configure
</code></pre></div>
<dl>
<dt><code>(2)</code></dt>
<dd>
<p>EKS Clusterの名前を指定して、<code>kubeconfig</code>ファイルにClusterの認証情報を登録する。</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>aws<span class="w"> </span>eks<span class="w"> </span>update-kubeconfig<span class="w"> </span>--region<span class="w"> </span>ap-northeast-1<span class="w"> </span>--name<span class="w"> </span>foo-eks-cluster
</code></pre></div>
<dl>
<dt><code>(3)</code></dt>
<dd>
<p><code>kubectl</code>コマンドの向き先を、EKS Clusterのkube-apiserverに変更する。</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>&lt;ClusterのARN&gt;
</code></pre></div>
<dl>
<dt><code>(4)</code></dt>
<dd>
<p><code>kubectl</code>コマンドの接続を確認する。</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pod
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/getting-started-console.html">https://docs.aws.amazon.com/eks/latest/userguide/getting-started-console.html</a></li>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/dashboard-tutorial.html#deploy-dashboard">https://docs.aws.amazon.com/eks/latest/userguide/dashboard-tutorial.html#deploy-dashboard</a></li>
</ul>
</blockquote>
<p><br></p>
<h2 id="02">02. コントロールプレーンのコンポーネント<a class="headerlink" href="#02" title="Permanent link">&para;</a></h2>
<h3 id="_9">対応関係<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>コントロールプレーン上のAWSリソース</th>
<th>Kubernetesリソース</th>
<th>補足</th>
</tr>
</thead>
<tbody>
<tr>
<td>EKSコントロールプレーン</td>
<td>コントロールプレーンNode</td>
<td>- <a href="https://docs.aws.amazon.com/eks/latest/userguide/platform-versions.html">https://docs.aws.amazon.com/eks/latest/userguide/platform-versions.html</a></td>
</tr>
<tr>
<td>kube-apiserver</td>
<td>kube-apiserver</td>
<td></td>
</tr>
<tr>
<td>kube-apiserverのロードバランサー (例：HAProxy)</td>
<td>NLB</td>
<td></td>
</tr>
</tbody>
</table>
<p><br></p>
<h3 id="kube-apiserver">kube-apiserver<a class="headerlink" href="#kube-apiserver" title="Permanent link">&para;</a></h3>
<h4 id="kubernetes-rbac">▼ Kubernetes RBACとの連携<a class="headerlink" href="#kubernetes-rbac" title="Permanent link">&para;</a></h4>
<p><img alt="eks_auth_architecture" src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/eks_auth_architecture.png" /></p>
<p>KubernetesのRBACと連携することにより、<code>kubectl</code>クライアントの認可スコープを制御する。</p>
<p>Kubernetesリソースの認可スコープは、IRSAで制御する。</p>
<dl>
<dt><code>(1)</code></dt>
<dd>
<p>あらかじめ、クライアント (<code>kubectl</code>クライアント、Kubernetesリソース) に紐づくIAMユーザーを作成しておく。</p>
</dd>
<dt><code>(2)</code></dt>
<dd>
<p>IAMユーザーがkube-apiserverのURLにリクエストを送信する。</p>
<p>kube-apiserverは、aws-iam-authenticator-serverにWebhookを送信する。</p>
<p>admission-controllersアドオンのWebhookではないことに注意する。</p>
</dd>
<dt><code>(3)</code></dt>
<dd>
<p>コントロールプレーンNode上のaws-iam-authenticator-serverは、IAM APIを使用してIAMユーザーを認証する。</p>
</dd>
<dt><code>(4)</code></dt>
<dd>
<p>もし認証に成功していた場合に、aws-iam-authenticator-serverは、ConfigMap (aws-auth) を確認する。</p>
<p>このConfigMapには、そのIAMユーザーに紐づくUserAccount / ServiceAccount / Group、RoleBinding / ClusterRoleBinding、が定義されている。</p>
<p>この時、<code>kubectl</code>クライアントの場合はUserAccount、Kubernetesリソースの場合はServiceAccount、を取得する。</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws-auth</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">mapAccounts</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">  </span><span class="nt">mapUsers</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">  </span><span class="nt">mapRoles</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">- rolearn: arn:aws:iam::&lt;AWSアカウントID&gt;:role/foo-role # IAMロール名</span>
<span class="w">      </span><span class="no">username: hiroki-it # IAMユーザー名</span>
<span class="w">      </span><span class="no">groups:</span>
<span class="w">        </span><span class="no">- system:masters # ClusterRoleBindingに定義されたGroup名</span>
<span class="w">    </span><span class="no">- rolearn: arn:aws:iam::&lt;AWSアカウントID&gt;:role/bar-role # ワーカーNodeに紐付けたロール名</span>
<span class="w">      </span><span class="no">username: system:node:{{EC2PrivateDNSName}} # ワーカーNodeの識別子</span>
<span class="w">      </span><span class="no">groups:</span>
<span class="w">        </span><span class="no">- system:bootstrappers</span>
<span class="w">        </span><span class="no">- system:nodes</span>
</code></pre></div>
<dl>
<dt><code>(5)</code></dt>
<dd>
<p>aws-iam-authenticator-serverは、UserAccount / ServiceAccount / Group、RoleBindingやClusterRoleBinding、の情報を含むレスポンスをkube-apiserverに返信する。</p>
</dd>
<dt><code>(6)</code></dt>
<dd>
<p>あとは、Kubernetesの標準の認可の仕組みである。</p>
<p>kube-apiserverは、UserAccount / ServiceAccount / Groupに紐づくRoleやClusterRoleを、RoleBindingやClusterRoleBindingを介して取得する。</p>
<p>IAMユーザーは、Kubernetesリソースを操作できる。</p>
</dd>
</dl>
<blockquote>
<ul>
<li><a href="https://aws.amazon.com/blogs/containers/kubernetes-rbac-and-iam-integration-in-amazon-eks-using-a-java-based-kubernetes-operator/">https://aws.amazon.com/blogs/containers/kubernetes-rbac-and-iam-integration-in-amazon-eks-using-a-java-based-kubernetes-operator/</a></li>
<li><a href="https://dzone.com/articles/amazon-eks-authentication-amp-authorization-proces">https://dzone.com/articles/amazon-eks-authentication-amp-authorization-proces</a></li>
<li><a href="https://katainaka0503.hatenablog.com/entry/2019/12/07/091737">https://katainaka0503.hatenablog.com/entry/2019/12/07/091737</a></li>
<li><a href="https://www.karakaram.com/eks-system-masters-group/">https://www.karakaram.com/eks-system-masters-group/</a></li>
<li><a href="https://zenn.dev/nameless_gyoza/articles/eks-authentication-authorization-20210211#1.-%E5%A4%96%E9%83%A8%E3%81%8B%E3%82%89eks%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88">https://zenn.dev/nameless_gyoza/articles/eks-authentication-authorization-20210211#1.-%E5%A4%96%E9%83%A8%E3%81%8B%E3%82%89eks%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88</a></li>
</ul>
</blockquote>
<h4 id="_10">▼ パブリックアクセス/プライベートアクセス<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p>kube-apiserverのインターネットへの公開範囲を設定できる。</p>
<p>プライベートアクセスの場合、VPC内部からのみアクセスできるように制限でき、送信元IPアドレスを指定してアクセスを許可できる。</p>
<blockquote>
<ul>
<li><a href="https://dev.classmethod.jp/articles/eks-public-endpoint-access-restriction/">https://dev.classmethod.jp/articles/eks-public-endpoint-access-restriction/</a></li>
</ul>
</blockquote>
<p><br></p>
<h2 id="03">03. データプレーンのコンポーネント<a class="headerlink" href="#03" title="Permanent link">&para;</a></h2>
<h3 id="_11">対応関係<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p><img alt="eks" src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/eks.png" /></p>
<table>
<thead>
<tr>
<th>データプレーン上のAWSリソース</th>
<th>Kubernetesリソース</th>
<th>補足</th>
</tr>
</thead>
<tbody>
<tr>
<td>FargateワーカーNode、EC2ワーカーNode</td>
<td>ワーカーNode</td>
<td>- <a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-compute.html">https://docs.aws.amazon.com/eks/latest/userguide/eks-compute.html</a></td>
</tr>
<tr>
<td>EKS Cluster</td>
<td>Cluster</td>
<td>- <a href="https://docs.aws.amazon.com/eks/latest/userguide/clusters.html">https://docs.aws.amazon.com/eks/latest/userguide/clusters.html</a></td>
</tr>
<tr>
<td>AWS ALB</td>
<td>Ingress</td>
<td>IngressはAWS ALBに置き換える必要がある。AWS Load Balancerコントローラーを作成すると、AWS ALBは自動的に作成される。<br>・<a href="https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html">https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html</a> <br>・<a href="https://blog.linkode.co.jp/entry/2020/06/26/095917#AWS-ALB-Ingress-Controller-for-Kubernetes">https://blog.linkode.co.jp/entry/2020/06/26/095917#AWS-ALB-Ingress-Controller-for-Kubernetes</a></td>
</tr>
<tr>
<td>AWS Load Balancerコントローラー</td>
<td>Ingressコントローラー</td>
<td>AWS ALBを自動的に作成する。- <a href="https://aws.amazon.com/jp/blogs/news/using-alb-ingress-controller-with-amazon-eks-on-fargate/">https://aws.amazon.com/jp/blogs/news/using-alb-ingress-controller-with-amazon-eks-on-fargate/</a></td>
</tr>
<tr>
<td>API Gateway + NLB</td>
<td></td>
<td>- <a href="https://aws.amazon.com/jp/blogs/news/api-gateway-as-an-ingress-controller-for-eks/">https://aws.amazon.com/jp/blogs/news/api-gateway-as-an-ingress-controller-for-eks/</a></td>
</tr>
<tr>
<td>EBS、EFS</td>
<td>PersistentVolume</td>
<td>- <a href="https://docs.aws.amazon.com/eks/latest/userguide/storage.html">https://docs.aws.amazon.com/eks/latest/userguide/storage.html</a></td>
</tr>
<tr>
<td>Secrets Manager</td>
<td>Secret</td>
<td>- <a href="https://docs.aws.amazon.com/eks/latest/userguide/manage-secrets.html">https://docs.aws.amazon.com/eks/latest/userguide/manage-secrets.html</a></td>
</tr>
<tr>
<td>IAMユーザー</td>
<td>ServiceAccount、UserAccount</td>
<td>- <a href="https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html">https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html</a></td>
</tr>
<tr>
<td>IAMロール</td>
<td>Role、ClusterRole</td>
<td>- <a href="https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html">https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html</a></td>
</tr>
</tbody>
</table>
<blockquote>
<ul>
<li><a href="https://zenn.dev/yoshinori_satoh/articles/2021-02-13-eks-ecs-compare">https://zenn.dev/yoshinori_satoh/articles/2021-02-13-eks-ecs-compare</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="eks-cluster_1">EKS Cluster<a class="headerlink" href="#eks-cluster_1" title="Permanent link">&para;</a></h3>
<h4 id="eks-cluster_2">▼ EKS Clusterとは<a class="headerlink" href="#eks-cluster_2" title="Permanent link">&para;</a></h4>
<p>FargateワーカーNodeやEC2ワーカーNodeの管理グループ単位のこと。</p>
<p>KubernetesのClusterに相当する。</p>
<blockquote>
<ul>
<li><a href="https://www.sunnycloud.jp/column/20210315-01/">https://www.sunnycloud.jp/column/20210315-01/</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="node">マルチワーカーNode<a class="headerlink" href="#node" title="Permanent link">&para;</a></h3>
<h4 id="node_1">▼ マルチワーカーNodeとは<a class="headerlink" href="#node_1" title="Permanent link">&para;</a></h4>
<p>マルチワーカーNodeを作成する場合、AZごとにNodeを作成する。</p>
<p><img alt="eks_multi-node" src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/eks_multi-node.png" /></p>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-networking.html">https://docs.aws.amazon.com/eks/latest/userguide/eks-networking.html</a></li>
</ul>
</blockquote>
<h4 id="node_2">▼ ワーカーNode間のファイル共有<a class="headerlink" href="#node_2" title="Permanent link">&para;</a></h4>
<p>EFSを使用して、ワーカーNode間でファイルを共有する。</p>
<p>PodのファイルはワーカーNodeにマウントされるため、異なるワーカーNode上のPod間でファイルを共有したい場合 (例：PrometheusのローカルストレージをPod間で共有したい) に役立つ。</p>
<p>ただしできるだけ、ワーカーNodeをステートフルではなくステートレスにする必要があり、PodのファイルはワーカーNodeの外で管理する必要がある。</p>
<blockquote>
<ul>
<li><a href="https://blog.linkode.co.jp/entry/2020/07/01/142155">https://blog.linkode.co.jp/entry/2020/07/01/142155</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="irsaiam-roles-for-service-accounts">IRSA：IAM Roles for Service Accounts<a class="headerlink" href="#irsaiam-roles-for-service-accounts" title="Permanent link">&para;</a></h3>
<h4 id="irsa">▼ IRSAとは<a class="headerlink" href="#irsa" title="Permanent link">&para;</a></h4>
<p><img alt="eks_oidc.png" src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/eks_oidc.png" /></p>
<p>特にKubernetesリソースの認可スコープを制御する仕組みのこと。</p>
<p><code>kubectl</code>クライアントの認可スコープは、RBACで制御する。</p>
<p>EKSをSSOのIDプロバイダーとして使用することにより、IAMの認証フェーズをEKSに委譲する。</p>
<h4 id="_12">▼ セットアップ<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p>ここでは、SSOの種類でOIDCを選ぶとする。</p>
<dl>
<dt><code>(1)</code></dt>
<dd>
<p>SSOのIDプロバイダーのタイプは、OIDCとする。</p>
<p>『EKS ClusterのOIDCプロバイダーURL』『OIDCプロバイダーのSSL証明書を署名する中間CA認証局 (例：CertificateManagerなど) のサムプリント』『IDプロバイダーによるトークンの発行対象 (<code>sts.amazonaws.com</code>)』を使用して、OIDCプロバイダーを作成する。</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;tls_certificate&quot;</span><span class="w"> </span><span class="nv">&quot;this&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">module.foo_eks.cluster_oidc_issuer_url</span>
<span class="p">}</span>

<span class="c1"># OIDCのIDプロバイダーをAWSに登録する。</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_openid_connect_provider&quot;</span><span class="w"> </span><span class="nv">&quot;this&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">url</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="nv">module.foo_eks.cluster_oidc_issuer_url</span>
<span class="w">  </span><span class="na">client_id_list</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;sts.amazonaws.com&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="na">thumbprint_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.tls_certificate.this[0].certificates</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="err">sha</span><span class="m">1</span><span class="err">_fingerprint</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foo-pod</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app:1.0.0</span>
<span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/secrets/kubernetes.io/serviceaccount</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-api-access-*****</span>
<span class="w">          </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="c1"># OIDCのプロバイダーによるトークンをコンテナにマウントする</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/secrets/eks.amazonaws.com/serviceaccount</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws-iam-token</span>
<span class="w">          </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-api-access-*****</span>
<span class="w">      </span><span class="nt">projected</span><span class="p">:</span>
<span class="w">        </span><span class="nt">defaultMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">420</span>
<span class="w">        </span><span class="nt">sources</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">serviceAccountToken</span><span class="p">:</span>
<span class="w">              </span><span class="nt">expirationSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3607</span>
<span class="w">              </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">token</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">configMap</span><span class="p">:</span>
<span class="w">              </span><span class="nt">items</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ca.crt</span>
<span class="w">                  </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ca.crt</span>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-root-ca.crt</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">downwardAPI</span><span class="p">:</span>
<span class="w">              </span><span class="nt">items</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">fieldRef</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="w">                    </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metadata.namespace</span>
<span class="w">                  </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">namespace</span>
<span class="w">    </span><span class="c1"># AWS EKSを使用している場合、AWS-APIへのリクエストに必要なトークンも設定される</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws-iam-token</span>
<span class="w">      </span><span class="nt">projected</span><span class="p">:</span>
<span class="w">        </span><span class="nt">defaultMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">420</span>
<span class="w">        </span><span class="nt">sources</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">serviceAccountToken</span><span class="p">:</span>
<span class="w">              </span><span class="c1"># OIDCのIDプロバイダーによるトークンの発行対象</span>
<span class="w">              </span><span class="nt">audience</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sts.amazonaws.com</span>
<span class="w">              </span><span class="nt">expirationSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">86400</span>
<span class="w">              </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">token</span>
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/enable-iam-roles-for-service-accounts.html">https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/enable-iam-roles-for-service-accounts.html</a></li>
<li><a href="https://zenn.dev/nameless_gyoza/articles/eks-authentication-authorization-20210211#%E7%99%BB%E9%8C%B2%E6%89%8B%E9%A0%86-1">https://zenn.dev/nameless_gyoza/articles/eks-authentication-authorization-20210211#%E7%99%BB%E9%8C%B2%E6%89%8B%E9%A0%86-1</a></li>
<li><a href="https://onsd.hatenablog.com/entry/2019/09/21/015522">https://onsd.hatenablog.com/entry/2019/09/21/015522</a></li>
<li><a href="https://github.com/terraform-aws-modules/terraform-aws-eks/blob/v19.16.0/main.tf#L223-L242">https://github.com/terraform-aws-modules/terraform-aws-eks/blob/v19.16.0/main.tf#L223-L242</a></li>
<li><a href="https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_roles_providers_create_oidc_verify-thumbprint.html">https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_roles_providers_create_oidc_verify-thumbprint.html</a></li>
</ul>
</blockquote>
<dl>
<dt><code>(2)</code></dt>
<dd>
<p>IRSAで使用するIAMロールの信頼されたエンティティに、EKS ClusterのOIDCプロバイダーURLやユーザー名 (<code>system:serviceaccount:&lt;Namespac名&gt;:&lt;ServiceAccount名&gt;</code>) を設定する。</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">{</span><span class="s">&quot;Version&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;2012-10-17&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;Statement&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">      </span><span class="p p-Indicator">{</span>
<span class="w">        </span><span class="s">&quot;Sid&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;Effect&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Allow&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;Principal&quot;</span><span class="p p-Indicator">:</span>
<span class="w">          </span><span class="p p-Indicator">{</span>
<span class="w">            </span><span class="s">&quot;Federated&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;arn:aws:iam::&lt;AWSアカウントID&gt;:oidc-provider/&lt;EKS</span><span class="nv"> </span><span class="s">ClusterのOIDCプロバイダーURL&gt;&quot;</span><span class="p p-Indicator">,</span>
<span class="w">          </span><span class="p p-Indicator">},</span>
<span class="w">        </span><span class="c1"># AssumeRoleWithWebIdentityを使用する</span>
<span class="w">        </span><span class="s">&quot;Action&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;sts:AssumeRoleWithWebIdentity&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;Condition&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">            </span><span class="c1"># 完全一致</span>
<span class="w">            </span><span class="s">&quot;StringEquals&quot;</span><span class="p p-Indicator">:</span>
<span class="w">              </span><span class="p p-Indicator">{</span>
<span class="w">                </span><span class="s">&quot;&lt;EKS</span><span class="nv"> </span><span class="s">ClusterのOIDCプロバイダーURL&gt;:sub&quot;</span><span class="p p-Indicator">:</span>
<span class="w">                  </span><span class="p p-Indicator">[</span><span class="s">&quot;system:serviceaccount:&lt;Namespac名&gt;:&lt;ServiceAccount名&gt;&quot;</span><span class="p p-Indicator">],</span>
<span class="w">              </span><span class="p p-Indicator">},</span>
<span class="w">          </span><span class="p p-Indicator">},</span>
<span class="w">      </span><span class="p p-Indicator">},</span>
<span class="w">    </span><span class="p p-Indicator">]}</span>
</code></pre></div>
<dl>
<dt><code>(3)</code></dt>
<dd>
<p>ServiceAccountの<code>.metadata.annotations.eks.amazonaws.com/role-arn</code>キーでIAMロールのARNを設定することにより、EKSで認証済みのServiceAccountにIAMロールを紐付けることができるようになる。</p>
<p><code>automountServiceAccountToken</code>キーが有効化されていることを確認する。</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">eks.amazonaws.com/role-arn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;IAMロールのARN&gt;</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;信頼されたエンティティで指定したユーザー名にあるServiceAccount名&gt;</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;信頼されたエンティティで指定したユーザー名にあるNamespace名&gt;</span>
<span class="nt">automountServiceAccountToken</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<dl>
<dt><code>(4)</code></dt>
<dd>
<p>Podで、ServiceAccount名を設定する。</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foo-pod</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foo-namespace</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foo-sa</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
<p>もし<code>.metadata.annotations.eks.amazonaws.com/role-arn</code>キーを使用しない場合、KubernetesリソースからAWSリソースへのアクセスがあった時は、EC2ワーカーNodeやFargateワーカーNodeのIAMロールが使用される。</p>
<p>IRSAが登場するまでは、EKS上でのワーカーNode (例：EC2、Fargate) にしかIAMロールを紐付けることができず、KubernetesリソースにIAMロールを直接的に紐付けることはできなかった。</p>
<p>ServiceAccountのトークンは、コンテナにファイルとしてマウントされている。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>printenv<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-f

<span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>ap-northeast-1
<span class="nv">AWS_REGION</span><span class="o">=</span>ap-northeast-1
<span class="nv">AWS_ROLE_ARN</span><span class="o">=</span>arn:aws:iam::&lt;アカウントID&gt;:role/argocd-reposerver
<span class="nv">AWS_STS_REGIONAL_ENDPOINTS</span><span class="o">=</span>regional
<span class="c1"># ServiceAccountのトークン文字列が記載されたファイル</span>
<span class="nv">AWS_WEB_IDENTITY_TOKEN_FILE</span><span class="o">=</span>/var/run/secrets/eks.amazonaws.com/serviceaccount/token

...
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://aws.amazon.com/jp/blogs/news/diving-into-iam-roles-for-service-accounts/">https://aws.amazon.com/jp/blogs/news/diving-into-iam-roles-for-service-accounts/</a></li>
<li><a href="https://www.bigtreetc.com/column/eks-irsa/">https://www.bigtreetc.com/column/eks-irsa/</a></li>
<li><a href="https://katainaka0503.hatenablog.com/entry/2019/12/07/091737#ServiceAccount%E3%81%AEIAM-%E3%83%AD%E3%83%BC%E3%83%ABIRSA">https://katainaka0503.hatenablog.com/entry/2019/12/07/091737#ServiceAccount%E3%81%AEIAM-%E3%83%AD%E3%83%BC%E3%83%ABIRSA</a></li>
<li><a href="https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/">https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/</a></li>
<li><a href="https://zenn.dev/nameless_gyoza/articles/eks-authentication-authorization-20210211#2.-eks%E3%81%8B%E3%82%89aws%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%B8%E3%81%A8%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88">https://zenn.dev/nameless_gyoza/articles/eks-authentication-authorization-20210211#2.-eks%E3%81%8B%E3%82%89aws%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%B8%E3%81%A8%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="_13">デバッグ<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<h4 id="_14">▼ ダッシュボード<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<dl>
<dt><code>(1)</code></dt>
<dd>
<p>EKS Clusterの名前を指定して、<code>kubeconfig</code>ファイルにClusterの認証情報を登録する。</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>aws<span class="w"> </span>eks<span class="w"> </span>update-kubeconfig<span class="w"> </span>--region<span class="w"> </span>ap-northeast-1<span class="w"> </span>--name<span class="w"> </span>foo-eks-cluster
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/getting-started-console.html">https://docs.aws.amazon.com/eks/latest/userguide/getting-started-console.html</a></li>
</ul>
</blockquote>
<dl>
<dt><code>(2)</code></dt>
<dd>
<p><code>kubectl</code>コマンドの向き先を、EKS Clusterのkube-apiserverに変更する。</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>&lt;ClusterのARN&gt;
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/dashboard-tutorial.html#deploy-dashboard">https://docs.aws.amazon.com/eks/latest/userguide/dashboard-tutorial.html#deploy-dashboard</a></li>
</ul>
</blockquote>
<dl>
<dt><code>(3)</code></dt>
<dd>
<p>マニフェストを使用して、ダッシュボードのKubernetesリソースをEKSにデプロイする。</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.5/aio/deploy/recommended.yaml
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/dashboard-tutorial.html#eks-admin-service-account">https://docs.aws.amazon.com/eks/latest/userguide/dashboard-tutorial.html#eks-admin-service-account</a></li>
</ul>
</blockquote>
<dl>
<dt><code>(4)</code></dt>
<dd>
<p>ダッシュボードに安全に接続するために、ServiceAccountをEKSにデプロイする</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>service-account.yml
</code></pre></div>
<dl>
<dt><code>(5)</code></dt>
<dd>
<p>トークン文字列を取得する。</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>describe<span class="w"> </span>secret<span class="w"> </span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>eks-admin<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
</code></pre></div>
<dl>
<dt><code>(6)</code></dt>
<dd>
<p>ローカルマシンからEKSにポートフォワーディングを実行する。</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>kubectl<span class="w"> </span>proxy
</code></pre></div>
<dl>
<dt><code>(7)</code></dt>
<dd>
<p>ダッシュボードに接続する。</p>
</dd>
</dl>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">GET http://127.0.0.1:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#!/login HTTP/1.1</span>
</code></pre></div>
<h4 id="node_3">▼ ワーカーNodeへの接続<a class="headerlink" href="#node_3" title="Permanent link">&para;</a></h4>
<p>セッションマネージャーを使用して、ワーカーNodeのEC2やFargateに接続できる。</p>
<p><br></p>
<h2 id="03-02">03-02. ネットワーク<a class="headerlink" href="#03-02" title="Permanent link">&para;</a></h2>
<h3 id="vpc">VPC、サブネット<a class="headerlink" href="#vpc" title="Permanent link">&para;</a></h3>
<p>EKSデータプレーンはプライベートサブネットで稼働させ、パブリックネットワーク上のALBからインバウンド通信を受信すると良い。</p>
<p>この時、パブリックネットワークにあるレジストリから、IstioやArgoCDのコンテナイメージをプルできるように、EKS FargateワーカーNodeとInternet Gateway間のネットワークを繋げる必要がある。</p>
<p>そのために、パブリックサブネットにNAT Gatewayを置く。</p>
<blockquote>
<ul>
<li><a href="https://aws.amazon.com/jp/blogs/news/de-mystifying-cluster-networking-for-amazon-eks-worker-nodes/">https://aws.amazon.com/jp/blogs/news/de-mystifying-cluster-networking-for-amazon-eks-worker-nodes/</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="_15">プライベートサブネット内のデータプレーンへのインバウンド通信<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<h4 id="pod">▼ Podへのインバウンド通信<a class="headerlink" href="#pod" title="Permanent link">&para;</a></h4>
<p>Podをプライベートサブネットに配置した場合に、パブリックネットワークからのインバウンド通信をAWS Load Balancerコントローラーで受信し、AWS ALBを使用してPodにルーティングする。</p>
<p><img alt="eks_architecture" src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/eks_architecture.png" /></p>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/patterns/deploy-a-grpc-based-application-on-an-amazon-eks-cluster-and-access-it-with-an-application-load-balancer.html">https://docs.aws.amazon.com/prescriptive-guidance/latest/patterns/deploy-a-grpc-based-application-on-an-amazon-eks-cluster-and-access-it-with-an-application-load-balancer.html</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="_16">コントロールプレーンへのインバウンド通信<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<h4 id="_17">▼ アクセス制限<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h4>
<p>コントロールプレーンでは、<code>kubectl</code>コマンドのエンドポイントとしてNLBが配置されている。</p>
<p>このNLBを介して、コントロールプレーン内のkube-apiserverにリクエストを送信できる。</p>
<p>VPC外からNLBへの<code>443</code>番ポートに対するネットワークからのアクセスはデフォルトでは許可されているが、拒否するように設定できる。</p>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/cluster-endpoint.html">https://docs.aws.amazon.com/eks/latest/userguide/cluster-endpoint.html</a></li>
</ul>
</blockquote>
<h4 id="_18">▼ パブリックのみ<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h4>
<p>基本的には、全てのIPアドレスからkube-apiserverにリクエストを送信できる。</p>
<h4 id="_19">▼ パブリックとプライベートの場合<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h4>
<p>パブリックとプライベートを許可する場合、指定したCIDRブロックに含まれるIPアドレスからのみ、kube-apiserverにリクエストを送信できる。</p>
<p>また、Cluster内からkube-apiserverへのアクセスには、VPCエンドポイントが必要である。</p>
<h4 id="_20">▼ プライベートのみ<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h4>
<p>プライベートのみを許可する場合、このNLBは閉じられ、VPC内からしかkube-apiserverにリクエストを送信できなくなる。</p>
<p>この状態で、<code>kubectl</code>コマンドでkube-apiserverにアクセスできるようにする方法としては、以下のパターンがある。</p>
<table>
<thead>
<tr>
<th>接続元パターン</th>
<th>接続方法パターン</th>
</tr>
</thead>
<tbody>
<tr>
<td>ローカルマシン</td>
<td>セッションマネージャー</td>
</tr>
<tr>
<td>VPC内の踏み台EC2インスタンス</td>
<td>セッションマネージャー、SSH</td>
</tr>
<tr>
<td>VPC内のCloud9</td>
<td>セッションマネージャー、SSH</td>
</tr>
</tbody>
</table>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/cluster-endpoint.html#private-access">https://docs.aws.amazon.com/eks/latest/userguide/cluster-endpoint.html#private-access</a></li>
<li><a href="https://note.com/tyrwzl/n/nf28cd4372b18">https://note.com/tyrwzl/n/nf28cd4372b18</a></li>
<li><a href="https://zenn.dev/yoshinori_satoh/articles/eks-kubectl-instance">https://zenn.dev/yoshinori_satoh/articles/eks-kubectl-instance</a></li>
</ul>
</blockquote>
<p><br></p>
<h2 id="04-on-ec2-ec2node">04. on-EC2 (EC2ワーカーNode)<a class="headerlink" href="#04-on-ec2-ec2node" title="Permanent link">&para;</a></h2>
<h3 id="ec2node">EC2ワーカーNode<a class="headerlink" href="#ec2node" title="Permanent link">&para;</a></h3>
<h4 id="ec2node_1">▼ EC2ワーカーNodeとは<a class="headerlink" href="#ec2node_1" title="Permanent link">&para;</a></h4>
<p>EC2で稼働するKubernetesのホストのこと。</p>
<p>Fargateと比べてカスタマイズ性が高く、ワーカーNode当たりで稼働するPod数に重み付けを設定できる。</p>
<p>一方で、各EC2のハードウェアリソースの消費量をユーザーが管理しなければならないため、Kubernetesのホストの管理が大変である。</p>
<p><img alt="eks_on_ec2" src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/eks_on_ec2.png" /></p>
<blockquote>
<ul>
<li><a href="https://www.sunnycloud.jp/column/20210315-01/">https://www.sunnycloud.jp/column/20210315-01/</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="_21">セットアップ<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<h4 id="iam">▼ IAMポリシー<a class="headerlink" href="#iam" title="Permanent link">&para;</a></h4>
<p>EC2ワーカーNodeが、自身の所属するClusterにアクセスできるように、EC2ワーカーNodeに<code>AmazonEKSWorkerNodePolicy</code>を付与する必要がある。</p>
<p>EC2ワーカーNode内のPodがECRからコンテナイメージをプルできるように、EC2ワーカーNodeに<code>AmazonEC2ContainerRegistryReadOnly</code>を付与する必要がある。</p>
<p>これにより、PodのコンテナごとにAWSの認証情報をマウントする必要がなくなる。</p>
<p><code>aws-node</code>のPodがAWSのネットワーク系のAPIにアクセスできるように、IRSA用のServiceAccountに<code>AmazonEKS_CNI_Policy</code> (IPv4の場合) または <code>AmazonEKS_CNI_IPv6_Policy</code> (IPv6の場合) を付与する必要がある。</p>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/create-node-role.html">https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/create-node-role.html</a></li>
<li><a href="https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AmazonEKSWorkerNodePolicy.html">https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AmazonEKSWorkerNodePolicy.html</a></li>
<li><a href="https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AmazonEC2ContainerRegistryReadOnly.html">https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AmazonEC2ContainerRegistryReadOnly.html</a></li>
<li><a href="https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AmazonEKS_CNI_Policy.html">https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AmazonEKS_CNI_Policy.html</a></li>
</ul>
</blockquote>
<p><br></p>
<h2 id="04-02-node-on-ec2">04-02. Nodeグループ (on-EC2)<a class="headerlink" href="#04-02-node-on-ec2" title="Permanent link">&para;</a></h2>
<h3 id="_22">マネージド<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<h4 id="node_4">▼ マネージドNodeグループ<a class="headerlink" href="#node_4" title="Permanent link">&para;</a></h4>
<ul>
<li>Nodeグループ内の各EC2ワーカーNodeの作成</li>
<li>Nodeグループに紐づくAutoScalingグループの作成</li>
<li>EC2ワーカーNodeのOSやミドルウェアの各種アップグレード</li>
</ul>
<p>を自動化する。</p>
<p>Nodeグループは、EC2ワーカーNodeが配置されるプライベートサブネットのAZにこれをスケジューリングするように、AutoScalingグループに各AZを自動的に設定する。</p>
<p>AutoScalingグループの機能を使用すれば、EC2ワーカーNodeの自動的な起動/停止を設定できる。</p>
<p>ただ、Nodeのスケーリングツール (例：ClusterAutoscaler、Karpenter、など) を使用しないと、AutoScalingグループのスケーリング機能を使用できない。</p>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/managed-node-groups.html">https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/managed-node-groups.html</a></li>
<li><a href="https://www.techtarget.com/searchaws/tip/2-options-to-deploy-Kubernetes-on-AWS-EKS-vs-self-managed">https://www.techtarget.com/searchaws/tip/2-options-to-deploy-Kubernetes-on-AWS-EKS-vs-self-managed</a></li>
<li><a href="https://www.reddit.com/r/kubernetes/comments/v8pckh/eks_selfmanaged_nodes_vs_node_group/">https://www.reddit.com/r/kubernetes/comments/v8pckh/eks_selfmanaged_nodes_vs_node_group/</a></li>
</ul>
</blockquote>
<h4 id="node_5">▼ Nodeグループの定期アクション<a class="headerlink" href="#node_5" title="Permanent link">&para;</a></h4>
<p>同じNodeグループのEC2ワーカーNodeの定期アクションを設定する。</p>
<p>EKSのテスト環境の請求料金を節約するために、昼間に通常の個数にスケールアウトし、夜間に<code>0</code>個にスケールインするようにすれば、ワーカーNodeを夜間だけ停止させられる。</p>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html">https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html</a></li>
<li><a href="https://blog.framinal.life/entry/2020/07/19/044328#%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89%E5%9E%8B%E3%83%8E%E3%83%BC%E3%83%89%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97">https://blog.framinal.life/entry/2020/07/19/044328#%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89%E5%9E%8B%E3%83%8E%E3%83%BC%E3%83%89%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="_23">セルフマネージド<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<h4 id="node_6">▼ セルフマネージドNodeグループ<a class="headerlink" href="#node_6" title="Permanent link">&para;</a></h4>
<ul>
<li>Nodeグループ内の各EC2ワーカーNodeの作成</li>
<li>Nodeグループに紐づくAutoScalingグループの作成</li>
<li>EC2ワーカーNodeのOSやミドルウェアの各種アップグレード</li>
</ul>
<p>をユーザーが管理する。</p>
<p>AutoScalingグループの機能を使用すれば、EC2ワーカーNodeの自動的な起動/停止を設定できる。</p>
<p>ただ、Nodeのスケーリングツール (例：ClusterAutoscaler、Karpenter、など) を使用しないと、AutoScalingグループのスケーリング機能を使用できない。</p>
<blockquote>
<ul>
<li><a href="https://www.techtarget.com/searchaws/tip/2-options-to-deploy-Kubernetes-on-AWS-EKS-vs-self-managed">https://www.techtarget.com/searchaws/tip/2-options-to-deploy-Kubernetes-on-AWS-EKS-vs-self-managed</a></li>
<li><a href="https://www.reddit.com/r/kubernetes/comments/v8pckh/eks_selfmanaged_nodes_vs_node_group/">https://www.reddit.com/r/kubernetes/comments/v8pckh/eks_selfmanaged_nodes_vs_node_group/</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="ec2nodeami">EC2ワーカーNodeの最適化AMI<a class="headerlink" href="#ec2nodeami" title="Permanent link">&para;</a></h3>
<h4 id="ec2nodeami_1">▼ EC2ワーカーNodeの最適化AMIとは<a class="headerlink" href="#ec2nodeami_1" title="Permanent link">&para;</a></h4>
<p>任意のEC2ワーカーNodeを使用できるが、AWSが用意している最適化AMIを選んだ方が良い。</p>
<p>このAMIには、EC2がEKSと連携するために必要なソフトウェアがプリインストールされており、EC2ワーカーNodeをセットアップする手間が省ける。</p>
<p>必ずしも、全てのEC2ワーカーNodeを同じAMIで構築する必要はない。</p>
<p>EC2ワーカーNodeを種類ごとに異なるAMIで作成し、特定のアプリを含むPodは特定のEC2ワーカーNodeにスケジューリングする (例：計算処理系アプリはEKS最適化高速AMIのEC2ワーカーNode上で動かす) といった方法でもよい。</p>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-optimized-ami.html">https://docs.aws.amazon.com/eks/latest/userguide/eks-optimized-ami.html</a></li>
</ul>
</blockquote>
<h4 id="eks-amazon-linux">▼ EKS 最適化 Amazon Linux<a class="headerlink" href="#eks-amazon-linux" title="Permanent link">&para;</a></h4>
<p>EKSのための標準的なEC2インスタンスを作成できる。最も推奨である。</p>
<p><code>aws ssm get-parameter</code>コマンドを使用すると、公式が提供するマシンイメージのIDを確認できる。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>aws<span class="w"> </span>ssm<span class="w"> </span>get-parameter<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--name<span class="w"> </span>/aws/service/eks/optimized-ami/&lt;バージョン&gt;/amazon-linux-2/recommended/image_id<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--region<span class="w"> </span>ap-northeast-1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--query<span class="w"> </span><span class="s2">&quot;Parameter.Value&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--output<span class="w"> </span>text
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-optimized-ami.html">https://docs.aws.amazon.com/eks/latest/userguide/eks-optimized-ami.html</a></li>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/retrieve-ami-id.html">https://docs.aws.amazon.com/eks/latest/userguide/retrieve-ami-id.html</a></li>
</ul>
</blockquote>
<h4 id="eks-amazon-linux_1">▼ EKS 最適化高速 Amazon Linux<a class="headerlink" href="#eks-amazon-linux_1" title="Permanent link">&para;</a></h4>
<p>GPUが搭載されたEC2インスタンスやAmazon EC2 Inf1インスタンスを作成できる。</p>
<p>GPUが必要なアプリケーションの含むPod (計算処理系、機械学習系のアプリケーション) と相性が良い。</p>
<h4 id="eks-arm-amazon-linux">▼ EKS 最適化 ARM Amazon Linux<a class="headerlink" href="#eks-arm-amazon-linux" title="Permanent link">&para;</a></h4>
<p>ARMベースのプロセッサーが搭載されたEC2インスタンスを作成できる。</p>
<h4 id="eks-bottlerocket-ami">▼ EKS 最適化 Bottlerocket AMI<a class="headerlink" href="#eks-bottlerocket-ami" title="Permanent link">&para;</a></h4>
<p>コンテナに特化したEC2インスタンスを作成できる。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>aws<span class="w"> </span>ssm<span class="w"> </span>get-parameter<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--name<span class="w"> </span>/aws/service/bottlerocket/aws-k8s-&lt;バージョン&gt;/x86_64/latest/image_id<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--region<span class="w"> </span>ap-northeast-1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--query<span class="w"> </span><span class="s2">&quot;Parameter.Value&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--output<span class="w"> </span>text
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://dev.classmethod.jp/articles/bottlerocket/#toc-1">https://dev.classmethod.jp/articles/bottlerocket/#toc-1</a></li>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-optimized-ami-bottlerocket.html">https://docs.aws.amazon.com/eks/latest/userguide/eks-optimized-ami-bottlerocket.html</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="ec2nodeami_2">EC2ワーカーNodeのカスタムAMI<a class="headerlink" href="#ec2nodeami_2" title="Permanent link">&para;</a></h3>
<h4 id="ec2nodeami_3">▼ EC2ワーカーNodeのカスタムAMIとは<a class="headerlink" href="#ec2nodeami_3" title="Permanent link">&para;</a></h4>
<p>EC2ワーカーNodeの最適化AMIではないAMIのこと。</p>
<p>EC2ワーカーNodeのAMIにカスタムAMIを使用する場合、EC2ワーカーNode起動時のユーザーデータ内で、<code>bootstrap.sh</code>ファイルに決められたパラメーターを渡す必要がある。</p>
<p>注意点として、最適化AMIにはデフォルトでこれらのパラメーターが設定されているため、設定は不要である。</p>
<blockquote>
<ul>
<li><a href="https://aws.amazon.com/jp/premiumsupport/knowledge-center/eks-worker-nodes-cluster/">https://aws.amazon.com/jp/premiumsupport/knowledge-center/eks-worker-nodes-cluster/</a></li>
</ul>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>xtrace

<span class="c1"># 主要なパラメーターは以下の通り。</span>
<span class="c1"># その他のパラメーター：https://github.com/awslabs/amazon-eks-ami/blob/584f9a56c76fc9e7e8632f6ea45e29d45f2eab63/files/bootstrap.sh#L14-L35</span>
<span class="c1">#</span>
<span class="c1"># --b64-cluster-ca：kube-apiserverのSSL証明書の値を設定する。</span>
<span class="c1"># --apiserver-endpoint：kube-apiserverのエンドポイントを設定する。</span>
<span class="c1"># --container-runtime：コンテナランタイムとしてcontainerdを使用する。代わりとして、dockerも使用できる。</span>

/etc/eks/bootstrap.sh<span class="w"> </span>foo-eks-cluster<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--b64-cluster-ca<span class="w"> </span>*****<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--apiserver-endpoint<span class="w"> </span>https://*****.gr7.ap-northeast-1.eks.amazonaws.com<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--container-runtime<span class="w"> </span>containerd
</code></pre></div>
<p>ユーザーデータ内で必要なパラメーターの注意点として、各パラメーターはハードコーディングしないようにする。</p>
<p>パラメーターストアにパラメーターを永続化し、ユーザーデータ内に出力するようにする。</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>xtrace

<span class="nv">PARAMETERS</span><span class="o">=</span><span class="k">$(</span>aws<span class="w"> </span>ssm<span class="w"> </span>get-parameters-by-path<span class="w"> </span>--with-decryption<span class="w"> </span>--path<span class="w"> </span><span class="s2">&quot;/eks/foo-eks-cluster&quot;</span><span class="k">)</span>

<span class="c1"># ClusterのSSL証明書、kube-apiserverのエンドポイントの値をパラメーターストアから取得する。</span>
<span class="k">for</span><span class="w"> </span>parameter<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="si">${</span><span class="nv">PARAMETERS</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.Parameters[] | .Name + &quot;=&quot; + .Value&#39;</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;export </span><span class="si">${</span><span class="nv">parameter</span><span class="p">##*/</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">done</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">EXPORT_ENVS</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># 出力する。</span>
<span class="nb">source</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">EXPORT_ENVS</span><span class="si">}</span><span class="s2">&quot;</span>

/etc/eks/bootstrap.sh<span class="w"> </span>foo-eks-cluster<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--b64-cluster-ca<span class="w"> </span><span class="nv">$B64_CLUSTER_CA</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--apiserver-endpoint<span class="w"> </span><span class="nv">$APISERVER_ENDPOINT</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--container-runtime<span class="w"> </span>containerd
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://qiita.com/th_/items/8ffb28dd6d27779a6c9d">https://qiita.com/th_/items/8ffb28dd6d27779a6c9d</a></li>
<li><a href="https://garafu.blogspot.com/2020/08/ec2-set-env-from-paramstore.html">https://garafu.blogspot.com/2020/08/ec2-set-env-from-paramstore.html</a></li>
</ul>
</blockquote>
<h4 id="ec2node_2">▼ EC2ワーカーNodeのイメージキャッシュ削除<a class="headerlink" href="#ec2node_2" title="Permanent link">&para;</a></h4>
<p>kubeletのガベージコレクションを使用して、イメージキャッシュを削除する。</p>
<p><code>--image-gc-high-threshold</code>オプションで、キャッシュ削除の閾値とするディスク使用率を設定する。</p>
<p><code>--image-gc-low-threshold</code>オプションで、解放しようとするディスク使用率を設定する。</p>
<p><strong>＊実装例＊</strong></p>
<p>ディスク使用率が<code>70</code>%を超過した場合に、ディスク使用率<code>50</code>%分を解放する。</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>xtrace

<span class="c1"># --image-gc-high-thresholdオプションに値が既に設定されていなければ、設定を挿入する。</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>imageGCHighThresholdPercent<span class="w"> </span>/etc/kubernetes/kubelet/kubelet-config.json<span class="p">;</span>
<span class="k">then</span>
<span class="w">    </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;/&quot;apiVersion*/a \ \ &quot;imageGCHighThresholdPercent&quot;: 70,&#39;</span><span class="w"> </span>/etc/kubernetes/kubelet/kubelet-config.json
<span class="k">fi</span>

<span class="c1"># --image-gc-low-thresholdオプションに値が既に設定されていなければ、設定を挿入する。</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>imageGCLowThresholdPercent<span class="w"> </span>/etc/kubernetes/kubelet/kubelet-config.json<span class="p">;</span>
<span class="k">then</span>
<span class="w">    </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;/&quot;imageGCHigh*/a \ \ &quot;imageGCLowThresholdPercent&quot;: 50,&#39;</span><span class="w"> </span>/etc/kubernetes/kubelet/kubelet-config.json
<span class="k">fi</span>

/etc/eks/bootstrap.sh<span class="w"> </span>your-cluster-name
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://aws.amazon.com/jp/premiumsupport/knowledge-center/eks-worker-nodes-image-cache/">https://aws.amazon.com/jp/premiumsupport/knowledge-center/eks-worker-nodes-image-cache/</a></li>
</ul>
</blockquote>
<h4 id="ec2node_3">▼ 安全なEC2ワーカーNodeシャットダウン<a class="headerlink" href="#ec2node_3" title="Permanent link">&para;</a></h4>
<p>kubeletを使用してワーカーNodeの停止を待機し、Podが終了する (ワーカーNodeを退避する) までの時間を稼ぐ。</p>
<p>ワーカーNodeの停止までの待機中に終了できたPodは、<code>Failed</code>ステータスとなる。</p>
<p>kubeletの<code>--shutdown-grace-period</code>オプション (<code>shutdownGracePeriod</code>) で、ワーカーNodeの停止を待機する期間を設定する。</p>
<p>また<code>--shutdown-grace-period-critical-pods</code>オプション (<code>shutdownGracePeriodCriticalPods</code>) で、特に重要なPodの終了のために待機する時間を設定する。</p>
<p><code>InhibitDelayMaxSec</code>には、<code>--shutdown-grace-period</code>オプションと同じ秒数 (単位は不要) を設定する。</p>
<p>注意点として、この時間が長すぎると、ワーカーNodeの停止の全体時間が長くなるため、結果的にローリングアップグレードでNodeの所要時間も長くなってしまう。</p>
<p><strong>＊実装例＊</strong></p>
<p>ワーカーNodeの停止を<code>6</code>分だけ待機し、その後に停止を始める。</p>
<p><code>6</code>分のうち後半<code>2</code>分を重要なPodのために停止に割り当てる。</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>xtrace

<span class="c1"># --shutdown-grace-periodオプションに値が既に設定されていなければ、設定を挿入する。</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>shutdownGracePeriod<span class="w"> </span>/etc/kubernetes/kubelet/kubelet-config.json<span class="p">;</span>
<span class="k">then</span>
<span class="w">    </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;/&quot;apiVersion*/a \ \ &quot;shutdownGracePeriod&quot;: &quot;360s&quot;,&#39;</span><span class="w"> </span>/etc/kubernetes/kubelet/kubelet-config.json
<span class="k">fi</span>

<span class="c1"># --shutdown-grace-period-critical-podsオプションに値が既に設定されていなければ、設定を挿入する。</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>shutdownGracePeriodCriticalPods<span class="w"> </span>/etc/kubernetes/kubelet/kubelet-config.json<span class="p">;</span>
<span class="k">then</span>
<span class="w">    </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;/&quot;shutdownGracePeriod*/a \ \ &quot;shutdownGracePeriodCriticalPods&quot;: &quot;120s&quot;,&#39;</span><span class="w"> </span>/etc/kubernetes/kubelet/kubelet-config.json
<span class="k">fi</span>

mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/systemd/logind.conf.d
cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt; /etc/systemd/logind.conf.d/50-max-delay.conf</span>
<span class="s">[Login]</span>
<span class="s">InhibitDelayMaxSec=360</span>
<span class="s">EOF</span>

sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>systemd-logind
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://blog.skouf.com/posts/enabling-graceful-node-shutdown-on-eks-in-kubernetes-1-21/">https://blog.skouf.com/posts/enabling-graceful-node-shutdown-on-eks-in-kubernetes-1-21/</a></li>
<li><a href="https://kubernetes.io/docs/concepts/architecture/nodes/#graceful-node-shutdown">https://kubernetes.io/docs/concepts/architecture/nodes/#graceful-node-shutdown</a></li>
</ul>
</blockquote>
<p><code>Failed</code>ステータスのPodはそのままでは削除できないため、以下のようなスクリプトを実行できるCronJobを作成するとよい。</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span>ns<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>namespace<span class="w"> </span>-o<span class="w"> </span>name<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="w"> </span>/<span class="w"> </span>-f<span class="w"> </span><span class="m">2</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$ns</span>
<span class="w">  </span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-n<span class="w"> </span><span class="nv">$ns</span><span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.items[] | select(.status.phase == &quot;Failed&quot;) | select(.status.reason == &quot;Shutdown&quot; or .status.reason == &quot;NodeShutdown&quot; or .status.reason == &quot;Terminated&quot;) | .metadata.name&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>--no-run-if-empty<span class="w"> </span>--max-args<span class="o">=</span><span class="m">100</span><span class="w"> </span>--verbose<span class="w"> </span>kubectl<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>-n<span class="w"> </span><span class="nv">$ns</span>
<span class="k">done</span>
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://github.com/yteraoka/terminated-pod-cleaner/blob/main/chart/templates/cronjob.yaml#L33-L36">https://github.com/yteraoka/terminated-pod-cleaner/blob/main/chart/templates/cronjob.yaml#L33-L36</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="ec2">EC2へのタグ付けの例<a class="headerlink" href="#ec2" title="Permanent link">&para;</a></h3>
<h4 id="node_7">▼ マネージドNodeグループ<a class="headerlink" href="#node_7" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>タグ</th>
<th>値</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Name</code></td>
<td>EC2ワーカーNodeの名前</td>
<td>Nodeグループで指定する起動テンプレートのリソースタグに、<code>Name</code>タグを設定しておく。起動するEC2ワーカーNodeにEC2インスタンスの名前は<code>Name</code>タグで決まる仕組みのため、起動テンプレートによってワーカーNode名を設定させることができる。</td>
</tr>
</tbody>
</table>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/launch-templates.html">https://docs.aws.amazon.com/eks/latest/userguide/launch-templates.html</a></li>
</ul>
</blockquote>
<h4 id="node_8">▼ セルフマネージドNodeグループ<a class="headerlink" href="#node_8" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>タグ</th>
<th>値</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Name</code></td>
<td>EC2ワーカーNodeの名前</td>
<td>EC2インスタンスの名前は<code>Name</code>タグで決まる仕組みのため、Nodeグループに参加させるEC2ワーカーNodeの<code>Name</code>タグに、ワーカーNode名を設定しておく。</td>
</tr>
<tr>
<td><code>kubernetes.io/cluster/&lt;EKS Cluster名&gt;</code></td>
<td><code>owned</code></td>
<td>セルフマネージド型のEC2ワーカーNodeを使用する場合、ユーザーが作成したEC2インスタンスをNodeグループに参加させるために、必要である。</td>
</tr>
</tbody>
</table>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/worker.html">https://docs.aws.amazon.com/eks/latest/userguide/worker.html</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="_24">パブリックサブネット内のデータプレーンからのアウトバウンド通信<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>Podをプライベートサブネットに配置した場合に、パブリックネットワークやVPC外にあるAWSリソース (ECR、S3、Systems Manager、CloudWatch、DynamoDB、など) に対してアウトバウンド通信を送信するために特に必要なものは無い。</p>
<p>この時、<code>POD_SECURITY_GROUP_ENFORCING_MODE=standard</code>に設定されたaws-eks-vpc-cniアドオンはSNAT処理を実行し、Podのアウトバウンド通信の送信元IPアドレスをEC2ワーカーNodeのプライマリーENI (<code>eth0</code>) のIPアドレスに変換する。</p>
<blockquote>
<ul>
<li><a href="https://note.com/tyrwzl/n/n715a8ef3c28a">https://note.com/tyrwzl/n/n715a8ef3c28a</a></li>
<li><a href="https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/security-groups-for-pods.html">https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/security-groups-for-pods.html</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="_25">プライベートサブネット内のデータプレーンからのアウトバウンド通信<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<h4 id="_26">▼ 宛先情報の管理方法<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h4>
<p>アウトバウンド通信の宛先情報は、Secretで管理し、Podにマウントするようにする。</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foo-secret</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># RDS (Aurora) の宛先情報</span>
<span class="w">  </span><span class="nt">DB_HOST_PRIMARY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;プライマリーインスタンスのエンドポイント&gt;</span>
<span class="w">  </span><span class="nt">DB_HOST_READ</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;リードレプリカのエンドポイント&gt;</span>
<span class="w">  </span><span class="nt">DB_USER</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bar</span>
<span class="w">  </span><span class="nt">DB_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">baz</span>
<span class="w">  </span><span class="c1"># SQSの宛先情報</span>
<span class="w">  </span><span class="nt">SQS_QUEUE_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foo-queue.fifo</span>
<span class="w">  </span><span class="nt">SQS_REGION</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ap-northeast-1</span>
</code></pre></div>
<h4 id="vpcaws">▼ VPC外の他のAWSリソースへのアウトバウンド通信<a class="headerlink" href="#vpcaws" title="Permanent link">&para;</a></h4>
<p>Podをプライベートサブネットに配置した場合に、パブリックネットワークやVPC外にあるAWSリソース (ECR、S3、Systems Manager、CloudWatch、DynamoDB、など) に対してアウトバウンド通信を送信するためには、NAT GatewayまたはVPCエンドポイントを配置する必要がある。</p>
<p>この時、Podのアウトバウンド通信の送信元IPアドレスは、NAT GatewayまたはVPCエンドポイントに紐づくIPアドレスになる。</p>
<p>以下のようなエラーでPodが起動しない場合、Podが何らかの理由でイメージをプルできない可能性がある。</p>
<p>また、Podが作成されない限り、ワーカーNodeも作成されないことに注意する。</p>
<div class="highlight"><pre><span></span><code>Pod provisioning timed out (will retry) for pod
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/network_reqs.html">https://docs.aws.amazon.com/eks/latest/userguide/network_reqs.html</a></li>
</ul>
</blockquote>
<h4 id="vpc_1">▼ VPC外のコントロールプレーンへのアウトバウンド通信<a class="headerlink" href="#vpc_1" title="Permanent link">&para;</a></h4>
<p>EKS Clusterを作成すると、ENIも作成する。</p>
<p>これにより、データプレーンがVPC外のコントロールプレーンと通信できるようになる。</p>
<p>執筆時点 (2022/05/27) では、データプレーンがコントロールプレーンとパケットを送受信するためには、VPCエンドポイントではなくNAT Gatewayを配置する必要がある。</p>
<blockquote>
<ul>
<li><a href="https://dev.classmethod.jp/articles/eks_basic/">https://dev.classmethod.jp/articles/eks_basic/</a></li>
<li><a href="https://aws.amazon.com/jp/blogs/news/de-mystifying-cluster-networking-for-amazon-eks-worker-nodes/">https://aws.amazon.com/jp/blogs/news/de-mystifying-cluster-networking-for-amazon-eks-worker-nodes/</a></li>
</ul>
</blockquote>
<h4 id="vpcaws_1">▼ VPC内の他のAWSリソースへのアウトバウンド通信<a class="headerlink" href="#vpcaws_1" title="Permanent link">&para;</a></h4>
<p>VPC内にあるAWSリソース (RDSなど) の場合、そのAWS側のセキュリティグループにて、PodのプライベートサブネットのCIDRブロックを許可すればよい。</p>
<p><br></p>
<h2 id="04-03">04-03. セットアップ<a class="headerlink" href="#04-03" title="Permanent link">&para;</a></h2>
<h3 id="_27">コンソール画面の場合<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<h4 id="node_9">▼ マネージドNodeグループの場合<a class="headerlink" href="#node_9" title="Permanent link">&para;</a></h4>
<p>起動テンプレートを使用し、EC2ワーカーNodeを作成する。</p>
<p>起動テンプレートのタグ付け機能を使用してEC2にタグ付けでき、これは任意である。</p>
<h4 id="node_10">▼ セルフマネージドNodeグループの場合<a class="headerlink" href="#node_10" title="Permanent link">&para;</a></h4>
<p>任意のAutoScalingにて、起動テンプレートを使用してEC2ワーカーNodeを作成する。</p>
<p>AutoScalingのタグ付け機能を使用して、<code>kubernetes.io/cluster/&lt;EKS Cluster名&gt;</code>タグ (値は<code>owned</code>) をつけ、Nodeグループに明示的に参加させる必要がある。</p>
<p>なお、起動テンプレートも合わせて使用でき、これは任意である。</p>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/worker.html">https://docs.aws.amazon.com/eks/latest/userguide/worker.html</a></li>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/launch-workers.html">https://docs.aws.amazon.com/eks/latest/userguide/launch-workers.html</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="terraform_1">Terraformの場合<a class="headerlink" href="#terraform_1" title="Permanent link">&para;</a></h3>
<h4 id="node_11">▼ マネージドNodeグループの場合<a class="headerlink" href="#node_11" title="Permanent link">&para;</a></h4>
<p>起動テンプレートを使用し、EC2ワーカーNodeを作成する。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Nodeグループ</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_eks_node_group&quot;</span><span class="w"> </span><span class="nv">&quot;foo&quot;</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="p">...</span>

<span class="c1">  # Nodeグループの種類だけ、起動テンプレートを設定する</span>
<span class="w">  </span><span class="nb">launch_template</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_launch_template.foo1.id</span>
<span class="w">    </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;$Latest&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">launch_template</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_launch_template.foo2.id</span>
<span class="w">    </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;$Latest&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>

<span class="c1"># 起動テンプレート</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_launch_template&quot;</span><span class="w"> </span><span class="nv">&quot;foo&quot;</span><span class="w"> </span><span class="p">{</span>

<span class="c1">  # タグ付けは任意である</span>
<span class="w">  </span><span class="nb">tag_specifications</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">Env</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>

<span class="c1"># Nodeグループのタグ</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_autoscaling_group_tag&quot;</span><span class="w"> </span><span class="nv">&quot;foo&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.tags</span>

<span class="w">  </span><span class="na">autoscaling_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_eks_node_group.foo.name</span>

<span class="c1">  # Nodeグループに設定する全てのタグに対して適用する</span>
<span class="w">  </span><span class="nb">tag</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">key</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="nv">each.key</span>
<span class="w">    </span><span class="na">value</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value</span>
<span class="c1">    # 実装時点 (2023/06/06) で、マネージドNodeグループは自身の作成するAutoScalingグループにタグ付けできない</span>
<span class="c1">    # そのままではterraform planのたびに、AutoScalingグループにタグ付けしようとする差分がでてしまうため、Nodeグループ外からAutoScalingグループのタグ付けを有効化する</span>
<span class="c1">    # @see</span>
<span class="c1">    # https://github.com/aws/containers-roadmap/issues/608</span>
<span class="c1">    # https://github.com/terraform-aws-modules/terraform-aws-eks/issues/1558#issuecomment-1030633280</span>
<span class="w">    </span><span class="na">propagate_at_launch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://github.com/terraform-aws-modules/terraform-aws-eks/blob/v19.16.0/modules/eks-managed-node-group/main.tf">https://github.com/terraform-aws-modules/terraform-aws-eks/blob/v19.16.0/modules/eks-managed-node-group/main.tf</a></li>
</ul>
</blockquote>
<h4 id="node_12">▼ セルフマネージドNodeグループの場合<a class="headerlink" href="#node_12" title="Permanent link">&para;</a></h4>
<p>任意のAutoScalingにて、起動テンプレートを使用してEC2ワーカーNodeを作成する。</p>
<div class="highlight"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_autoscaling_group&quot;</span><span class="w"> </span><span class="nv">&quot;foo&quot;</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nb">tag</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">key</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Name&quot;</span>
<span class="w">    </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;foo-instance&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">  # AutoScalingのタグに kubernetes.io/cluster/&lt;EKS Cluster名&gt; をつける必要がある</span>
<span class="w">  </span><span class="nb">tag</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">key</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;kubernetes.io/cluster/&lt;EKS Cluster名&gt;&quot;</span>
<span class="w">    </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;owned&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">  # 起動テンプレートは任意である</span>
<span class="w">  </span><span class="nb">launch_template</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_launch_template.foo.id</span>
<span class="w">    </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;$Latest&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<ul>
<li><a href="https://github.com/terraform-aws-modules/terraform-aws-eks/blob/v19.16.0/modules/self-managed-node-group/main.tf">https://github.com/terraform-aws-modules/terraform-aws-eks/blob/v19.16.0/modules/self-managed-node-group/main.tf</a></li>
</ul>
</blockquote>
<p><br></p>
<h2 id="05-on-fargate-fargatenode">05. on-Fargate (FargateワーカーNode)<a class="headerlink" href="#05-on-fargate-fargatenode" title="Permanent link">&para;</a></h2>
<h3 id="on-fargate-fargatenode">on-Fargate (FargateワーカーNode) とは<a class="headerlink" href="#on-fargate-fargatenode" title="Permanent link">&para;</a></h3>
<p><br></p>
<h2 id="05-02">05-02. セットアップ<a class="headerlink" href="#05-02" title="Permanent link">&para;</a></h2>
<h3 id="_28">コンソール画面の場合<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<h4 id="_29">▼ 制約<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h4>
<p>EC2にはない制約については、以下のリンクを参考にせよ。</p>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/fargate.html">https://docs.aws.amazon.com/eks/latest/userguide/fargate.html</a></li>
<li><a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/patterns/install-ssm-agent-on-amazon-eks-worker-nodes-by-using-kubernetes-daemonset.html">https://docs.aws.amazon.com/prescriptive-guidance/latest/patterns/install-ssm-agent-on-amazon-eks-worker-nodes-by-using-kubernetes-daemonset.html</a></li>
</ul>
</blockquote>
<h4 id="_30">▼ メトリクス収集<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h4>
<p>FargateワーカーNode内のメトリクスのデータポイントを収集する上で、FargateワーカーNodeはDaemonSetに非対応のため、メトリクス収集コンテナをサイドカーコンテナとして配置する必要がある。</p>
<p>収集ツールとして、OpenTelemetryをサポートしている。</p>
<blockquote>
<ul>
<li><a href="https://aws.amazon.com/jp/blogs/news/introducing-amazon-cloudwatch-container-insights-for-amazon-eks-fargate-using-aws-distro-for-opentelemetry/">https://aws.amazon.com/jp/blogs/news/introducing-amazon-cloudwatch-container-insights-for-amazon-eks-fargate-using-aws-distro-for-opentelemetry/</a></li>
</ul>
</blockquote>
<h4 id="_31">▼ ログルーティング<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h4>
<p>FargateワーカーNode内のログを転送する上で、FargateはDaemonSetに非対応のため、ログ転送コンテナをサイドカーコンテナとして配置する必要がある。</p>
<p>ロググーティングツールとして、FluentBitをサポートしている。</p>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-logging.html">https://docs.aws.amazon.com/eks/latest/userguide/fargate-logging.html</a></li>
</ul>
</blockquote>
<dl>
<dt><code>(1)</code></dt>
<dd>
<p>ログ転送コンテナのためのNamespaceを作成する。</p>
<p>名前は、必ず<code>aws-observability</code>とする。</p>
</dd>
</dl>
<blockquote>
<ul>
<li><a href="https://blog.mmmcorp.co.jp/blog/2021/08/11/post-1704/">https://blog.mmmcorp.co.jp/blog/2021/08/11/post-1704/</a></li>
</ul>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws-observability</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">aws-observability</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enabled</span>
</code></pre></div>
<dl>
<dt><code>(2)</code></dt>
<dd>
<p><code>aws-observability</code>内で<code>aws-logging</code>という名前のConfigMapを作成する。</p>
<p>これより、ログ転送コンテナとしてFluentBitコンテナが作成され、PodからCloudWatchログにログを送信できるようになる。</p>
<p>名前は、必ず<code>aws-logging</code>とする。</p>
</dd>
</dl>
<blockquote>
<ul>
<li><a href="https://blog.mmmcorp.co.jp/blog/2021/08/11/post-1704/">https://blog.mmmcorp.co.jp/blog/2021/08/11/post-1704/</a></li>
</ul>
</blockquote>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>config-map.yaml
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws-logging</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws-observability</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">output.conf</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">[OUTPUT]</span>
<span class="w">        </span><span class="no">Name cloudwatch</span>
<span class="w">        </span><span class="no">Match *</span>
<span class="w">        </span><span class="no">region ap-northeast-1</span>
<span class="w">        </span><span class="no">log_group_name fluent-bit-cloudwatch</span>
<span class="w">        </span><span class="no">log_stream_prefix from-fluent-bit-</span>
<span class="w">        </span><span class="no">auto_create_group true</span>
</code></pre></div>
<dl>
<dt><code>(3)</code></dt>
<dd>
<p>FargateワーカーNodeにECRやCloudWatchへの認可スコープを持つポッド実行ロールを付与しておく。</p>
<p>これにより、KubernetesリソースにAWSへの認可スコープが付与され、ServiceAccountやSecretを作成せずとも、PodがECRからコンテナイメージをプルできる様になる。</p>
<p>一方で、Pod内のコンテナには認可スコープが付与されない。</p>
<p>そのため、Podが作成された後に必要な認可スコープ (例：コンテナがRDSにアクセスする認可スコープなど) に関しては、ServiceAccountとIAMロールの紐付けが必要である。</p>
</dd>
</dl>
<blockquote>
<ul>
<li><a href="https://nishipy.com/archives/1122">https://nishipy.com/archives/1122</a></li>
<li><a href="https://toris.io/2021/01/how-kubernetes-pulls-private-container-images-on-aws/">https://toris.io/2021/01/how-kubernetes-pulls-private-container-images-on-aws/</a></li>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-getting-started.html">https://docs.aws.amazon.com/eks/latest/userguide/fargate-getting-started.html</a></li>
<li><a href="https://kumano-te.com/activities/apply-iam-roles-to-eks-service-accounts">https://kumano-te.com/activities/apply-iam-roles-to-eks-service-accounts</a></li>
<li><a href="https://blog.mmmcorp.co.jp/blog/2021/08/11/post-1704/">https://blog.mmmcorp.co.jp/blog/2021/08/11/post-1704/</a></li>
</ul>
</blockquote>
<p><br></p>
<h3 id="fargatenode">FargateワーカーNode<a class="headerlink" href="#fargatenode" title="Permanent link">&para;</a></h3>
<h4 id="fargatenode_1">▼ FargateワーカーNodeとは<a class="headerlink" href="#fargatenode_1" title="Permanent link">&para;</a></h4>
<p><img alt="eks_on_fargate" src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/eks_on_fargate.png" /></p>
<p>Fargate上で稼働するKubernetesのホストのこと。</p>
<p>KubernetesのワーカーNodeに相当する。</p>
<p>EC2ワーカーNodeと比べてカスタマイズ性が低く、ワーカーNode当たりで稼働するPod数はAWSが管理する。</p>
<p>一方で、各EC2のハードウェアリソースの消費量をユーザーが管理しなくてもよいため、Kubernetesのホストの管理が楽である。</p>
<blockquote>
<ul>
<li><a href="https://www.sunnycloud.jp/column/20210315-01/">https://www.sunnycloud.jp/column/20210315-01/</a></li>
</ul>
</blockquote>
<h4 id="fargatenode_2">▼ FargateワーカーNodeを使用できない場合<a class="headerlink" href="#fargatenode_2" title="Permanent link">&para;</a></h4>
<p>以下の場合は、EC2ワーカーNodeを使用するようにする。</p>
<ul>
<li>FargateワーカーNodeでは、DaemonSetが使えない。サイドカーを配置する必要がある。</li>
<li>Fargateで設定可能な最大スペックを超えたスペックが必要である。</li>
<li>emptyDirボリューム以外が必要である。</li>
<li>FargateワーカーNodeでは、サービスメッシュにAppMeshしか使えない。もし、AppMeshを使いたくない場合は、EC2ワーカーNodeを使用する。</li>
</ul>
<blockquote>
<ul>
<li><a href="https://qiita.com/mumoshu/items/c9dea2d82a402b4f9c31#managed-node-group%E3%81%A8eks-on-fargate%E3%81%AE%E4%BD%BF%E3%81%84%E5%88%86%E3%81%91">https://qiita.com/mumoshu/items/c9dea2d82a402b4f9c31#managed-node-group%E3%81%A8eks-on-fargate%E3%81%AE%E4%BD%BF%E3%81%84%E5%88%86%E3%81%91</a></li>
</ul>
</blockquote>
<h4 id="fargate">▼ Fargateプロファイル<a class="headerlink" href="#fargate" title="Permanent link">&para;</a></h4>
<p>Fargateを設定する。</p>
<table>
<thead>
<tr>
<th>コンポーネント名</th>
<th>説明</th>
<th>補足</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pod実行ロール</td>
<td>kubeletがAWSリソースにアクセスできるように、Podにロールを設定する。</td>
<td>・実行ポリシー (<code>AmazonEKSFargatePodExecutionRolePolicy</code>) には、ECRへの認可スコープのみが付与されている。<br>・信頼されたエンティティでは、<code>eks-fargate-pods.amazonaws.com</code>を設定する必要がある。<br>- <a href="https://docs.aws.amazon.com/eks/latest/userguide/pod-execution-role.html">https://docs.aws.amazon.com/eks/latest/userguide/pod-execution-role.html</a></td>
</tr>
<tr>
<td>サブネット</td>
<td>EKS FargateワーカーNodeが起動するサブネットIDを設定する。</td>
<td>プライベートサブネットを設定する必要がある。</td>
</tr>
<tr>
<td>ポッドセレクタ (Namespace)</td>
<td>EKS FargateワーカーNodeにスケジューリングするPodを固定できるように、PodのNamespaceの値を設定する。</td>
<td>・<code>kube-system</code>や<code>default</code>を指定するKubernetesリソースが稼働できるように、ポッドセレクタにこれを追加する必要がある。<br>・IstioやArgoCDを、それ専用のNamespaceで稼働させる場合は、そのNamespaceのためのプロファイルを作成しておく必要がある。</td>
</tr>
<tr>
<td>ポッドセレクタ (Label)</td>
<td>EKS FargateワーカーNodeにスケジューリングするPodを固定できるように、Podの任意のlabelキーの値を設定する。</td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-profile.html#fargate-profile-components">https://docs.aws.amazon.com/eks/latest/userguide/fargate-profile.html#fargate-profile-components</a></li>
</ul>
</blockquote>
<p><br></p>
<h2 id="05-02-node-on-fargate">05-02. Nodeグループ (on-Fargate)<a class="headerlink" href="#05-02-node-on-fargate" title="Permanent link">&para;</a></h2>
<p>記入中...</p>
<p><br></p>
<h2 id="06">06. アップグレード<a class="headerlink" href="#06" title="Permanent link">&para;</a></h2>
<h3 id="_32">アップグレードとは<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>EKS Clusterにて、コントロールプレーンとデータプレーンをローリング方式でアップグレードする。</p>
<p>AWSはIaaSのため、AMIを指定すれば、NodeのOSのアップグレードも実施してくれる。</p>
<p>執筆時点 (2022/01/28) では、AWSのAPIを介して<code>updateConfig</code>値を設定すれば、アップグレード時のサージ数を設定できる。</p>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/managed-node-update-behavior.html">https://docs.aws.amazon.com/eks/latest/userguide/managed-node-update-behavior.html</a></li>
<li><a href="https://docs.aws.amazon.com/eks/latest/APIReference/API_UpdateNodegroupConfig.html#API_UpdateNodegroupConfig_RequestSyntax">https://docs.aws.amazon.com/eks/latest/APIReference/API_UpdateNodegroupConfig.html#API_UpdateNodegroupConfig_RequestSyntax</a></li>
</ul>
</blockquote>
<h3 id="_33">仕組み<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<h4 id="_34">▼ データプレーンの場合<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h4>
<p>EKS Clusterのアップグレード時、以下の仕組みでデータプレーンのワーカーNodeをローリングアップグレードする。</p>
<p>また、Nodeグループに紐づくAutoScalingグループのAZリバランシングの仕組みによって、既存のワーカーNodeと同じAZでワーカーNodeを再作成する。</p>
<dl>
<dt><code>(1)</code></dt>
<dd>
<p>Nodeグループ単位でローリングアップグレードできるように、EKS ClusterのワーカーNode数の設定 (Node希望数、Node最大数) を自動的に増加させる。</p>
</dd>
<dt><code>(2)</code></dt>
<dd>
<p>旧ワーカーNodeを残して、新しいAMIを使用したワーカーNodeを作成する。</p>
<p>旧ワーカーNodeが稼働しているAZで新ワーカーNodeを作成する。</p>
<p>旧ワーカーNodeを残せるのは、あらかじめEKS ClusterのワーカーNode数の設定 (Node希望数、Node最大数) を増加させているためである。</p>
</dd>
<dt><code>(3)</code></dt>
<dd>
<p>各AZで新ワーカーNodeを正しく作成できることを検証する。</p>
</dd>
<dt><code>(4)</code></dt>
<dd>
<p>AZリバランシングが成功すれば、旧ワーカーNodeでDrainが開始され、Podのスケジューリングが無効化される。</p>
</dd>
<dt><code>(5)</code></dt>
<dd>
<p>新ワーカーNode上でPodをスケジューリングし直し、旧ワーカーNodeを削除する。</p>
</dd>
<dt><code>(6)</code></dt>
<dd>
<p>最終的に、アップグレード前のワーカーNode数 (Node希望数) に戻る。</p>
</dd>
</dl>
<blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/managed-node-update-behavior.html">https://docs.aws.amazon.com/eks/latest/userguide/managed-node-update-behavior.html</a></li>
<li><a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/auto-scaling-benefits.html#AutoScalingBehavior.InstanceUsage">https://docs.aws.amazon.com/autoscaling/ec2/userguide/auto-scaling-benefits.html#AutoScalingBehavior.InstanceUsage</a></li>
<li><a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/as-instance-termination.html#common-scenarios-termination-rebalancing">https://docs.aws.amazon.com/autoscaling/ec2/userguide/as-instance-termination.html#common-scenarios-termination-rebalancing</a></li>
</ul>
</blockquote>
<h3 id="_35">手順<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<p>EKS Clusterはおおよそ以下の方法でアップグレードする。</p>
<dl>
<dt><code>(1)</code></dt>
<dd>
<p>コントロールプレーンNodeをアップグレードする。</p>
</dd>
<dt><code>(2)</code></dt>
<dd>
<p>ワーカーNodeをアップグレードする。</p>
<p>コントロールプレーン上のkube-apiserverのバージョンに応じた新しいAMIを使用して、ワーカーNodeを再作成する。</p>
</dd>
<dt><code>(3)</code></dt>
<dd>
<p>ワーカーNode上のAWS EKSアドオン (例：aws-eks-codednsアドオン、aws-eks-kube-proxyアドオン、aws-eks-vpc-cniアドオン、など) をアップグレードする。</p>
</dd>
</dl>
<blockquote>
<ul>
<li><a href="https://inside.dmm.com/entry/2022/08/26/eks_is_hard">https://inside.dmm.com/entry/2022/08/26/eks_is_hard</a></li>
</ul>
</blockquote>
<p><br></p>

  <hr>
<div class="md-source-file">
  <small>
    
      最終更新日:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2023-09-10</span>
      
    
  </small>
</div>


  




                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            ページトップへ戻る
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/hiroki-it" target="_blank" rel="noopener" title="GitHubアカウント" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://twitter.com/Hiroki__IT" target="_blank" rel="noopener" title="Twitterアカウント" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "navigation.indexes", "navigation.prune", "search.suggest", "toc.follow"], "search": "../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "\u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f", "clipboard.copy": "\u30af\u30ea\u30c3\u30d7\u30dc\u30fc\u30c9\u3078\u30b3\u30d4\u30fc", "search.result.more.one": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3082\u30461\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.more.other": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3042\u3068#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.none": "\u4f55\u3082\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f", "search.result.one": "1\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.other": "#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.placeholder": "\u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044", "search.result.term.missing": "\u691c\u7d22\u306b\u542b\u307e\u308c\u306a\u3044", "select.version": "\u30d0\u30fc\u30b8\u30e7\u30f3\u5207\u308a\u66ff\u3048"}}</script>
    
    
      <script src="../assets/javascripts/bundle.dff1b7c8.min.js"></script>
      
    
  </body>
</html>